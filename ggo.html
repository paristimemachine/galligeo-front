<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="node_modules/@gouvfr/dsfr/dist/dsfr.min.css">
    <link rel="stylesheet" href="node_modules/@gouvfr/dsfr/dist/component/form/form.min.css">
    <link rel="stylesheet" href="node_modules/@gouvfr/dsfr/dist/component/segmented/segmented.min.css">

    <link rel="stylesheet" href="node_modules/@gouvfr/dsfr/dist/utility/icons/icons.min.css">

    <meta name="theme-color" content="#000091">

    <!-- <link rel="manifest" href="favicon/manifest.webmanifest" crossorigin="use-credentials"> -->
    <!-- Favicon -->
    <link rel="apple-touch-icon" href="img/favicon.png">
    <link rel="icon" href="img/favicon.png" type="image/png">
    <title>Galligeo</title>

    <!-- Imports -->

    <!-- css -->
    <!-- external -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" crossorigin=""/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw-src.css" />
    <!-- <link rel="stylesheet" href="https://unpkg.com/leaflet-geosearch@3.1.0/dist/geosearch.css"/> -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <link rel="stylesheet" href="https://rawgithub.com/ebrelsford/Leaflet.loading/master/src/Control.Loading.css" />

    <!-- internal -->
    <link rel="stylesheet" href="css/main.css"/>
    <link rel="stylesheet" href="css/map.css"/>

    <!-- js -->
    <!-- external -->
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet-geosearch@3.1.0/dist/bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw-src.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <script src="https://rawgithub.com/ebrelsford/Leaflet.loading/master/src/Control.Loading.js"></script>
    <!-- Leaflet Rotate Plugin -->
    <script src="https://unpkg.com/leaflet-rotate@0.2.8/dist/leaflet-rotate-src.js"></script>

  </head>
  <body>

    <!--  -->
    <!-- HEADER -->
    <!--  -->

    <header role="banner" class="fr-header">
        <div class="fr-header__body">
            <div class="fr-container--fluid">
                <div class="fr-header__body-row">
                    <div class="fr-header__brand fr-enlarge-link" style="margin-left: 24px;">
                        <div class="fr-header__brand-top">
                            <div class="fr-header__logo">
                                <!-- <p< class="fr-logo">
                                    TSE /
                                    <br>IAST
                                </p>> -->
                            </div>
                            <div class="fr-header__operator">
                                <img class="fr-responsive-img" style="width:400px; height:auto;" src="img/galligeo_logo_v3.png" alt="Galligeo" >
                                <!-- L’alternative de l’image (attribut alt) doit impérativement être renseignée et reprendre le texte visible dans l’image -->
                            </div>
                            <div class="fr-header__navbar">
                                <button class="fr-btn--search fr-btn" data-fr-opened="false" aria-controls="modal-575" id="button-576" title="Rechercher">
                                    Rechercher
                                </button>
                                <button class="fr-btn--menu fr-btn" data-fr-opened="false" aria-controls="modal-577" aria-haspopup="menu" id="button-578" title="Menu">
                                    Menu
                                </button>
                                {# <button class="fr-btn fr-icon-star-fill" style="color: yellow;" title="Favoris">
                                    Favoris
                                </button> #}
                            </div>
                        </div>
                        <!-- <div class="fr-header__service">
                            <a href="/" title="Accueil - [À MODIFIER - Nom du site / service] - [À MODIFIER - texte alternatif de l’image : nom de l'opérateur ou du site serviciel] - République Française">
                                <p class="fr-header__service-title">
                                    TSE Data
                                </p>
                            </a>
                            <p class="fr-header__service-tagline">Exploration de données françaises</p>
                        </div> -->
                    </div>
                    <div class="fr-header__tools">
                        <div class="fr-header__tools-links">
                            <ul class="fr-btns-group">
                                <!-- <li>
                                    <a class="fr-btn fr-icon-add-circle-line" href="#" style="color:#ff5555;">
                                        Créer un espace
                                    </a>
                                </li> -->
                                <!--
                                    <li>
                                        <a class="fr-btn fr-icon-lock-line" href="#" style="color:#ff5555;" data-fr-opened="false" aria-controls="fr-modal-login" >
                                            Se connecter
                                        </a>
                                    </li>
                                -->

                                <li>
                                    <button class="fr-btn fr-icon-lock-line" href="#" style="color:#ff5555;"  onclick="window.location.href='https://api.ptm.huma-num.fr/auth/login?redirect_url=https://app.ptm.huma-num.fr/galligeo/ggo.html'">
                                        Se connecter avec ORCID
                                    </button>
                                </li>

                                <!-- <li>
                                    <a class="fr-btn fr-icon-account-line" href="#" style="color:#ff5555;">
                                        S’enregistrer
                                    </a>
                                </li> -->
                            </ul>
                        </div>
                        
                    </div>
                </div>
            </div>
        </div>
        <div class="fr-header__menu fr-modal" id="modal-560" aria-labelledby="button-561" style="display:none ;visibility: hidden;">
            <div class="fr-container">
                <button class="fr-btn--close fr-btn" aria-controls="modal-560" title="Fermer">
                    Fermer
                </button>
                <div class="fr-header__menu-links">
                </div>
                <nav class="fr-nav" id="navigation-564" role="navigation" aria-label="Menu principal">
                    <ul class="fr-nav__list">
                        <li class="fr-nav__item">
                            <a class="fr-nav__link" href="#" target="_self">accès direct</a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <!-- Container principal pour le contenu -->
    <div class="fr-container--fluid main-content-container">

    <!--  -->
    <!-- NAV -->
    <!--  -->
    <nav class="fr-nav" id="header-navigation" role="navigation" aria-label="Menu principal">

        <div class="fr-grid-row main-content-row">

            <!-- side bar -->
            <div class="fr-col-1" id="nav-tools-sidebar-control">

                <!-- button close hidden at startup -->
                <!-- button filter complet -->
                <div class="nav-tools-bar-inner-legend-filter item-hover" id="id-nav-tools-bar-inner-legend-filter" onclick="toggleLegend()">
                   
                    <span class="nav-tools-bar-inner-legend-filter-text">
                        <span>Contrôles</span>
                    </span>
                    <div class="nav-tools-bar-inner-legend-filter-icon2">
                        <img src="node_modules/@gouvfr/dsfr/dist/icons/system/arrow-left-line.svg" alt="arrowslineI127"
                            id="nav-tools-bar-inner-legend-filter-icon2-inner">
                    </div>
                </div>

            </div>

            <!-- search bar -->
            <div class="fr-col-5" id="nav-search-bar">
                    <div class="fr-search-bar autocomplete" id="header-search" role="search">
                        <table border=0>
                            <tr>
                            <td><label class="fr-label" for="search-784-input" onkeydown='load_ark_picture()'>
                                (1) Ark : -> Gallica
                            </label>
                            </td><td>
                                <input class="fr-input" placeholder="Entrer une URL Gallica Ark de type : https://gallica.bnf.fr/ark:/12148/btv1b106799487" type="search" id="search-784-input" name="search-784-input"> <!--list="sites_list"> -->
                                    </td><td>
                                <button class="fr-btn" title="Ark : -> Gallica" onclick='load_ark_picture()'>
                                </button>
                            </td></tr>
                        </table>
                    </div>

            </div>

            <div class="fr-col-6" id="nav-tools4">
                
                <div class="fr-toggle">
                    <input type="checkbox" class="fr-toggle__input" id="toggle" aria-describedby="toggle-messages toggle-hint">
                    <label class="fr-toggle__label" for="toggle" data-fr-checked-label="Verrouillé" data-fr-unchecked-label="Saisie"></label>
                    <!-- <p class="fr-hint-text" id="toggle-hint">Texte de description additionnel</p> -->
                    <div class="fr-messages-group" id="toggle-messages" aria-live="polite">
                    </div>
                </div>
                <fieldset class="fr-segmented fr-segmented--no-legend">
                    <legend class="fr-segmented__legend fr-segmented__legend--inline">
                        Saisir
                        <!-- <span class="fr-hint-text">Description additionnelle</span> -->
                    </legend>
                    <div class="fr-segmented__elements">
                        <div class="fr-segmented__element">
                            <input value="1" checked type="radio" id="segmented-1" name="segmented">
                            <label class="fr-label" for="segmented-1">
                                Points
                            </label>
                        </div>
                        <div class="fr-segmented__element">
                            <input value="2" type="radio" id="segmented-2" name="segmented">
                            <label class="fr-label" for="segmented-2">
                                Emprise
                            </label>
                        </div>
                    </div>
                </fieldset>

                <button class="fr-btn fr-btn--secondary" id="btn_georef" disabled onclick="click_georef('', list_georef_points, list_points_polygon_crop, input_ark)"> 
                    Géoréférencer
                </button>

                <button class="fr-btn fr-btn--secondary" id="btn_display" disabled onclick="display_result(input_ark)">
                    Résultat
                </button>

                <button class="fr-btn fr-btn--secondary" id="btn_deposit" data-fr-opened="false" aria-controls="fr-modal-deposit" disabled>
                    <!--<button class="fr-btn fr-btn--secondary" id="btn_deposit" data-fr-opened="false" aria-controls="fr-modal-deposit"> -->
                    Déposer
                </button>

            </div>
        </div>

    </nav>
    <!--  -->
    <!-- END NAV -->
    <!--  -->

    <!--  -->
    <!-- Modal deposit  -->
    <!--  -->
    <dialog aria-labelledby="fr-modal-deposit" id="fr-modal-deposit" class="fr-modal" role="dialog" >
        <div class="fr-container fr-container--fluid fr-container-md">
            <div class="fr-grid-row fr-grid-row--center">
                <div class="fr-col-12 fr-col-md-8 fr-col-lg-6">
                    <div class="fr-modal__body">
                        <div class="fr-modal__header">
                            <button class="fr-link--close fr-link" aria-controls="fr-modal-deposit"">Fermer</button>
                        </div>
                        <div class="fr-modal__content">
                            <h1 id="fr-modal-2-title" class="fr-modal__title">
                                <span class="fr-fi-arrow-right-line fr-fi--lg"></span>
                                Dépôt de données : choix d'un entrepôt
                            </h1>

                            <div class="fr-checkbox-group fr-checkbox-group--error" id="group-checkbox-nakala">
                                <input aria-describedby="checkbox-nakala" id="checkbox-nakala" type="checkbox" onchange="clkNakalaDepot()">
                                <label class="fr-label" for="checkbox-nakala">
                                  <a href="https://www.nakala.fr/about" target="_blank" rel="noopener">Nakala</a> : entrepôt de données de l'<a href="https://www.huma-num.fr/" target="_blank" rel="noopener">IR* Huma-Num CNRS</a>
                                </label>
                                <div class="fr-messages-group" id="checkbox-nakala-error" aria-live="assertive">
                                    <p class="fr-message fr-message--error" id="checkbox-nakala-message-error">Cocher et entrer une clé d'API</p>
                                </div>
                                <div class="fr-messages-group" id="checkbox-nakala-ok" aria-live="assertive" style="visibility: hidden; display: none;">
                                    <p class="fr-message fr-message--valid" id="checkboxes-valid-message-valid">Ok</p>
                                </div>
                            </div>

                            <label class="fr-label" for="text-input-text">API Key Nakala</label>
                            <input class="fr-input" type="text" id="nakala_api_key" name="text-input-text" value="66c0810c-19c3-5463-5082-20f04d53b971">
                            <label class="fr-label" for="text-input-text">Collection DOI</label>
                            <input class="fr-input" type="text" id="nakala_collection_doi" name="text-input-text" value="10.34847/nkl.febfl1v2">
                            

                            <br>

                            <!--
                            <div class="fr-checkbox-group fr-checkbox-group--error">
                                <input aria-describedby="checkbox-fnp" id="checkbox-fnp" type="checkbox">
                                <label class="fr-label" for="checkbox-fnp">
                                  <a href="https://www.fabriquenumeriquedupasse.fr/" target="_blank" rel="noopener">La Fabrique Numérique du passé</a> : portail de dépôt de données géohistoriques du <a href="https://paris-timemachine.huma-num.fr/" target="_blank" rel="noopener">Consortium Huma-Num PTM</a>
                                </label>
                                <div class="fr-messages-group" id="checkbox-fnp-error" aria-live="assertive">
                                    <p class="fr-message fr-message--error" id="checkbox-fnp-message-error">Cocher et entrer une clé d'API</p>
                                </div>
                            </div>

                            <label class="fr-label" for="text-input-text">API Key FNP</label>
                            <input class="fr-input" type="text" id="text-input-text" name="text-input-text">
                            
                            <br>

                            <div class="fr-checkbox-group fr-checkbox-group--error" id="group-checkbox-geoserverptm">
                                <input aria-describedby="checkbox-geoserverptm" id="checkbox-geoserverptm" type="checkbox" onchange="clkGeoserver()">
                                <label class="fr-label" for="checkbox-geoserverptm">
                                    GeoServer PTM : dépôt sur le géoserveur du CST Huma-Num PTM
                                </label>
                                <div class="fr-messages-group" id="checkbox-geoserverptm-error" aria-live="assertive">
                                    <p class="fr-message fr-message--error" id="checkbox-geoserverptm-message-error">Cocher</p>
                                </div>
                                <div class="fr-messages-group" id="checkbox-geoserverptm-ok" aria-live="assertive" style="visibility: hidden; display: none;">
                                    <p class="fr-message fr-message--valid" id="checkboxes-valid-message-valid">Ok</p>
                                </div>
                            </div>
                            -->

                            <br>

                            <h1 id="fr-modal-2-title" class="fr-modal__title">
                                <span class="fr-fi-arrow-right-line fr-fi--lg"></span>
                                Métadonnées d'enrichissement
                            </h1>

                            <div id="modal-deposit-metadata">
                                <fieldset class="fr-fieldset" aria-label="Demande de nom et prénom" aria-describedby="name-1-fieldset-messages">
                                    <div class="fr-fieldset__element">
                                        <div class="fr-input-group">
                                            <label class="fr-label" for="input-family-name-1">
                                                Nom
                                            </label>
                                            <input class="fr-input" spellcheck="false" autocomplete="family-name" name="family-name" id="input-family-name-1" type="text">
                                        </div>
                                    </div>
                                    <div class="fr-fieldset__element">
                                        <div class="fr-input-group">
                                            <label class="fr-label" for="input-firstname-1">
                                                Prénom
                                            </label>
                                            <input class="fr-input" spellcheck="false" autocomplete="given-name" name="given-name" id="input-firstname-1" type="text">
                                        </div>
                                    </div>
                                    <div class="fr-messages-group" aria-live="assertive" id="name-1-fieldset-messages">
                                    </div>
                                    <div class="fr-fieldset__element">
                                        <div class="fr-input-group">
                                            <label class="fr-label">
                                                Institution / Université / Organisme
                                            </label>
                                            <input class="fr-input" id="input-institution" aria-describedby="input-position-1-messages" name="position" type="text" value="">
                                            <div class="fr-messages-group" id="input-position-1-messages" aria-live="assertive">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="fr-messages-group" id="representative-1661-fieldset-messages" aria-live="assertive">
                                    </div>
                                </fieldset>
                            </div>
                        </div>

                        <div class="fr-modal__footer">
                            <ul class="fr-btns-group fr-btns-group--right fr-btns-group--inline-reverse fr-btns-group--inline-lg fr-btns-group--icon-left">
                                <li>
                                    <button class="fr-btn fr-fi-close-line fr-btn--secondary" aria-controls="fr-modal-deposit" onclick="document.getElementById('fr-modal-deposit').close()">
                                        Annuler
                                    </button>
                                </li>
                                <li>
                                    <button class="fr-btn fr-fi-checkbox-line fr-btn--secondary" onclick="deposerSurNakala(document.getElementById('nakala_api_key').value, document.getElementById('nakala_collection_doi').value)">
                                        Déposer
                                    </button>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </dialog>
    <!--  -->
    <!-- END Modal deposit  -->
    <!--  -->

    <!--  -->
    <!-- Modal Settings DSFR -->
    <dialog class="fr-modal" id="fr-modal-settings" aria-labelledby="fr-modal-settings-title">
        <div class="fr-container fr-container--fluid fr-container-md">
            <div class="fr-grid-row fr-grid-row--center">
                <div class="fr-col-12 fr-col-md-8 fr-col-lg-6">
                    <div class="fr-modal__body">
                        <div class="fr-modal__header">
                            <button class="fr-link--close fr-link" aria-controls="fr-modal-settings">Fermer</button>
                        </div>
                        <div class="fr-modal__content">
                            <h2 id="fr-modal-settings-title" class="fr-modal__title">
                                <span class="fr-icon-account-circle-line fr-icon--lg" aria-hidden="true"></span>
                                Mon Galligeo
                            </h2>

                            <div class="fr-tabs" id="user-tabs">
                                <ul class="fr-tabs__list" role="tablist" aria-label="Navigation espace utilisateur">
                                    <li role="presentation">
                                        <button id="tabpanel-profil" class="fr-tabs__tab" tabindex="0" role="tab" aria-selected="true" aria-controls="tabpanel-profil-panel">Profil utilisateur</button>
                                    </li>
                                    <li role="presentation">
                                        <button id="tabpanel-parametres" class="fr-tabs__tab" tabindex="-1" role="tab" aria-selected="false" aria-controls="tabpanel-parametres-panel">Paramètres géoréférencement</button>
                                    </li>
                                    <li role="presentation">
                                        <button id="tabpanel-cartes" class="fr-tabs__tab" tabindex="-1" role="tab" aria-selected="false" aria-controls="tabpanel-cartes-panel">Mes cartes</button>
                                    </li>
                                </ul>

                                <!-- Panel Profil -->
                                <div id="tabpanel-profil-panel" class="fr-tabs__panel fr-tabs__panel--selected" role="tabpanel" aria-labelledby="tabpanel-profil" tabindex="0">
                                    <section class="fr-container fr-card fr-card--shadow fr-p-4w fr-mb-4w">
                                        <h3 class="fr-h4">Informations utilisateur</h3>
                                        <div class="fr-grid-row fr-grid-row--gutters fr-mt-2w">
                                            <div class="fr-col-3">
                                                <img src="img/users/avatar_neutre.jpg" alt="Photo de profil" class="fr-responsive-img fr-mb-2w" style="border-radius: 50%; max-width: 80%;">
                                            </div>
                                            <div class="fr-col-9">
                                                <div class="user-profile-info">
                                                    <div class="fr-grid-row fr-grid-row--gutters">
                                                        <div class="fr-col-12 fr-col-md-6">
                                                            <div class="info-item">
                                                                <span class="info-label"><strong>Prénom :</strong></span>
                                                                <span class="info-value" id="user-first-name">Chargement...</span>
                                                            </div>
                                                        </div>
                                                        <div class="fr-col-12 fr-col-md-6">
                                                            <div class="info-item">
                                                                <span class="info-label"><strong>Nom :</strong></span>
                                                                <span class="info-value" id="user-last-name">Chargement...</span>
                                                            </div>
                                                        </div>
                                                        <div class="fr-col-12">
                                                            <div class="info-item">
                                                                <span class="info-label"><strong>Email :</strong></span>
                                                                <span class="info-value" id="user-email">Chargement...</span>
                                                            </div>
                                                        </div>
                                                        <div class="fr-col-12">
                                                            <div class="info-item">
                                                                <span class="info-label"><strong>ORCID :</strong></span>
                                                                <span class="info-value" id="user-orcid">Chargement...</span>
                                                            </div>
                                                        </div>
                                                        <div class="fr-col-12">
                                                            <div class="info-item">
                                                                <span class="info-label"><strong>Institution :</strong></span>
                                                                <span class="info-value" id="user-institution">Chargement...</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <p class="fr-mt-2w">Vous pouvez modifier ces informations dans votre 
                                                    <a href="https://api.ptm.huma-num.fr/auth/profile" target="_blank" rel="noopener">
                                                        profil centralisé
                                                    </a>.
                                                </p>
                                            </div>
                                        </div>
                                    </section>
                                </div>

                                <!-- Panel Paramètres -->
                                <div id="tabpanel-parametres-panel" class="fr-tabs__panel" role="tabpanel" aria-labelledby="tabpanel-parametres" tabindex="0">
                                    <section class="fr-container fr-card fr-card--shadow fr-p-4w fr-mb-4w">
                                        <h3 class="fr-h4">Paramètres de géoréférencement</h3>
                                        
                                        <!-- Conteneur pour le formulaire généré dynamiquement -->
                                        <div id="settings-form-container">
                                            <!-- Le formulaire sera généré ici par JavaScript -->
                                            <div class="fr-alert fr-alert--info fr-mb-3w">
                                                <p>Chargement des paramètres...</p>
                                            </div>
                                        </div>
                                        
                                        <!-- Actions supplémentaires -->
                                        <div class="settings-actions">
                                            <button type="button" class="fr-btn fr-btn--secondary" onclick="window.settingsManager.resetSettings()">
                                                <span class="fr-icon-refresh-line" aria-hidden="true"></span>
                                                Réinitialiser
                                            </button>
                                            <button type="button" class="fr-btn fr-btn--secondary" onclick="window.settingsManager.exportSettings()">
                                                <span class="fr-icon-download-line" aria-hidden="true"></span>
                                                Exporter
                                            </button>
                                            <label for="import-settings" class="fr-btn fr-btn--secondary" style="margin: 0; cursor: pointer;">
                                                <span class="fr-icon-upload-line" aria-hidden="true"></span>
                                                Importer
                                                <input type="file" id="import-settings" accept=".json" style="display: none;" 
                                                       onchange="handleSettingsImport(this)">
                                            </label>
                                        </div>
                                        
                                    </section>
                                </div>

                                <!-- Panel Cartes -->
                                <div id="tabpanel-cartes-panel" class="fr-tabs__panel" role="tabpanel" aria-labelledby="tabpanel-cartes" tabindex="0">
                                    <section class="fr-container fr-py-4w">
                                        <h3 class="fr-h4 fr-mb-3w">Vos cartes</h3>

                                        <!-- Section Favoris Cartoquete -->
                                        <div id="cartoquete-favorites-section" style="display:none;">
                                            <h4 class="fr-h5 fr-mb-2w">
                                                <span class="fr-icon-star-fill fr-mr-1w" aria-hidden="true"></span>
                                                Favoris Cartoquete
                                            </h4>
                                            <div class="fr-grid-row fr-grid-row--gutters fr-mb-4w" id="cartoquete-favorites-container">
                                                <!-- Les favoris Cartoquete seront chargés ici dynamiquement -->
                                                <div class="fr-col-12">
                                                    <div class="fr-alert fr-alert--info">
                                                        <p>Chargement des favoris Cartoquete...</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Section Exemples -->
                                        <h4 class="fr-h5 fr-mb-2w">
                                            <span class="fr-icon-map-2-fill fr-mr-1w" aria-hidden="true"></span>
                                            Exemples de cartes géoréférencées
                                        </h4>
                                        <div class="fr-grid-row fr-grid-row--gutters fr-mb-4w">
                                            <!-- Carte 1 -->
                                            <div class="fr-col-md-6 fr-col">
                                                <div class="fr-card">
                                                    <div class="fr-card__body">
                                                        <div class="fr-card__content">
                                                            <h4 class="fr-card__title">
                                                                <a href="#">Paris 1944</a>
                                                            </h4>
                                                            <p class="fr-card__desc">Paris en 1944 - Girard et Barrère - Géographe Editeurs</p>
                                                            <p class="fr-card__desc"><a href="https://gallica.bnf.fr/ark:/12148/btv1b53121232b" target="_blank">Voir la notice Gallica</a></p>
                                                            <p class="fr-card__desc"><a href="https://app.ptm.huma-num.fr/galligeo/georef/?ark=btv1b53121232b" target="_blank">Voir la carte géoréférencée</a></p>
                                                            <div class="fr-card__start">
                                                                <ul class="fr-tags-group">
                                                                    <li><p class="fr-tag">Paris</p></li>
                                                                    <li><p class="fr-tag fr-tag--green-emeraude">XXème s.</p></li>
                                                                </ul>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="fr-card__header">
                                                        <div class="fr-card__img">
                                                            <img class="fr-responsive-img" src="img/georefs/georef_paris1944.jpg" alt="Carte de Paris en 1944" />
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Carte 2 -->
                                            <div class="fr-col-md-6 fr-col">
                                                <div class="fr-card">
                                                    <div class="fr-card__body">
                                                        <div class="fr-card__content">
                                                            <h4 class="fr-card__title">
                                                                <a href="#">Carte des fils télégraphiques</a>
                                                            </h4>
                                                            <p class="fr-card__desc">Carte des fils télégraphiques</p>
                                                            <p class="fr-card__desc"><a href="https://gallica.bnf.fr/ark:/12148/btv1b532480876" target="_blank">Voir la notice Gallica</a></p>
                                                            <p class="fr-card__desc"><a href="https://app.ptm.huma-num.fr/galligeo/georef/?ark=btv1b532480876" target="_blank">Voir la carte géoréférencée</a></p>
                                                            <div class="fr-card__start">
                                                                <ul class="fr-tags-group">
                                                                    <li><p class="fr-tag fr-tag--blue-france">Exemple</p></li>
                                                                    <li><p class="fr-tag fr-tag--green-emeraude">Géoréférencée</p></li>
                                                                </ul>
                                                                <p class="fr-card__detail fr-icon-star-fill">Exemple Galligeo</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="fr-card__header">
                                                        <div class="fr-card__img">
                                                            <img class="fr-responsive-img" src="img/georefs/georef_france_fils_telegraphiques.jpg" alt="Carte des fils télégraphiques" />
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Carte 3 -->
                                            <div class="fr-col-md-6 fr-col">
                                                <div class="fr-card">
                                                    <div class="fr-card__body">
                                                        <div class="fr-card__content">
                                                            <h4 class="fr-card__title">
                                                                <a href="#">Amiens. - Plan de la ville d'Amiens</a>
                                                            </h4>
                                                            <p class="fr-card__desc">Amiens. - Plan de la ville d'Amiens en 1848</p>
                                                            <p class="fr-card__desc"><a href="https://gallica.bnf.fr/ark:/12148/btv1b8441346h" target="_blank">Voir la notice Gallica</a></p>
                                                            <div class="fr-card__start">
                                                                <ul class="fr-tags-group">
                                                                    <li><p class="fr-tag fr-tag--blue-france">Exemple</p></li>
                                                                    <li><p class="fr-tag fr-tag--pink-tuile">A géoréférencer</p></li>
                                                                </ul>
                                                                <p class="fr-card__detail fr-icon-time-line">Exemple Galligeo</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="fr-card__header">
                                                        <div class="fr-card__img">
                                                            <img class="fr-responsive-img" src="img/georefs/georef_amiens1848.jpg" alt="Amiens. - Plan de la ville d'Amiens en 1848" />
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <p class="fr-text--sm fr-mt-2w">
                                            <span id="cartoquete-status-message">Connectez-vous pour voir vos favoris Cartoquete.</span>
                                        </p>
                                    </section>
                                </div>
                            </div>

                            <!-- Footer Modal
                            <div class="fr-modal__footer">
                                <ul class="fr-btns-group fr-btns-group--right fr-btns-group--inline-reverse fr-btns-group--inline-lg fr-btns-group--icon-left">
                                    <li>
                                        <button class="fr-btn fr-icon-close-line fr-btn--secondary" onclick="closeSettingsModal()">
                                            Fermer
                                        </button>
                                    </li>
                                </ul>
                            </div>
                            -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </dialog>
    <!--  -->
    <!-- END Modal Settings  -->
    <!--  -->


    <!--  -->
    <!-- PANEL-->
    <!--  -->
    <div class="fr-container--fluid">
        <div class="fr-grid-row">

            <div class="fr-col-2" id="sidebar">

                <div class="fr-stepper" style="padding-left: 4px; padding-right: 4px;">
                    <h2 class="fr-stepper__title" id="titre-etape-georef">
                        <span class="fr-stepper__state" id="etape-georef">Étape 1 sur 4</span>
                        Charger un lien ark de Gallica
                    </h2>
                    <div class="fr-stepper__steps" id="steps" data-fr-current-step="1" data-fr-steps="4"></div>
                    <p class="fr-stepper__details" id="etape-suite">
                        <span class="fr-text--bold" >Étape suivante :</span> Créer des points de contrôle
                    </p>
                </div>

                <!-- Contrôles de saisie déplacés depuis la navigation -->
                <div class="input-controls-section" style="padding: 8px 4px;">
                    <!-- Statut de saisie -->
                    <div class="fr-notice fr-notice--info" id="input-status-container" style="margin: 8px 0;">
                        <div class="fr-container">
                            <div class="fr-notice__body">
                                <p class="fr-notice__title" id="input-status">
                                    Système de saisie initialisé
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Boutons d'action pour la saisie -->
                    <div class="fr-btns-group fr-btns-group--sm" id="input-actions" style="margin: 8px 0;">
                        <button class="fr-btn fr-btn--tertiary fr-btn--sm" id="btn_clear_points" onclick="clearAllControlPoints()">
                            Effacer pts
                        </button>
                        <button class="fr-btn fr-btn--tertiary fr-btn--sm" id="btn_clear_emprise" onclick="clearEmprise()">
                            Effacer emp.
                        </button>
                    </div>
                </div>

                <section class="fr-accordion" id="table-control-points" hidden>
                    <h3 class="fr-accordion__title">
                        <button class="fr-accordion__btn" aria-expanded="true" aria-controls="div-table-control-points">Points de contrôle</button>
                    </h3>
                    <div class="fr-collapse" id="div-table-control-points" style="padding-right: 4px;">
                        
                        <div class="fr-table fr-table--layout-fixed">
                            <table>
                                <!-- <caption>Résumé du tableau (accessibilité)</caption> -->
                                <thead>
                                    <tr>
                                        <th scope="col">Point source</th>
                                        <th scope="col">Point cible</th>
                                    </tr>
                                </thead>
                                <tbody id='table_body'>
                                    <tr>
                                        <td>Donnée</td>
                                        <td>Donnée</td>
                                    </tr>
                                    <tr>
                                </tbody>
                            </table>
                        </div>

                    </div>
                </section>

            </div>
            
            <div class="fr-col-5" id="map-container-left-at-startup" style="display: flex; visibility: visible">

                    <div class="image_box">
                    <video
                        src="data/galligeo_tuto.webm"
                        type="video/webm"
                        class="image_box-video"
                        autoplay
                        muted
                        loop
                        preload="metadata"
                        >
                        Your browser does not support HTML5 video.
                    </video>
                    </div>

            </div>
            
            <div class="fr-col-5" id="map-container-left">

                <div id="map-left"></div>
            </div>

            <script>
                document.getElementById('map-container-left').style.display = "none"
                document.getElementById('map-container-left').style.visibility = 'hidden';
            </script>

            <div class="fr-col-5" id="map-container-right">

                <div id="map-right"></div>
            </div>

        </div>
        </div>
    
    <!--  -->
    <!-- END MAP -->
    <!--  -->

    </div>
    <!-- END Container principal -->

    <!--  -->
    <!-- FOOTER -->
    <!--  -->
    <footer class="footer">
        <p>Made with
            <svg class="heart-icon" aria-hidden="true" focusable="false" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                <path fill="currentColor" d="M462.3 62.6C407.5 15.9 326 24.3 275.7 76.2L256 96.5l-19.7-20.3C186.1 24.3 104.5 15.9 49.7 62.6c-62.8 53.6-66.1 149.8-9.9 207.9l193.5 199.8c12.5 12.9 32.8 12.9 45.3 0l193.5-199.8c56.3-58.1 53-154.3-9.8-207.9z">
                </path>
            </svg>
           by <a href="https://ptm.huma-num.fr/" target="_blank">PTM</a>
           &nbsp;— <a href="https://github.com/" target="_blank">Code &amp; Documentation</a>
           &nbsp;—
           <span id="app-version-info" class="version-info" style="opacity: 0.7; font-size: 0.85em; color: #666;">
               <span id="version-display">Chargement...</span>
               <span id="version-details" style="display: none;">
                   <span id="version-build"></span>
                   <span id="version-commit"></span>
                   <span id="version-date"></span>
               </span>
           </span>
        </p>
      </footer>
    <!--  -->
    <!-- END FOOTER -->
    <!--  -->


    <!--  -->
    <!-- Modal Login-->
    <!--  -->

    <!-- Change the link to the login page
    <dialog aria-labelledby="fr-modal-login" id="fr-modal-login" class="fr-modal" role="dialog" >
        <div class="fr-container fr-container--fluid fr-container-md">
            <div class="fr-grid-row fr-grid-row--center">
                <div class="fr-col-12 fr-col-md-8 fr-col-lg-6">
                    <div class="fr-modal__body">
                        <div class="fr-modal__header">
                            <button class="fr-link--close fr-link" aria-controls="fr-modal-login">Fermer</button>
                        </div>
                        <div class="fr-modal__content">
                            <h1 id="fr-modal-2-title" class="fr-modal__title">
                                <span class="fr-fi-arrow-right-line fr-fi--lg"></span>
                                Connexion à Galligeo
                            </h1>
                            
                            <form id="login-1760">
                                <fieldset class="fr-fieldset" id="login-1760-fieldset" aria-labelledby="login-1760-fieldset-legend login-1760-fieldset-messages">
                                    <legend class="fr-fieldset__legend" id="login-1760-fieldset-legend">
                                        <h2>Se connecter avec son compte</h2>
                                    </legend>
                                    <div class="fr-fieldset__element">
                                        <p class="fr-text--sm">Fonctionnalité non disponible à l'heure actuelle</p>
                                    </div>
                                    <div class="fr-fieldset__element">
                                        <fieldset class="fr-fieldset" id="credentials" aria-labelledby="credentials-messages">
                                            <div class="fr-fieldset__element">
                                                <span class="fr-hint-text">Sauf mention contraire, tous les champs sont obligatoires.</span>
                                            </div>
                                            <div class="fr-fieldset__element">
                                                <div class="fr-input-group">
                                                    <label class="fr-label" for="username-1757">
                                                        Identifiant
                                                        <span class="fr-hint-text">Format attendu : nom@domaine.fr</span>
                                                    </label>
                                                    <input class="fr-input" autocomplete="username" aria-required="true" aria-describedby="username-1757-messages" name="username" id="username-1757" type="text" value="user_test">
                                                    <div class="fr-messages-group" id="username-1757-messages" aria-live="assertive">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="fr-fieldset__element">
                                                <div class="fr-password" id="password-1758">
                                                    <label class="fr-label" for="password-1758-input">
                                                        Mot de passe
                                                    </label>
                                                    <div class="fr-input-wrap">
                                                        <input class="fr-password__input fr-input" aria-describedby="password-1758-input-messages" aria-required="true" name="password" autocomplete="current-password" id="password-1758-input" type="password" value="password">
                                                    </div>
                                                    <div class="fr-messages-group" id="password-1758-input-messages" aria-live="assertive">
                                                    </div>
                                                    <div class="fr-password__checkbox fr-checkbox-group fr-checkbox-group--sm">
                                                        <input aria-label="Afficher le mot de passe" id="password-1758-show" type="checkbox" aria-describedby="password-1758-show-messages">
                                                        <label class="fr-password__checkbox fr-label" for="password-1758-show">
                                                            Afficher
                                                        </label>
                                                        <div class="fr-messages-group" id="password-1758-show-messages" aria-live="assertive">
                                                        </div>
                                                    </div>
                                                    <p>
                                                      <a href="#" class="fr-link" target="_blank" rel="noopener">Mot de passe oublié ?</a> 
                                                      
                                                    </p>
                                                </div>
                                            </div>
                                            <div class="fr-messages-group" id="credentials-messages" aria-live="assertive">
                                            </div>
                                        </fieldset>
                                    </div>
                                    <div class="fr-fieldset__element">
                                        <div class="fr-checkbox-group fr-checkbox-group--sm">
                                            <input name="remember" id="remember-1759" type="checkbox" aria-describedby="remember-1759-messages">
                                            <label class="fr-label" for="remember-1759">
                                                Se souvenir de moi
                                            </label>
                                            <div class="fr-messages-group" id="remember-1759-messages" aria-live="assertive">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="fr-fieldset__element">
                                        <ul class="fr-btns-group">
                                            <li>
                                                reactiver se connecter dsfr -->
                                                <!--  <button class="fr-mt-2v fr-btn" href="login.html">
                                                <button class="fr-btn" id="login-button-redirect">
                                                    Se connecter
                                                </button>
                                            </li>
                                        </ul>
                                    </div>
                                    <div class="fr-messages-group" id="login-1760-fieldset-messages" aria-live="assertive">
                                    </div>
                                </fieldset>
                            </form>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </dialog>
    -->
    <!-- END Modal login  -->
    <!--  -->

    <!-- Script en version es6 module et nomodule pour les navigateurs le ne supportant pas -->
    <script type="module" src="node_modules/@gouvfr/dsfr/dist/dsfr.module.min.js"></script>
    <script type="text/javascript" nomodule src="node_modules/@gouvfr/dsfr/dist/dsfr.nomodule.min.js"></script>
    <!-- internal -->
    <script src="js/version.js"></script>
    <script src="js/clonelayers.js"></script>
    <script src="js/init.js"></script>
    <!-- <script src="js/simple-layout.js"></script> -->
    <script src="js/advanced-input-system.js"></script>
    <script src="js/map_interactions.js"></script>
    <script src="js/front_interactions.js"></script>
    <script src="js/api_interactions.js"></script>
    <script src="js/gallica_interactions.js"></script>
    <script src="js/getParamAtStartup.js"></script>
    <script src="js/nakala_test_deposit.js"></script>
    <script src="js/ptm-auth.js"></script>
    <script src="js/form-generator.js"></script>
    <script src="js/settings-manager.js"></script>
    <script src="js/settings-utils.js"></script>
    <script src="js/cartoquete-manager.js"></script>

    <script>
    // Variable globale pour suivre l'état d'initialisation
    let settingsFormInitialized = false;

    // Fonction pour gérer l'importation de paramètres
    function handleSettingsImport(input) {
        const file = input.files[0];
        if (file) {
            window.settingsManager.importSettings(file);
            input.value = ''; // Reset l'input
        }
    }

    // Fonction pour initialiser le formulaire de paramètres
    async function initSettingsForm() {
        if (settingsFormInitialized) {
            return; // Déjà initialisé
        }

        try {
            await window.settingsManager.init('settings-form-container');
            settingsFormInitialized = true;
            console.log('Formulaire de paramètres initialisé avec succès');
        } catch (error) {
            console.error('Erreur lors de l\'initialisation du formulaire de paramètres:', error);
            
            // Afficher un message d'erreur à l'utilisateur
            const container = document.getElementById('settings-form-container');
            if (container) {
                container.innerHTML = `
                    <div class="fr-alert fr-alert--error">
                        <p><strong>Erreur de chargement</strong></p>
                        <p>Impossible de charger la configuration des paramètres. Veuillez rafraîchir la page.</p>
                        <button class="fr-btn fr-btn--sm fr-mt-2w" onclick="location.reload()">
                            Rafraîchir la page
                        </button>
                    </div>
                `;
            }
        }
    }

    // Observer pour détecter l'ouverture de la modale des paramètres
    function setupModalObserver() {
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                const modal = document.getElementById('fr-modal-settings');
                if (modal && modal.open && !settingsFormInitialized) {
                    // La modale est ouverte et le formulaire n'est pas encore initialisé
                    initSettingsForm();
                }
            });
        });

        // Observer les changements sur la modale
        const modal = document.getElementById('fr-modal-settings');
        if (modal) {
            observer.observe(modal, { 
                attributes: true, 
                attributeFilter: ['open'] 
            });
        }

        // Observer aussi les clics sur l'onglet paramètres
        const parametresTab = document.getElementById('tabpanel-parametres');
        if (parametresTab) {
            parametresTab.addEventListener('click', function() {
                // Petite temporisation pour laisser l'onglet s'afficher
                setTimeout(initSettingsForm, 100);
            });
        }

        // Observer les clics sur l'onglet "Mes cartes" pour charger les favoris
        const cartesTab = document.getElementById('tabpanel-cartes');
        if (cartesTab) {
            cartesTab.addEventListener('click', function() {
                // Charger les favoris Cartoquete si l'utilisateur est connecté
                if (window.ptmAuth && window.ptmAuth.isAuthenticated()) {
                    setTimeout(loadCartoqueteFavorites, 100);
                }
            });
        }
    }

    // Écouter les changements de paramètres pour mettre à jour l'application
    function setupSettingsListener() {
        document.addEventListener('settingsUpdated', function(event) {
            const settings = event.detail.settings;
            console.log('Paramètres mis à jour:', settings);
            
            // Ici vous pouvez ajouter la logique pour appliquer les nouveaux paramètres
            // Par exemple:
            
            // Mettre à jour l'algorithme de géoréférencement par défaut
            if (settings['select-algo']) {
                console.log('Nouvel algorithme par défaut:', settings['select-algo']);
                // TODO: Appliquer l'algorithme dans votre logique de géoréférencement
            }
            
            // Mettre à jour la méthode de rééchantillonage
            if (settings['select-resample']) {
                console.log('Nouvelle méthode de rééchantillonage:', settings['select-resample']);
                // TODO: Appliquer la méthode dans votre logique
            }
            
            // Mettre à jour la qualité des images Gallica
            if (settings['select-quality']) {
                console.log('Nouvelle qualité image:', settings['select-quality']);
                // TODO: Appliquer la qualité dans vos appels API Gallica
            }
            
            // Gérer les options de compression, transparence, etc.
            if (settings['checkbox-compression']) {
                console.log('Compression activée:', settings['checkbox-compression']);
            }
            
            if (settings['checkbox-transparent']) {
                console.log('Transparence activée:', settings['checkbox-transparent']);
            }
            
            if (settings['checkbox-matrice']) {
                console.log('Sauvegarde matrice activée:', settings['checkbox-matrice']);
            }
            
            if (settings['input-scale']) {
                console.log('Échelle de démarrage:', settings['input-scale']);
            }
            
            // Afficher une notification de succès
            showNotification('Paramètres mis à jour avec succès', 'success');
        });

        // Écouter les événements de chargement de paramètres
        document.addEventListener('settingsLoaded', function(event) {
            const { settings, source } = event.detail;
            console.log(`Paramètres chargés depuis ${source}:`, settings);
            
            let message = '';
            switch(source) {
                case 'cloud':
                    message = 'Paramètres chargés depuis le serveur';
                    break;
                case 'cloud-reconnect':
                    message = 'Paramètres synchronisés après connexion';
                    break;
                case 'local':
                    message = 'Paramètres locaux chargés';
                    break;
                case 'default':
                    message = 'Paramètres par défaut appliqués';
                    break;
                default:
                    message = 'Paramètres chargés';
            }
            
            if (source === 'cloud' || source === 'cloud-reconnect') {
                showNotification(message, 'success');
            }
        });
    }

    // Fonction utilitaire pour afficher des notifications
    function showNotification(message, type = 'info') {
        // Créer une notification DSFR temporaire
        const notification = document.createElement('div');
        notification.className = `fr-notice fr-notice--${type === 'success' ? 'info' : type}`;
        notification.innerHTML = `
            <div class="fr-container">
                <div class="fr-notice__body">
                    <p class="fr-notice__title">${message}</p>
                </div>
            </div>
        `;
        
        // Ajouter la notification en haut de la page
        document.body.insertBefore(notification, document.body.firstChild);
        
        // Supprimer après 3 secondes
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 3000);
    }

    // Fonction pour récupérer un paramètre (utilitaire pour le reste de l'application)
    function getAppSetting(key, defaultValue = null) {
        if (window.settingsManager) {
            return window.settingsManager.getSetting(key, defaultValue);
        }
        return defaultValue;
    }

    // Rendre la fonction disponible globalement
    window.getAppSetting = getAppSetting;

    document.addEventListener('DOMContentLoaded', async () => {
        // Vérifier si l'utilisateur revient d'une authentification (token dans l'URL)
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token') || urlParams.get('access_token');
        
        if (token) {
            console.log('Token détecté dans l\'URL, configuration de l\'authentification...');
            window.ptmAuth.setToken(token);
            
            // Nettoyer l'URL
            window.history.replaceState({}, document.title, window.location.pathname);
            
            // Charger les paramètres utilisateur automatiquement
            if (window.settingsManager) {
                await window.settingsManager.reloadSettingsAfterLogin();
            }
        }
        
        // Vérifier l'état d'authentification au chargement de la page
        try {
            const isAuthenticated = await window.ptmAuth.checkAuthStatus();
            
            if (isAuthenticated) {
                console.log('Utilisateur authentifié');
                // Mettre à jour l'interface utilisateur pour afficher les informations de connexion
                await updateUIForAuthenticatedUser();
                
                // Charger automatiquement les paramètres depuis le serveur (si pas déjà fait)
                if (window.settingsManager && !token) {
                    await window.settingsManager.reloadSettingsAfterLogin();
                }
                
                // Mettre à jour l'état des boutons pour un utilisateur connecté
                if (typeof updateButtonsForAuth === 'function') {
                    updateButtonsForAuth();
                }
            } else {
                console.log('Utilisateur non authentifié');
                
                // Mettre à jour l'état des boutons pour un utilisateur non connecté
                if (typeof updateButtonsForAuth === 'function') {
                    updateButtonsForAuth();
                }
            }
        } catch (error) {
            console.error('Erreur lors de la vérification de l\'authentification:', error);
            console.log('Utilisateur considéré comme non authentifié');
            
            // Mettre à jour l'état des boutons pour un utilisateur non connecté
            if (typeof updateButtonsForAuth === 'function') {
                updateButtonsForAuth();
            }
        }
        
        // Vérifier l'état d'authentification avec l'ancienne fonction si elle existe
        if (typeof checkAuthStatus === 'function') {
            checkAuthStatus();
        }
        
        // Configurer l'observateur de modale et les listeners
        setupModalObserver();
        setupSettingsListener();
        
        const loginButton = document.getElementById('login-button-redirect');
        if (loginButton) {
            loginButton.addEventListener('click', (e) => {
                e.preventDefault(); // empêche un submit par défaut
                // Optionnel : fermer la modale proprement avant de rediriger
                const modal = document.getElementById('fr-modal-login');
                if (modal && typeof modal.close === 'function') {
                    modal.close();
                }
                // Redirection
                window.location.href = 'login.html';
            });
        }
    });

    // Fonction pour mettre à jour l'UI quand l'utilisateur est connecté
    async function updateUIForAuthenticatedUser() {
        try {
            const userProfile = await window.ptmAuth.getUserProfile();
            
            // Mettre à jour le menu utilisateur si il existe
            updateUserMenu(userProfile);
            
            // Mettre à jour les informations de profil dans la modale
            updateProfileInfo(userProfile);
            
            // Charger les favoris Cartoquete
            await loadCartoqueteFavorites();
            
        } catch (error) {
            console.error('Erreur lors de la mise à jour de l\'interface utilisateur:', error);
        }
    }

    // Fonction pour charger les favoris Cartoquete
    async function loadCartoqueteFavorites() {
        try {
            console.log('Chargement des favoris Cartoquete...');
            
            // Afficher la section des favoris
            const favoritesSection = document.getElementById('cartoquete-favorites-section');
            const statusMessage = document.getElementById('cartoquete-status-message');
            
            if (favoritesSection) {
                favoritesSection.style.display = 'block';
            }
            
            if (statusMessage) {
                statusMessage.textContent = 'Chargement des favoris Cartoquete...';
            }
            
            // Charger et afficher les favoris
            await window.cartoqueteManager.displayFavorites();
            
            // Mettre à jour le message de statut
            const favorites = window.cartoqueteManager.favorites;
            if (statusMessage) {
                if (favorites && favorites.length > 0) {
                    statusMessage.innerHTML = `Vous avez <strong>${favorites.length} favori(s) Cartoquete</strong>. Les exemples de cartes ci-dessous sont fournis à titre illustratif.`;
                } else {
                    statusMessage.innerHTML = 'Aucun favori Cartoquete trouvé. Ajoutez des cartes à vos favoris sur <strong>Cartoquete</strong> pour les voir apparaître ici.';
                }
            }
            
        } catch (error) {
            console.error('Erreur lors du chargement des favoris Cartoquete:', error);
            
            const statusMessage = document.getElementById('cartoquete-status-message');
            if (statusMessage) {
                statusMessage.innerHTML = 'Erreur lors du chargement des favoris Cartoquete.';
            }
        }
    }

    // Fonction pour mettre à jour le menu utilisateur
    function updateUserMenu(userProfile) {
        // Remplacer le bouton de connexion par un menu utilisateur
        const loginButton = document.querySelector('button[onclick*="auth/login"]');
        if (loginButton) {
            const userMenuHtml = `
                <div class="user-menu-container">
                    <button class="fr-btn fr-icon-account-circle-line user-menu-toggle" 
                            data-fr-opened="false" 
                            aria-controls="fr-modal-settings"
                            onclick="document.getElementById('fr-modal-settings').showModal()">
                        ${userProfile.first_name} ${userProfile.last_name}
                    </button>
                </div>
            `;
            loginButton.parentElement.innerHTML = userMenuHtml;
        }
    }

    // Fonction pour mettre à jour les informations de profil
    function updateProfileInfo(userProfile) {
        const fields = {
            'user-first-name': userProfile.first_name,
            'user-last-name': userProfile.last_name,
            'user-email': userProfile.email,
            'user-orcid': userProfile.orcid_id,
            'user-institution': userProfile.institution || 'Non renseigné'
        };

        Object.entries(fields).forEach(([id, value]) => {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = value || 'Non renseigné';
            }
        });
    }

    // Fonction pour gérer l'état des boutons segmentés selon le toggle
    function toggleSegmentedButtons() {
        const toggleInput = document.getElementById('toggle');
        const segmentedElements = document.querySelectorAll('.fr-segmented__element input, .fr-segmented__element label');
        const fieldset = document.querySelector('.fr-segmented');
        
        if (toggleInput.checked) {
            // Toggle activé (Verrouillé) - désactiver les boutons segmentés
            segmentedElements.forEach(element => {
                if (element.tagName === 'INPUT') {
                    element.disabled = true;
                } else if (element.tagName === 'LABEL') {
                    element.style.opacity = '0.5';
                    element.style.cursor = 'not-allowed';
                }
            });
            fieldset.style.opacity = '0.5';
        } else {
            // Toggle désactivé (Saisie) - activer les boutons segmentés
            segmentedElements.forEach(element => {
                if (element.tagName === 'INPUT') {
                    element.disabled = false;
                } else if (element.tagName === 'LABEL') {
                    element.style.opacity = '1';
                    element.style.cursor = 'pointer';
                }
            });
            fieldset.style.opacity = '1';
        }
    }

    // Initialiser l'état des boutons segmentés au chargement de la page
    function initializeSegmentedButtonsState() {
        const toggleInput = document.getElementById('toggle');
        
        // Écouter les changements du toggle
        toggleInput.addEventListener('change', toggleSegmentedButtons);
        
        // Définir l'état initial (toggle désactivé par défaut = boutons activés)
        toggleSegmentedButtons();
        
        // Attendre que le système de saisie soit prêt
        if (typeof setupAdvancedInputSystem === 'function') {
            // Le système est déjà initialisé dans map_interactions.js
            console.log('Système de saisie avancé disponible');
        }
    }
    </script>

    <script>
        // Initialiser l'état des boutons segmentés dès que le DOM est chargé
        document.addEventListener('DOMContentLoaded', function() {
            initializeSegmentedButtonsState();
            
            // Initialiser l'affichage de version
            initializeVersionDisplay();
            
            // Ajouter des messages d'aide contextuelle
            addInputHelpMessages();
        });
        
        // Fonction pour ajouter des messages d'aide
        function addInputHelpMessages() {
            const statusContainer = document.getElementById('input-status-container');
            if (statusContainer) {
                const helpDiv = document.createElement('div');
                helpDiv.className = 'input-help-message';
                helpDiv.id = 'input-help';
                helpDiv.textContent = 'Activez la saisie et sélectionnez le mode pour commencer';
                statusContainer.appendChild(helpDiv);
            }
        }
        
        // Fonction pour initialiser l'affichage de version dans le footer
        function initializeVersionDisplay() {
            const versionDisplay = document.getElementById('version-display');
            const versionDetails = document.getElementById('version-details');
            const versionBuild = document.getElementById('version-build');
            const versionCommit = document.getElementById('version-commit');
            const versionDate = document.getElementById('version-date');
            
            if (!versionDisplay) return;
            
            // Attendre que les informations de version soient disponibles
            function updateVersionInfo() {
                if (window.APP_VERSION) {
                    const version = window.APP_VERSION;
                    
                    // Version simple pour l'affichage normal
                    versionDisplay.textContent = version.shortDisplayVersion;
                    versionDisplay.style.cursor = 'pointer';
                    versionDisplay.title = 'Cliquer pour plus d\'informations';
                    
                    // Détails pour l'affichage étendu
                    if (versionBuild) {
                        versionBuild.textContent = ` • Build ${version.buildNumber}`;
                    }
                    if (versionCommit) {
                        versionCommit.textContent = ` • ${version.git.hash}`;
                    }
                    if (versionDate) {
                        const buildDate = new Date(version.build.timestamp);
                        versionDate.textContent = ` • ${buildDate.toLocaleDateString('fr-FR')}`;
                    }
                    
                    // Ajouter l'interaction pour afficher/masquer les détails
                    let detailsVisible = false;
                    versionDisplay.addEventListener('click', function() {
                        detailsVisible = !detailsVisible;
                        
                        if (detailsVisible) {
                            versionDisplay.textContent = version.displayVersion;
                            if (versionDetails) versionDetails.style.display = 'inline';
                            versionDisplay.title = 'Cliquer pour réduire';
                        } else {
                            versionDisplay.textContent = version.shortDisplayVersion;
                            if (versionDetails) versionDetails.style.display = 'none';
                            versionDisplay.title = 'Cliquer pour plus d\'informations';
                        }
                    });
                    
                    // Double-clic pour afficher toutes les informations dans la console
                    versionDisplay.addEventListener('dblclick', function() {
                        if (window.showVersionInfo) {
                            window.showVersionInfo();
                        }
                    });
                    
                } else {
                    // Réessayer dans 100ms si les informations ne sont pas encore disponibles
                    setTimeout(updateVersionInfo, 100);
                }
            }
            
            updateVersionInfo();
        }
    </script>

  </body>
</html>