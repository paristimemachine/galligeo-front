<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interface de Tests Galligeo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .test-container { max-width: 1400px; margin: 20px auto; }
        .app-frame { width: 100%; height: 600px; border: 2px solid #dee2e6; border-radius: 8px; }
        .test-results { background-color: #212529; color: #fff; font-family: monospace; font-size: 0.85em; max-height: 400px; overflow-y: auto; padding: 15px; }
        .status-passed { color: #28a745; }
        .status-failed { color: #dc3545; }
        .status-running { color: #17a2b8; }
        .status-pending { color: #ffc107; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="test-container">
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body text-center">
                            <h1 class="card-title">üß™ Interface de Tests Galligeo</h1>
                            <p class="card-text">Tests avec application int√©gr√©e</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Application Galligeo -->
                <div class="col-8">
                    <div class="card">
                        <div class="card-header">
                            <h5>üì± Application Galligeo</h5>
                        </div>
                        <div class="card-body p-0">
                            <iframe id="galligeoApp" src="../index.html" class="app-frame"></iframe>
                        </div>
                    </div>
                </div>

                <!-- Panneau de Tests -->
                <div class="col-4">
                    <div class="card">
                        <div class="card-header">
                            <h5>üß™ Tests</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <button class="btn btn-primary w-100 mb-2" onclick="runFrontendTests()">
                                    üé® Tests Frontend
                                </button>
                                <button class="btn btn-secondary w-100 mb-2" onclick="runAuthTests()">
                                    üîê Tests Authentification
                                </button>
                                <button class="btn btn-info w-100 mb-2" onclick="runSettingsTests()">
                                    ‚öôÔ∏è Tests Param√®tres
                                </button>
                                <button class="btn btn-warning w-100" onclick="clearResults()">
                                    üóëÔ∏è Effacer
                                </button>
                            </div>
                            
                            <div class="progress mb-3" style="display: none;" id="progressBar">
                                <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h6>üìã R√©sultats</h6>
                        </div>
                        <div class="card-body p-0">
                            <div id="testResults" class="test-results">
                                Pr√™t pour les tests...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="config/test-config.js"></script>
    <script src="config/test-utils.js"></script>
    
    <script>
        let testResults = [];
        let currentTestIndex = 0;
        let totalTests = 0;

        // Utilitaires de logging
        function log(level, message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            const resultsDiv = document.getElementById('testResults');
            const statusClass = level === 'error' ? 'status-failed' : 
                               level === 'success' ? 'status-passed' :
                               level === 'info' ? 'status-running' : 'status-pending';
            
            const logEntry = `<div class="${statusClass}">[${timestamp}] ${message}</div>`;
            resultsDiv.innerHTML += logEntry;
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
            
            if (data) {
                console.log(message, data);
            }
        }

        function clearResults() {
            document.getElementById('testResults').innerHTML = 'R√©sultats effac√©s...';
            testResults = [];
        }

        // Acc√®s √† l'iframe de l'application
        function getAppWindow() {
            const iframe = document.getElementById('galligeoApp');
            if (!iframe) return null;
            
            try {
                return iframe.contentWindow;
            } catch (e) {
                console.warn('Acc√®s √† l\'iframe bloqu√© (cross-origin):', e);
                return null;
            }
        }

        function getAppDocument() {
            const iframe = document.getElementById('galligeoApp');
            if (!iframe) return null;
            
            try {
                return iframe.contentDocument;
            } catch (e) {
                console.warn('Acc√®s au document iframe bloqu√© (cross-origin):', e);
                return null;
            }
        }

        // V√©rifier si l'iframe a √©t√© redirig√©e
        function checkIframeStatus() {
            const iframe = document.getElementById('galligeoApp');
            if (!iframe) return 'no-iframe';
            
            try {
                const doc = iframe.contentDocument;
                if (!doc) return 'no-access';
                
                const url = doc.location.href;
                if (url.includes('orcid.org') || url.includes('auth') || url.includes('login')) {
                    return 'redirected';
                }
                
                if (doc.title && doc.title.includes('Galligeo')) {
                    return 'loaded';
                }
                
                return 'loading';
            } catch (e) {
                return 'cross-origin';
            }
        }

        // Attendre que l'application soit charg√©e
        function waitForAppLoad() {
            return new Promise((resolve) => {
                const iframe = document.getElementById('galligeoApp');
                
                const checkStatus = () => {
                    const status = checkIframeStatus();
                    log('info', `√âtat iframe: ${status}`);
                    
                    if (status === 'loaded') {
                        log('success', '‚úÖ Application charg√©e avec succ√®s');
                        setTimeout(resolve, 1000);
                    } else if (status === 'redirected' || status === 'cross-origin') {
                        log('error', '‚ùå Application redirig√©e vers authentification');
                        log('info', 'üí° Suggestion: Ouvrez l\'application dans un nouvel onglet pour √©viter la redirection');
                        
                        // Proposer une solution alternative
                        const resultsDiv = document.getElementById('testResults');
                        resultsDiv.innerHTML += `
                            <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; margin: 10px 0; border-radius: 5px;">
                                <h5>üîÑ Solution alternative</h5>
                                <p>L'application a √©t√© redirig√©e vers l'authentification ORCID.</p>
                                <button onclick="openAppInNewTab()" style="background: #007bff; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer;">
                                    üöÄ Ouvrir l'application dans un nouvel onglet
                                </button>
                                <br><br>
                                <small><strong>Instructions:</strong> 
                                1. Cliquez le bouton ci-dessus<br>
                                2. Fermez la popup d'authentification si elle appara√Æt<br>
                                3. Revenez √† cet onglet<br>
                                4. Relancez les tests
                                </small>
                            </div>
                        `;
                        resolve();
                    } else {
                        // R√©essayer apr√®s un d√©lai
                        setTimeout(checkStatus, 1000);
                    }
                };
                
                iframe.onload = checkStatus;
                // D√©marrer la v√©rification imm√©diatement aussi
                setTimeout(checkStatus, 500);
            });
        }

        // Ouvrir l'application dans un nouvel onglet
        function openAppInNewTab() {
            const newWindow = window.open('../index.html', 'galligeoApp', 'width=1200,height=800');
            if (newWindow) {
                log('info', 'üöÄ Application ouverte dans un nouvel onglet');
                log('info', 'üí° Fermez la popup d\'authentification et revenez ici pour les tests');
            } else {
                log('error', '‚ùå Impossible d\'ouvrir un nouvel onglet (popup bloqu√©)');
            }
        }

        // Tests Frontend
        async function runFrontendTests() {
            log('info', 'üé® D√©but des tests frontend...');
            
            try {
                await waitForAppLoad();
                const appWindow = getAppWindow();
                const appDoc = getAppDocument();
                
                const status = checkIframeStatus();
                if (status !== 'loaded') {
                    log('error', '‚ùå Application non accessible pour les tests');
                    log('info', 'üí° Utilisez la solution alternative propos√©e ci-dessus');
                    return;
                }
                
                // Test 1: Chargement de la page
                log('info', 'Test: Chargement de la page');
                if (appDoc && appDoc.readyState === 'complete') {
                    log('success', '‚úÖ Page charg√©e');
                } else {
                    log('error', '‚ùå Page non charg√©e');
                }

                // Test 2: Pr√©sence des √©l√©ments critiques
                const selectors = window.GALLIGEO_TEST_CONFIG.SELECTORS;
                
                log('info', 'Test: Pr√©sence des √©l√©ments UI');
                const arkInput = appDoc.querySelector(selectors.arkInput);
                if (arkInput) {
                    log('success', '‚úÖ Champ ARK trouv√©');
                } else {
                    log('error', '‚ùå Champ ARK introuvable');
                }

                const loadButton = appDoc.querySelector(selectors.loadButton);
                if (loadButton) {
                    log('success', '‚úÖ Bouton de chargement trouv√©');
                } else {
                    log('error', '‚ùå Bouton de chargement introuvable');
                }

                const georefButton = appDoc.querySelector(selectors.georefButton);
                if (georefButton) {
                    log('success', '‚úÖ Bouton g√©or√©f√©rencement trouv√©');
                } else {
                    log('error', '‚ùå Bouton g√©or√©f√©rencement introuvable');
                }

                // Test 3: Leaflet Maps
                log('info', 'Test: Initialisation des cartes');
                if (appWindow.L) {
                    log('success', '‚úÖ Leaflet disponible');
                } else {
                    log('error', '‚ùå Leaflet indisponible');
                }

                log('success', 'üé® Tests frontend termin√©s');
                
            } catch (error) {
                log('error', '‚ùå Erreur dans les tests frontend: ' + error.message);
            }
        }

        // Tests Authentification
        async function runAuthTests() {
            log('info', 'üîê D√©but des tests authentification...');
            
            try {
                await waitForAppLoad();
                const appWindow = getAppWindow();
                
                // Test 1: Classe PTMAuth
                log('info', 'Test: Disponibilit√© de PTMAuth');
                if (appWindow.PTMAuth) {
                    log('success', '‚úÖ Classe PTMAuth disponible');
                } else {
                    log('error', '‚ùå Classe PTMAuth indisponible');
                }

                // Test 2: Instance auth
                log('info', 'Test: Instance auth');
                if (appWindow.auth) {
                    log('success', '‚úÖ Instance auth disponible');
                    
                    // Test des m√©thodes
                    if (typeof appWindow.auth.getToken === 'function') {
                        log('success', '‚úÖ M√©thode getToken disponible');
                    } else {
                        log('error', '‚ùå M√©thode getToken indisponible');
                    }

                    if (typeof appWindow.auth.setToken === 'function') {
                        log('success', '‚úÖ M√©thode setToken disponible');
                    } else {
                        log('error', '‚ùå M√©thode setToken indisponible');
                    }
                } else {
                    log('error', '‚ùå Instance auth indisponible');
                }

                log('success', 'üîê Tests authentification termin√©s');
                
            } catch (error) {
                log('error', '‚ùå Erreur dans les tests auth: ' + error.message);
            }
        }

        // Tests Param√®tres
        async function runSettingsTests() {
            log('info', '‚öôÔ∏è D√©but des tests param√®tres...');
            
            try {
                await waitForAppLoad();
                const appWindow = getAppWindow();
                
                // Test 1: SettingsManager
                log('info', 'Test: Disponibilit√© de settingsManager');
                if (appWindow.settingsManager) {
                    log('success', '‚úÖ settingsManager disponible');
                    
                    // Test des m√©thodes
                    const methods = ['init', 'loadSettings', 'saveSettings'];
                    methods.forEach(method => {
                        if (typeof appWindow.settingsManager[method] === 'function') {
                            log('success', `‚úÖ M√©thode ${method} disponible`);
                        } else {
                            log('error', `‚ùå M√©thode ${method} indisponible`);
                        }
                    });
                } else {
                    log('error', '‚ùå settingsManager indisponible');
                }

                // Test 2: FormGenerator
                log('info', 'Test: Disponibilit√© de FormGenerator');
                if (appWindow.FormGenerator) {
                    log('success', '‚úÖ Classe FormGenerator disponible');
                } else {
                    log('error', '‚ùå Classe FormGenerator indisponible');
                }

                log('success', '‚öôÔ∏è Tests param√®tres termin√©s');
                
            } catch (error) {
                log('error', '‚ùå Erreur dans les tests param√®tres: ' + error.message);
            }
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            log('info', 'üöÄ Interface de tests initialis√©e');
            log('info', '‚è≥ Chargement de l\'application...');
        });
    </script>
</body>
</html>
