<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test - Chargement automatique des paramètres</title>
    <link href="node_modules/@gouvfr/dsfr/dist/dsfr.min.css" rel="stylesheet">
    <style>
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        .test-section {
            margin: 2rem 0;
            padding: 1rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .test-log {
            background: #f5f5f5;
            padding: 1rem;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .status-indicator {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        .status-success { background: #28a745; color: white; }
        .status-warning { background: #ffc107; color: black; }
        .status-error { background: #dc3545; color: white; }
        .status-info { background: #17a2b8; color: white; }
        .user-info {
            background: #e3f2fd;
            padding: 1rem;
            border-radius: 4px;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <header class="fr-header">
            <h1 class="fr-h1">Test - Chargement automatique des paramètres</h1>
            <p class="fr-text--lead">Cette page teste le chargement automatique des paramètres utilisateur lors de la connexion.</p>
        </header>

        <main>
            <!-- Section Auth Status -->
            <section class="test-section">
                <h2 class="fr-h3">1. État d'authentification</h2>
                <div id="auth-status">
                    <span class="status-indicator status-info">Vérification...</span>
                    <span id="auth-message">Vérification de l'état d'authentification...</span>
                </div>
                <div id="user-info" class="user-info" style="display:none;">
                    <!-- Les infos utilisateur seront affichées ici -->
                </div>
                <div class="fr-mt-2w">
                    <button class="fr-btn fr-btn--secondary" onclick="login()">Se connecter</button>
                    <button class="fr-btn fr-btn--secondary fr-ml-2w" onclick="logout()">Se déconnecter</button>
                    <button class="fr-btn fr-btn--secondary fr-ml-2w" onclick="checkAuth()">Vérifier auth</button>
                </div>
            </section>

            <!-- Section Settings Loading -->
            <section class="test-section">
                <h2 class="fr-h3">2. Chargement des paramètres</h2>
                <div id="settings-status">
                    <span class="status-indicator status-info">En attente</span>
                    <span id="settings-message">En attente du chargement...</span>
                </div>
                <div class="fr-mt-2w">
                    <button class="fr-btn fr-btn--secondary" onclick="loadSettings()">Charger paramètres</button>
                    <button class="fr-btn fr-btn--secondary fr-ml-2w" onclick="reloadAfterLogin()">Recharger après connexion</button>
                    <button class="fr-btn fr-btn--secondary fr-ml-2w" onclick="showCurrentSettings()">Afficher paramètres actuels</button>
                </div>
                <div id="current-settings" class="fr-mt-2w" style="display:none;">
                    <h4 class="fr-h5">Paramètres actuels :</h4>
                    <pre id="settings-display" class="test-log"></pre>
                </div>
            </section>

            <!-- Section Settings Form -->
            <section class="test-section">
                <h2 class="fr-h3">3. Formulaire de paramètres</h2>
                <div id="form-status">
                    <span class="status-indicator status-info">Non initialisé</span>
                    <span id="form-message">Formulaire non initialisé</span>
                </div>
                <div class="fr-mt-2w">
                    <button class="fr-btn fr-btn--secondary" onclick="initForm()">Initialiser formulaire</button>
                    <button class="fr-btn fr-btn--secondary fr-ml-2w" onclick="saveTestSettings()">Sauvegarder test</button>
                </div>
                <div id="settings-form-container" class="fr-mt-2w">
                    <!-- Le formulaire sera généré ici -->
                </div>
            </section>

            <!-- Section Server Test -->
            <section class="test-section">
                <h2 class="fr-h3">4. Test API serveur</h2>
                <div id="server-status">
                    <span class="status-indicator status-info">Non testé</span>
                    <span id="server-message">API non testée</span>
                </div>
                <div class="fr-mt-2w">
                    <button class="fr-btn fr-btn--secondary" onclick="testServerSave()">Tester sauvegarde</button>
                    <button class="fr-btn fr-btn--secondary fr-ml-2w" onclick="testServerLoad()">Tester chargement</button>
                    <button class="fr-btn fr-btn--secondary fr-ml-2w" onclick="testUserProfile()">Tester profil</button>
                </div>
            </section>

            <!-- Section Logs -->
            <section class="test-section">
                <h2 class="fr-h3">5. Logs système</h2>
                <div class="fr-mt-2w">
                    <button class="fr-btn fr-btn--secondary" onclick="clearLog()">Effacer logs</button>
                </div>
                <div id="test-log" class="test-log fr-mt-2w">
                    Logs d'activité...
                </div>
            </section>
        </main>
    </div>

    <!-- Scripts -->
    <script type="module" src="node_modules/@gouvfr/dsfr/dist/dsfr.module.min.js"></script>
    <script type="text/javascript" nomodule src="node_modules/@gouvfr/dsfr/dist/dsfr.nomodule.min.js"></script>
    <script src="js/ptm-auth.js"></script>
    <script src="js/form-generator.js"></script>
    <script src="js/settings-manager.js"></script>

    <script>
        // Variables globales pour le test
        let logContainer = null;

        // Fonction de log
        function log(message, type = 'info') {
            if (!logContainer) {
                logContainer = document.getElementById('test-log');
            }
            
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] [${type.toUpperCase()}] ${message}\n`;
            
            logContainer.textContent += logEntry;
            logContainer.scrollTop = logContainer.scrollHeight;
            
            console.log(`[TEST] ${message}`);
        }

        function clearLog() {
            if (logContainer) {
                logContainer.textContent = 'Logs effacés...\n';
            }
        }

        function updateStatus(element, status, message) {
            const statusElement = element.querySelector('.status-indicator');
            const messageElement = element.querySelector('span:last-child');
            
            statusElement.className = `status-indicator status-${status}`;
            messageElement.textContent = message;
        }

        // Fonctions d'authentification
        async function checkAuth() {
            log('Vérification de l\'état d\'authentification...');
            try {
                const isAuth = await window.ptmAuth.checkAuthStatus();
                const authStatus = document.getElementById('auth-status');
                const userInfo = document.getElementById('user-info');
                
                if (isAuth) {
                    updateStatus(authStatus, 'success', 'Utilisateur authentifié');
                    
                    const profile = await window.ptmAuth.getUserProfile();
                    userInfo.style.display = 'block';
                    userInfo.innerHTML = `
                        <h4 class="fr-h5">Profil utilisateur :</h4>
                        <p><strong>Nom :</strong> ${profile.first_name} ${profile.last_name}</p>
                        <p><strong>Email :</strong> ${profile.email}</p>
                        <p><strong>ORCID :</strong> ${profile.orcid_id}</p>
                        <p><strong>Institution :</strong> ${profile.institution || 'Non renseigné'}</p>
                    `;
                    
                    log('Utilisateur authentifié : ' + profile.email);
                } else {
                    updateStatus(authStatus, 'warning', 'Utilisateur non authentifié');
                    userInfo.style.display = 'none';
                    log('Utilisateur non authentifié');
                }
            } catch (error) {
                updateStatus(document.getElementById('auth-status'), 'error', 'Erreur d\'authentification');
                log('Erreur lors de la vérification : ' + error.message, 'error');
            }
        }

        function login() {
            log('Redirection vers la page de connexion...');
            window.location.href = 'https://api.ptm.huma-num.fr/auth/login?redirect_url=' + encodeURIComponent(window.location.href);
        }

        function logout() {
            log('Déconnexion...');
            window.ptmAuth.logout();
        }

        // Fonctions de paramètres
        async function loadSettings() {
            log('Chargement des paramètres...');
            try {
                await window.settingsManager.loadSettings();
                updateStatus(document.getElementById('settings-status'), 'success', 'Paramètres chargés');
                log('Paramètres chargés avec succès');
            } catch (error) {
                updateStatus(document.getElementById('settings-status'), 'error', 'Erreur de chargement');
                log('Erreur lors du chargement des paramètres : ' + error.message, 'error');
            }
        }

        async function reloadAfterLogin() {
            log('Rechargement des paramètres après connexion...');
            try {
                await window.settingsManager.reloadSettingsAfterLogin();
                updateStatus(document.getElementById('settings-status'), 'success', 'Paramètres rechargés');
                log('Paramètres rechargés après connexion');
            } catch (error) {
                updateStatus(document.getElementById('settings-status'), 'error', 'Erreur de rechargement');
                log('Erreur lors du rechargement : ' + error.message, 'error');
            }
        }

        function showCurrentSettings() {
            const settings = window.settingsManager.settings;
            const display = document.getElementById('settings-display');
            const container = document.getElementById('current-settings');
            
            display.textContent = JSON.stringify(settings, null, 2);
            container.style.display = 'block';
            
            log('Affichage des paramètres actuels');
        }

        // Fonctions de formulaire
        async function initForm() {
            log('Initialisation du formulaire...');
            try {
                await window.settingsManager.init('settings-form-container');
                updateStatus(document.getElementById('form-status'), 'success', 'Formulaire initialisé');
                log('Formulaire initialisé avec succès');
            } catch (error) {
                updateStatus(document.getElementById('form-status'), 'error', 'Erreur d\'initialisation');
                log('Erreur lors de l\'initialisation du formulaire : ' + error.message, 'error');
            }
        }

        async function saveTestSettings() {
            log('Sauvegarde de paramètres de test...');
            try {
                const testSettings = {
                    'select-algo': 'polynomial',
                    'select-resample': 'cubic',
                    'select-quality': 'highres',
                    'checkbox-compression': true,
                    'checkbox-transparent': false,
                    'checkbox-matrice': true,
                    'input-scale': 15
                };
                
                await window.settingsManager.saveSettings(testSettings);
                log('Paramètres de test sauvegardés : ' + JSON.stringify(testSettings));
            } catch (error) {
                log('Erreur lors de la sauvegarde de test : ' + error.message, 'error');
            }
        }

        // Fonctions de test serveur
        async function testServerSave() {
            log('Test de sauvegarde serveur...');
            try {
                const testData = {
                    algorithm: 'test',
                    quality: 'high',
                    timestamp: new Date().toISOString()
                };
                
                const result = await window.ptmAuth.saveGalligeoSettings(testData);
                updateStatus(document.getElementById('server-status'), 'success', 'Sauvegarde serveur OK');
                log('Sauvegarde serveur réussie : ' + JSON.stringify(result));
            } catch (error) {
                updateStatus(document.getElementById('server-status'), 'error', 'Erreur sauvegarde serveur');
                log('Erreur sauvegarde serveur : ' + error.message, 'error');
            }
        }

        async function testServerLoad() {
            log('Test de chargement serveur...');
            try {
                const data = await window.ptmAuth.getGalligeoSettings();
                updateStatus(document.getElementById('server-status'), 'success', 'Chargement serveur OK');
                log('Chargement serveur réussi : ' + JSON.stringify(data));
            } catch (error) {
                updateStatus(document.getElementById('server-status'), 'error', 'Erreur chargement serveur');
                log('Erreur chargement serveur : ' + error.message, 'error');
            }
        }

        async function testUserProfile() {
            log('Test du profil utilisateur...');
            try {
                const profile = await window.ptmAuth.getUserProfile();
                log('Profil utilisateur récupéré : ' + JSON.stringify(profile));
            } catch (error) {
                log('Erreur profil utilisateur : ' + error.message, 'error');
            }
        }

        // Event listeners
        document.addEventListener('settingsLoaded', function(event) {
            const { settings, source } = event.detail;
            log(`Événement settingsLoaded reçu - Source: ${source}`, 'info');
            updateStatus(document.getElementById('settings-status'), 'success', `Paramètres chargés depuis ${source}`);
        });

        document.addEventListener('settingsUpdated', function(event) {
            const { settings } = event.detail;
            log('Événement settingsUpdated reçu', 'info');
        });

        // Initialisation au chargement
        document.addEventListener('DOMContentLoaded', async () => {
            log('Page de test chargée, initialisation...');
            
            // Vérifier le token dans l'URL
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token') || urlParams.get('access_token');
            
            if (token) {
                log('Token détecté dans l\'URL : ' + token.substring(0, 10) + '...');
                window.ptmAuth.setToken(token);
                window.history.replaceState({}, document.title, window.location.pathname);
            }
            
            // Vérifier l'authentification
            await checkAuth();
            
            log('Initialisation terminée');
        });
    </script>
</body>
</html>
