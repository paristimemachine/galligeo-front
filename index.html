<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="node_modules/@gouvfr/dsfr/dist/dsfr.min.css">
    <link rel="stylesheet" href="node_modules/@gouvfr/dsfr/dist/component/form/form.min.css">
    <link rel="stylesheet" href="node_modules/@gouvfr/dsfr/dist/component/segmented/segmented.min.css">
    <link href="node_modules/@gouvfr/dsfr/dist/core/core.min.css" rel="stylesheet">
    <link href="node_modules/@gouvfr/dsfr/dist/component/link/link.min.css" rel="stylesheet">
    <link href="node_modules/@gouvfr/dsfr/dist/component/card/card.min.css" rel="stylesheet">

    <link rel="stylesheet" href="node_modules/@gouvfr/dsfr/dist/utility/icons/icons.min.css">

    <meta name="theme-color" content="#000091">

    <!-- <link rel="manifest" href="favicon/manifest.webmanifest" crossorigin="use-credentials"> -->
    <!-- Favicon -->
    <link rel="apple-touch-icon" href="img/favicon.png">
    <link rel="icon" href="img/favicon.png" type="image/png">
    <title>Galligeo</title>

    <!-- GESTIONNAIRE LEAFLET UNIFI√â (remplace 6 anciens fichiers) -->
    <script src="js/leaflet-loader.js"></script>

    <!-- css -->
    <!-- external -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" crossorigin=""/>
    <!-- Leaflet Draw d√©sactiv√© - non utilis√© dans cette application -->
    <!-- <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw-src.css" /> -->
    <!-- <link rel="stylesheet" href="https://unpkg.com/leaflet-geosearch@3.1.0/dist/geosearch.css"/> -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <link rel="stylesheet" href="https://rawgithub.com/ebrelsford/Leaflet.loading/master/src/Control.Loading.css" />

    <!-- internal -->
    <link rel="stylesheet" href="css/main.css"/>
    <link rel="stylesheet" href="css/map.css"/>

    <!-- js -->
    <!-- external -->
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet-geosearch@3.1.0/dist/bundle.min.js"></script>
    <!-- Leaflet Draw d√©sactiv√© - non utilis√© dans cette application -->
    <!-- <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw-src.js"></script> -->
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <script src="https://rawgithub.com/ebrelsford/Leaflet.loading/master/src/Control.Loading.js"></script>
    <!-- Leaflet Rotate Plugin -->
    <script src="https://unpkg.com/leaflet-rotate@0.2.8/dist/leaflet-rotate-src.js"></script>

  </head>
  <body>

    <!--  -->
    <!-- HEADER -->
    <!--  -->

    <header role="banner" class="fr-header">
        <div class="fr-header__body">
            <div class="fr-container--fluid">
                <div class="fr-header__body-row">
                    <div class="fr-header__brand fr-enlarge-link" style="margin-left: 24px;">
                        <div class="fr-header__brand-top">
                            <div class="fr-header__logo">
                            </div>
                            <div class="fr-header__operator">
                                <a href="index.html" title="Retour √† l'accueil - Galligeo">
                                    <img class="fr-responsive-img" style="width:auto; height:70px; margin-left: -32px;" src="img/logo_galligeo.png" alt="Galligeo" >
                                </a>

                            </div>
                            <div class="fr-header__navbar">
                                <button class="fr-btn--search fr-btn" data-fr-opened="false" aria-controls="modal-575" id="button-576" title="Rechercher">
                                    Rechercher
                                </button>
                                <button class="fr-btn--menu fr-btn" data-fr-opened="false" aria-controls="modal-577" aria-haspopup="menu" id="button-578" title="Menu">
                                    Menu
                                </button>

                            </div>
                        </div>
                    </div>
                    <div class="fr-header__tools">
                        <div class="fr-header__tools-links">
                            <ul class="fr-btns-group">
                                <li>
                                    <a class="fr-btn fr-icon-map-2-line" href="galerie/index.html" style="color:#000091;" title="D√©couvrir les cartes g√©or√©f√©renc√©es">
                                        Cartes g√©or√©f√©renc√©es
                                    </a>
                                </li>
                                <!-- <li>
                                    <a class="fr-btn fr-icon-add-circle-line" href="#" style="color:#ff5555;">
                                        Cr√©er un espace
                                    </a>
                                </li> -->
                                <!--
                                    <li>
                                        <a class="fr-btn fr-icon-lock-line" href="#" style="color:#ff5555;" data-fr-opened="false" aria-controls="fr-modal-login" >
                                            Se connecter
                                        </a>
                                    </li>
                                -->

                                <li>
                                    <button class="fr-btn fr-icon-lock-line" href="#" style="color:#ff5555;"  onclick="window.location.href='https://api.ptm.huma-num.fr/auth/login?redirect_url=https://app.ptm.huma-num.fr/galligeo/'">
                                        Se connecter avec ORCID
                                    </button>
                                </li>

                                <!-- <li>
                                    <a class="fr-btn fr-icon-account-line" href="#" style="color:#ff5555;">
                                        S‚Äôenregistrer
                                    </a>
                                </li> -->
                            </ul>
                        </div>
                        
                    </div>
                </div>
            </div>
        </div>
        <div class="fr-header__menu fr-modal" id="modal-560" aria-labelledby="button-561" style="display:none ;visibility: hidden;">
            <div class="fr-container">
                <button class="fr-btn--close fr-btn" aria-controls="modal-560" title="Fermer">
                    Fermer
                </button>
                <div class="fr-header__menu-links">
                </div>
                <nav class="fr-nav" id="navigation-564" role="navigation" aria-label="Menu principal">
                    <ul class="fr-nav__list">
                        <li class="fr-nav__item">
                            <a class="fr-nav__link" href="cartes-georeferencees.html" target="_self">
                                <span class="fr-icon-map-2-fill fr-mr-1w" aria-hidden="true"></span>
                                Cartes g√©or√©f√©renc√©es
                            </a>
                        </li>
                        <li class="fr-nav__item">
                            <a class="fr-nav__link" href="#" target="_self">Acc√®s direct</a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <!-- Container principal pour le contenu -->
    <div class="fr-container--fluid main-content-container">

    <!--  -->
    <!-- NAV -->
    <!--  -->
    <nav class="fr-nav" id="header-navigation" role="navigation" aria-label="Menu principal">

        <div class="fr-grid-row main-content-row">

            <!-- side bar -->
            <div class="fr-col-1" id="nav-tools-sidebar-control">

                <!-- button close hidden at startup -->
                <!-- button filter complet -->
                <div class="nav-tools-bar-inner-legend-filter item-hover" id="id-nav-tools-bar-inner-legend-filter" onclick="toggleLegend()">
                   
                    <span class="nav-tools-bar-inner-legend-filter-text">
                        <span>Contr√¥les</span>
                    </span>
                    <div class="nav-tools-bar-inner-legend-filter-icon2">
                        <img src="node_modules/@gouvfr/dsfr/dist/icons/system/arrow-left-line.svg" alt="arrowslineI127"
                            id="nav-tools-bar-inner-legend-filter-icon2-inner">
                    </div>
                </div>

            </div>

            <!-- search bar -->
            <div class="fr-col-5" id="nav-search-bar">
                    <div class="fr-search-bar autocomplete" id="header-search" role="search">
                        <div style="display: flex; align-items: center; margin-bottom: 8px;">
                            <img src="img/favicon_gallica.png" alt="Gallica" onclick="window.open('https://gallica.bnf.fr/', '_blank')" style="width: 32px; height: 32px; cursor: pointer;" title="Aller sur Gallica">
                        </div>
                        <table border=0>
                            <tr>
                            <td><label class="fr-label" for="search-784-input" onkeydown='load_ark_picture()'>
                                (1) Charger une image depuis Gallica
                            </label>
                            </td><td>
                                <input class="fr-input" placeholder="Entrer une URL Gallica Ark de type : https://gallica.bnf.fr/ark:/12148/btv1b106799487" type="search" id="search-784-input" name="search-784-input"> <!--list="sites_list"> -->
                                    </td><td>
                                <button class="fr-btn" title="Charger une image depuis Gallica" onclick='load_ark_picture()'>
                                </button>
                            </td></tr>
                        </table>
                    </div>

            </div>

            <div class="fr-col-6" id="nav-tools4">
                
                <div class="fr-toggle">
                    <input type="checkbox" class="fr-toggle__input" id="toggle" aria-describedby="toggle-messages toggle-hint">
                    <label class="fr-toggle__label" for="toggle" data-fr-checked-label="Verrouill√©" data-fr-unchecked-label="Saisie"></label>
                    <!-- <p class="fr-hint-text" id="toggle-hint">Texte de description additionnel</p> -->
                    <div class="fr-messages-group" id="toggle-messages" aria-live="polite">
                    </div>
                </div>
                <fieldset class="fr-segmented fr-segmented--no-legend" title="Sasir des points de contr√¥le et l'emprise utile de la carte, la zone exclue sera d√©coup√©e">
                    <legend class="fr-segmented__legend fr-segmented__legend--inline">
                        Saisir
                        <!-- <span class="fr-hint-text">Description additionnelle</span> -->
                    </legend>
                    <div class="fr-segmented__elements">
                        <div class="fr-segmented__element">
                            <input value="1" checked type="radio" id="segmented-1" name="segmented">
                            <label class="fr-label" for="segmented-1">
                                Points
                            </label>
                        </div>
                        <div class="fr-segmented__element">
                            <input value="2" type="radio" id="segmented-2" name="segmented">
                            <label class="fr-label" for="segmented-2">
                                Emprise
                            </label>
                        </div>
                    </div>
                </fieldset>
                </fieldset>

                <button class="fr-btn fr-btn--secondary" id="btn_georef" disabled onclick="click_georef('', list_georef_points, list_points_polygon_crop, input_ark)"> 
                    G√©or√©f√©rencer
                </button>

                <button class="fr-btn fr-btn--secondary" id="btn_display" disabled onclick="display_result(input_ark)">
                    R√©sultat
                </button>

                <button class="fr-btn fr-btn--secondary" id="btn_deposit" data-fr-opened="false" aria-controls="fr-modal-deposit" disabled>
                    <!--<button class="fr-btn fr-btn--secondary" id="btn_deposit" data-fr-opened="false" aria-controls="fr-modal-deposit"> -->
                    D√©poser
                </button>

            </div>
        </div>

    </nav>
    <!--  -->
    <!-- END NAV -->
    <!--  -->

    <!--  -->
    <!-- Modal deposit  -->
    <!--  -->
    <dialog aria-labelledby="fr-modal-deposit" id="fr-modal-deposit" class="fr-modal" role="dialog" >
        <div class="fr-container fr-container--fluid fr-container-md">
            <div class="fr-grid-row fr-grid-row--center">
                <div class="fr-col-12 fr-col-md-8 fr-col-lg-6">
                    <div class="fr-modal__body">
                        <div class="fr-modal__header">
                            <button class="fr-link--close fr-link" aria-controls="fr-modal-deposit"">Fermer</button>
                        </div>
                        <div class="fr-modal__content">
                            <h1 id="fr-modal-2-title" class="fr-modal__title">
                                <span class="fr-fi-arrow-right-line fr-fi--lg"></span>
                                D√©p√¥t de donn√©es : choix d'un entrep√¥t
                            </h1>

                            <div class="fr-checkbox-group fr-checkbox-group--error" id="group-checkbox-nakala">
                                <input aria-describedby="checkbox-nakala" id="checkbox-nakala" type="checkbox" onchange="clkNakalaDepot()">
                                <label class="fr-label" for="checkbox-nakala">
                                  <a href="https://www.nakala.fr/about" target="_blank" rel="noopener">Nakala</a> : entrep√¥t de donn√©es de l'<a href="https://www.huma-num.fr/" target="_blank" rel="noopener">IR* Huma-Num CNRS</a>
                                </label>
                                <div class="fr-messages-group" id="checkbox-nakala-error" aria-live="assertive">
                                    <p class="fr-message fr-message--error" id="checkbox-nakala-message-error">Cocher et entrer une cl√© d'API</p>
                                </div>
                                <div class="fr-messages-group" id="checkbox-nakala-ok" aria-live="assertive" style="visibility: hidden; display: none;">
                                    <p class="fr-message fr-message--valid" id="checkboxes-valid-message-valid">Ok</p>
                                </div>
                            </div>

                            <label class="fr-label" for="text-input-text">API Key Nakala</label>
                            <input class="fr-input" type="text" id="nakala_api_key" name="text-input-text" value="66c0810c-19c3-5463-5082-20f04d53b971">
                            <label class="fr-label" for="text-input-text">Collection DOI</label>
                            <input class="fr-input" type="text" id="nakala_collection_doi" name="text-input-text" value="10.34847/nkl.febfl1v2">
                            

                            <br>

                            <!--
                            <div class="fr-checkbox-group fr-checkbox-group--error">
                                <input aria-describedby="checkbox-fnp" id="checkbox-fnp" type="checkbox">
                                <label class="fr-label" for="checkbox-fnp">
                                  <a href="https://www.fabriquenumeriquedupasse.fr/" target="_blank" rel="noopener">La Fabrique Num√©rique du pass√©</a> : portail de d√©p√¥t de donn√©es g√©ohistoriques du <a href="https://paris-timemachine.huma-num.fr/" target="_blank" rel="noopener">Consortium Huma-Num PTM</a>
                                </label>
                                <div class="fr-messages-group" id="checkbox-fnp-error" aria-live="assertive">
                                    <p class="fr-message fr-message--error" id="checkbox-fnp-message-error">Cocher et entrer une cl√© d'API</p>
                                </div>
                            </div>

                            <label class="fr-label" for="text-input-text">API Key FNP</label>
                            <input class="fr-input" type="text" id="text-input-text" name="text-input-text">
                            
                            <br>

                            <div class="fr-checkbox-group fr-checkbox-group--error" id="group-checkbox-geoserverptm">
                                <input aria-describedby="checkbox-geoserverptm" id="checkbox-geoserverptm" type="checkbox" onchange="clkGeoserver()">
                                <label class="fr-label" for="checkbox-geoserverptm">
                                    GeoServer PTM : d√©p√¥t sur le g√©oserveur du CST Huma-Num PTM
                                </label>
                                <div class="fr-messages-group" id="checkbox-geoserverptm-error" aria-live="assertive">
                                    <p class="fr-message fr-message--error" id="checkbox-geoserverptm-message-error">Cocher</p>
                                </div>
                                <div class="fr-messages-group" id="checkbox-geoserverptm-ok" aria-live="assertive" style="visibility: hidden; display: none;">
                                    <p class="fr-message fr-message--valid" id="checkboxes-valid-message-valid">Ok</p>
                                </div>
                            </div>
                            -->

                            <br>

                            <h1 id="fr-modal-2-title" class="fr-modal__title">
                                <span class="fr-fi-arrow-right-line fr-fi--lg"></span>
                                M√©tadonn√©es d'enrichissement
                            </h1>

                            <div id="modal-deposit-metadata">
                                <fieldset class="fr-fieldset" aria-label="Demande de nom et pr√©nom" aria-describedby="name-1-fieldset-messages">
                                    <div class="fr-fieldset__element">
                                        <div class="fr-input-group">
                                            <label class="fr-label" for="input-family-name-1">
                                                Nom
                                            </label>
                                            <input class="fr-input" spellcheck="false" autocomplete="family-name" name="family-name" id="input-family-name-1" type="text">
                                        </div>
                                    </div>
                                    <div class="fr-fieldset__element">
                                        <div class="fr-input-group">
                                            <label class="fr-label" for="input-firstname-1">
                                                Pr√©nom
                                            </label>
                                            <input class="fr-input" spellcheck="false" autocomplete="given-name" name="given-name" id="input-firstname-1" type="text">
                                        </div>
                                    </div>
                                    <div class="fr-messages-group" aria-live="assertive" id="name-1-fieldset-messages">
                                    </div>
                                    <div class="fr-fieldset__element">
                                        <div class="fr-input-group">
                                            <label class="fr-label">
                                                Institution / Universit√© / Organisme
                                            </label>
                                            <input class="fr-input" id="input-institution" aria-describedby="input-position-1-messages" name="position" type="text" value="">
                                            <div class="fr-messages-group" id="input-position-1-messages" aria-live="assertive">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="fr-messages-group" id="representative-1661-fieldset-messages" aria-live="assertive">
                                    </div>
                                </fieldset>
                            </div>
                        </div>

                        <div class="fr-modal__footer">
                            <ul class="fr-btns-group fr-btns-group--right fr-btns-group--inline-reverse fr-btns-group--inline-lg fr-btns-group--icon-left">
                                <li>
                                    <button class="fr-btn fr-fi-close-line fr-btn--secondary" aria-controls="fr-modal-deposit" onclick="document.getElementById('fr-modal-deposit').close()">
                                        Annuler
                                    </button>
                                </li>
                                <li>
                                    <button class="fr-btn fr-fi-checkbox-line fr-btn--secondary" onclick="deposerSurNakala(document.getElementById('nakala_api_key').value, document.getElementById('nakala_collection_doi').value)">
                                        D√©poser
                                    </button>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </dialog>
    <!--  -->
    <!-- END Modal deposit  -->
    <!--  -->

    <!--  -->
    <!-- Modal Settings DSFR -->
    <dialog class="fr-modal" id="fr-modal-settings" aria-labelledby="fr-modal-settings-title">
        <div class="fr-container fr-container--fluid fr-container-md">
            <div class="fr-grid-row fr-grid-row--center">
                <div class="fr-col-12 fr-col-md-8 fr-col-lg-6">
                    <div class="fr-modal__body">
                        <div class="fr-modal__header">
                            <button class="fr-link--close fr-link" aria-controls="fr-modal-settings">Fermer</button>
                        </div>
                        <div class="fr-modal__content">
                            <h2 id="fr-modal-settings-title" class="fr-modal__title">
                                <span class="fr-icon-account-circle-line fr-icon--lg" aria-hidden="true"></span>
                                Mon Galligeo
                            </h2>

                            <div class="fr-tabs" id="user-tabs">
                                <ul class="fr-tabs__list" role="tablist" aria-label="Navigation espace utilisateur">
                                    <li role="presentation">
                                        <button id="tabpanel-profil" class="fr-tabs__tab" tabindex="0" role="tab" aria-selected="true" aria-controls="tabpanel-profil-panel">Profil utilisateur</button>
                                    </li>
                                    <li role="presentation">
                                        <button id="tabpanel-parametres" class="fr-tabs__tab" tabindex="-1" role="tab" aria-selected="false" aria-controls="tabpanel-parametres-panel">Param√®tres g√©or√©f√©rencement</button>
                                    </li>
                                    <li role="presentation">
                                        <button id="tabpanel-cartes" class="fr-tabs__tab" tabindex="-1" role="tab" aria-selected="false" aria-controls="tabpanel-cartes-panel">Mes cartes</button>
                                    </li>
                                    <li role="presentation">
                                        <button id="tabpanel-atlas" class="fr-tabs__tab" tabindex="-1" role="tab" aria-selected="false" aria-controls="tabpanel-atlas-panel">Mes atlas</button>
                                    </li>
                                </ul>

                                <!-- Panel Profil -->
                                <div id="tabpanel-profil-panel" class="fr-tabs__panel fr-tabs__panel--selected" role="tabpanel" aria-labelledby="tabpanel-profil" tabindex="0">
                                    <section class="fr-container fr-card fr-card--shadow fr-p-4w fr-mb-4w">
                                        <h3 class="fr-h4">Informations utilisateur</h3>
                                        <div class="fr-grid-row fr-grid-row--gutters fr-mt-2w">
                                            <div class="fr-col-3">
                                                <img src="img/users/avatar_neutre.jpg" alt="Photo de profil" class="fr-responsive-img fr-mb-2w" style="border-radius: 50%; max-width: 80%;">
                                            </div>
                                            <div class="fr-col-9">
                                                <div class="user-profile-info">
                                                    <div class="fr-grid-row fr-grid-row--gutters">
                                                        <div class="fr-col-12 fr-col-md-6">
                                                            <div class="info-item">
                                                                <span class="info-label"><strong>Pr√©nom :</strong></span>
                                                                <span class="info-value" id="user-first-name">Chargement...</span>
                                                            </div>
                                                        </div>
                                                        <div class="fr-col-12 fr-col-md-6">
                                                            <div class="info-item">
                                                                <span class="info-label"><strong>Nom :</strong></span>
                                                                <span class="info-value" id="user-last-name">Chargement...</span>
                                                            </div>
                                                        </div>
                                                        <div class="fr-col-12">
                                                            <div class="info-item">
                                                                <span class="info-label"><strong>Email :</strong></span>
                                                                <span class="info-value" id="user-email">Chargement...</span>
                                                            </div>
                                                        </div>
                                                        <div class="fr-col-12">
                                                            <div class="info-item">
                                                                <span class="info-label"><strong>ORCID :</strong></span>
                                                                <span class="info-value" id="user-orcid">Chargement...</span>
                                                            </div>
                                                        </div>
                                                        <div class="fr-col-12">
                                                            <div class="info-item">
                                                                <span class="info-label"><strong>Institution :</strong></span>
                                                                <span class="info-value" id="user-institution">Chargement...</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <p class="fr-mt-2w">Vous pouvez modifier ces informations dans votre 
                                                    <a href="https://api.ptm.huma-num.fr/auth/profile" target="_blank" rel="noopener">
                                                        profil centralis√©
                                                    </a>.
                                                </p>
                                            </div>
                                        </div>
                                    </section>
                                </div>

                                <!-- Panel Param√®tres -->
                                <div id="tabpanel-parametres-panel" class="fr-tabs__panel" role="tabpanel" aria-labelledby="tabpanel-parametres" tabindex="0">
                                    <section class="fr-container fr-card fr-card--shadow fr-p-4w fr-mb-4w">
                                        <h3 class="fr-h4">Param√®tres de g√©or√©f√©rencement</h3>
                                        
                                        <!-- Conteneur pour le formulaire g√©n√©r√© dynamiquement -->
                                        <div id="settings-form-container">
                                            <!-- Le formulaire sera g√©n√©r√© ici par JavaScript -->
                                            <div class="fr-alert fr-alert--info fr-mb-3w">
                                                <p>Chargement des param√®tres...</p>
                                            </div>
                                        </div>
                                        
                                        <!-- Actions suppl√©mentaires -->
                                        <div class="settings-actions">
                                            <button type="button" class="fr-btn fr-btn--secondary" onclick="window.settingsManager.resetSettings()">
                                                <span class="fr-icon-refresh-line" aria-hidden="true"></span>
                                                R√©initialiser
                                            </button>
                                            <button type="button" class="fr-btn fr-btn--secondary" onclick="window.settingsManager.exportSettings()">
                                                <span class="fr-icon-download-line" aria-hidden="true"></span>
                                                Exporter
                                            </button>
                                            <label for="import-settings" class="fr-btn fr-btn--secondary" style="margin: 0; cursor: pointer;">
                                                <span class="fr-icon-upload-line" aria-hidden="true"></span>
                                                Importer
                                                <input type="file" id="import-settings" accept=".json" style="display: none;" 
                                                       onchange="handleSettingsImport(this)">
                                            </label>
                                        </div>
                                        
                                    </section>
                                </div>

                                <!-- Panel Cartes -->
                                <div id="tabpanel-cartes-panel" class="fr-tabs__panel" role="tabpanel" aria-labelledby="tabpanel-cartes" tabindex="0">
                                    <section class="fr-container fr-py-4w">
                                        <h3 class="fr-h4 fr-mb-3w">Vos cartes</h3>

                                        <!-- Section Favoris Cartoquete -->
                                        <div id="cartoquete-favorites-section" style="display:none;">
                                            <h4 class="fr-h5 fr-mb-2w">
                                                <span class="fr-icon-star-fill fr-mr-1w" aria-hidden="true"></span>
                                                Favoris Cartoquete
                                            </h4>
                                            <div class="fr-grid-row fr-grid-row--gutters fr-mb-4w" id="cartoquete-favorites-container">
                                                <!-- Les favoris Cartoquete seront charg√©s ici dynamiquement -->
                                                <div class="fr-col-12">
                                                    <div class="fr-alert fr-alert--info">
                                                        <p>Chargement des favoris Cartoquete...</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Section Cartes Travaill√©es -->
                                        <div id="worked-maps-section" style="display:none;">
                                            <h4 class="fr-h5 fr-mb-2w">
                                                <span class="fr-icon-map-pin-2-fill fr-mr-1w" aria-hidden="true"></span>
                                                Vos cartes travaill√©es
                                            </h4>
                                            <div class="fr-grid-row fr-grid-row--gutters fr-mb-4w" id="worked-maps-container">
                                                <!-- Les cartes travaill√©es seront charg√©es ici dynamiquement -->
                                                <div class="fr-col-12">
                                                    <div class="fr-alert fr-alert--info">
                                                        <p>Chargement de vos cartes travaill√©es...</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        {# <!-- Section Exemples -->
                                        <h4 class="fr-h5 fr-mb-2w">
                                            <span class="fr-icon-map-2-fill fr-mr-1w" aria-hidden="true"></span>
                                            Exemples de cartes g√©or√©f√©renc√©es
                                        </h4>
                                        <div class="fr-grid-row fr-grid-row--gutters fr-mb-4w">
                                            <!-- Carte 1 -->
                                            <div class="fr-col-md-6 fr-col">
                                                <div class="fr-card">
                                                    <div class="fr-card__body">
                                                        <div class="fr-card__content">
                                                            <h4 class="fr-card__title">
                                                                <a href="#">Paris 1944</a>
                                                            </h4>
                                                            <p class="fr-card__desc">Paris en 1944 - Girard et Barr√®re - G√©ographe Editeurs</p>
                                                            <p class="fr-card__desc"><a href="https://gallica.bnf.fr/ark:/12148/btv1b53121232b" target="_blank">Voir la notice Gallica</a></p>
                                                            <p class="fr-card__desc"><a href="https://app.ptm.huma-num.fr/galligeo/georef/?ark=btv1b53121232b" target="_blank">Voir la carte g√©or√©f√©renc√©e</a></p>
                                                            <div class="fr-card__start">
                                                                <ul class="fr-tags-group">
                                                                    <li><p class="fr-tag">Paris</p></li>
                                                                    <li><p class="fr-tag fr-tag--green-emeraude">XX√®me s.</p></li>
                                                                </ul>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="fr-card__header">
                                                        <div class="fr-card__img">
                                                            <img class="fr-responsive-img" src="img/georefs/georef_paris1944.jpg" alt="Carte de Paris en 1944" />
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Carte 2 -->
                                            <div class="fr-col-md-6 fr-col">
                                                <div class="fr-card">
                                                    <div class="fr-card__body">
                                                        <div class="fr-card__content">
                                                            <h4 class="fr-card__title">
                                                                <a href="#">Carte des fils t√©l√©graphiques</a>
                                                            </h4>
                                                            <p class="fr-card__desc">Carte des fils t√©l√©graphiques</p>
                                                            <p class="fr-card__desc"><a href="https://gallica.bnf.fr/ark:/12148/btv1b532480876" target="_blank">Voir la notice Gallica</a></p>
                                                            <p class="fr-card__desc"><a href="https://app.ptm.huma-num.fr/galligeo/georef/?ark=btv1b532480876" target="_blank">Voir la carte g√©or√©f√©renc√©e</a></p>
                                                            <div class="fr-card__start">
                                                                <ul class="fr-tags-group">
                                                                    <li><p class="fr-tag fr-tag--blue-france">Exemple</p></li>
                                                                    <li><p class="fr-tag fr-tag--green-emeraude">G√©or√©f√©renc√©e</p></li>
                                                                </ul>
                                                                <p class="fr-card__detail fr-icon-star-fill">Exemple Galligeo</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="fr-card__header">
                                                        <div class="fr-card__img">
                                                            <img class="fr-responsive-img" src="img/georefs/georef_france_fils_telegraphiques.jpg" alt="Carte des fils t√©l√©graphiques" />
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Carte 3 -->
                                            <div class="fr-col-md-6 fr-col">
                                                <div class="fr-card">
                                                    <div class="fr-card__body">
                                                        <div class="fr-card__content">
                                                            <h4 class="fr-card__title">
                                                                <a href="#">Amiens. - Plan de la ville d'Amiens</a>
                                                            </h4>
                                                            <p class="fr-card__desc">Amiens. - Plan de la ville d'Amiens en 1848</p>
                                                            <p class="fr-card__desc"><a href="https://gallica.bnf.fr/ark:/12148/btv1b8441346h" target="_blank">Voir la notice Gallica</a></p>
                                                            <div class="fr-card__start">
                                                                <ul class="fr-tags-group">
                                                                    <li><p class="fr-tag fr-tag--blue-france">Exemple</p></li>
                                                                    <li><p class="fr-tag fr-tag--pink-tuile">A g√©or√©f√©rencer</p></li>
                                                                </ul>
                                                                <p class="fr-card__detail fr-icon-time-line">Exemple Galligeo</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="fr-card__header">
                                                        <div class="fr-card__img">
                                                            <img class="fr-responsive-img" src="img/georefs/georef_amiens1848.jpg" alt="Amiens. - Plan de la ville d'Amiens en 1848" />
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div> #}

                                        <p class="fr-text--sm fr-mt-2w">
                                            <span id="cartoquete-status-message">Connectez-vous pour voir vos favoris Cartoquete et vos cartes travaill√©es.</span>
                                        </p>
                                    </section>
                                </div>

                                <!-- Panel Mes atlas -->
                                <div id="tabpanel-atlas-panel" class="fr-tabs__panel" role="tabpanel" aria-labelledby="tabpanel-atlas" tabindex="0">
                                    <section class="fr-container fr-py-4w">
                                        <h3 class="fr-h4 fr-mb-3w">
                                            <span class="fr-icon-map-2-fill fr-mr-1w" aria-hidden="true"></span>
                                            Mes atlas
                                        </h3>

                                        <div class="fr-alert fr-alert--info fr-mb-3w">
                                            <p class="fr-text--sm">
                                                <span class="fr-icon-information-line fr-mr-1w" aria-hidden="true"></span>
                                                Les atlas sont des collections th√©matiques de cartes g√©or√©f√©renc√©es regroup√©es par ville, r√©gion ou th√®me.
                                            </p>
                                        </div>

                                        <!-- Liste des atlas -->
                                        <div id="atlas-list-container" class="fr-mb-3w">
                                            <!-- Message de chargement par d√©faut -->
                                            <div class="fr-alert fr-alert--info" id="atlas-loading">
                                                <p class="fr-text--sm">
                                                    <span class="fr-icon-refresh-line fr-mr-1w" aria-hidden="true"></span>
                                                    Chargement de vos atlas...
                                                </p>
                                            </div>
                                        </div>

                                        <!-- Lien vers la galerie pour cr√©er un atlas -->
                                        <div class="fr-mt-4w">
                                            <a href="galerie/index.html" class="fr-btn fr-btn--secondary fr-icon-add-line">
                                                Cr√©er un nouvel atlas
                                            </a>
                                            <p class="fr-text--xs fr-mt-1w" style="opacity: 0.7;">
                                                Rendez-vous dans la galerie pour s√©lectionner des cartes et cr√©er un atlas.
                                            </p>
                                        </div>

                                        <p class="fr-text--sm fr-mt-4w" style="opacity: 0.7;">
                                            <span id="atlas-status-message"></span>
                                        </p>
                                    </section>
                                </div>

                            </div>

                            <!-- Footer Modal
                            <div class="fr-modal__footer">
                                <ul class="fr-btns-group fr-btns-group--right fr-btns-group--inline-reverse fr-btns-group--inline-lg fr-btns-group--icon-left">
                                    <li>
                                        <button class="fr-btn fr-icon-close-line fr-btn--secondary" onclick="closeSettingsModal()">
                                            Fermer
                                        </button>
                                    </li>
                                </ul>
                            </div>
                            -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </dialog>
    <!--  -->
    <!-- END Modal Settings  -->
    <!--  -->

    <!--  -->
    <!-- PANEL-->
    <!--  -->
    <div class="fr-container--fluid">
        <div class="fr-grid-row">

            <div class="fr-col-2" id="sidebar">

                <div class="fr-stepper" style="padding-left: 4px; padding-right: 4px;">
                    <h2 class="fr-stepper__title" id="titre-etape-georef">
                        <span class="fr-stepper__state" id="etape-georef">√âtape 1 sur 4</span>
                        Charger un lien ark de Gallica
                    </h2>
                    <div class="fr-stepper__steps" id="steps" data-fr-current-step="1" data-fr-steps="4"></div>
                    <p class="fr-stepper__details" id="etape-suite">
                        <span class="fr-text--bold" >√âtape suivante :</span> Cr√©er des points de contr√¥le
                    </p>
                </div>

                <!-- Contr√¥les de saisie d√©plac√©s depuis la navigation -->
                <div class="input-controls-section" style="padding: 8px 4px;">
                    <!-- Statut de saisie -->
                    <div class="fr-notice fr-notice--info" id="input-status-container" style="margin: 8px 0;">
                        <div class="fr-container">
                            <div class="fr-notice__body">
                                <p class="fr-notice__title" id="input-status">
                                    Syst√®me de saisie initialis√©
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Boutons d'action pour la saisie -->
                    <div class="fr-btns-group fr-btns-group--sm" id="input-actions" style="margin: 8px 0;">
                        <button class="fr-btn fr-btn--tertiary fr-btn--sm" id="btn_clear_points" onclick="clearAllControlPoints()">
                            Effacer pts
                        </button>
                        <button class="fr-btn fr-btn--tertiary fr-btn--sm" id="btn_clear_emprise" onclick="clearEmprise()">
                            Effacer emp.
                        </button>
                        <button class="fr-btn fr-btn--tertiary fr-btn--sm" id="btn_save_backup" onclick="window.controlPointsBackup.saveCurrentState('manual')" title="Sauvegarder manuellement les points de contr√¥le">
                            üíæ Sauver
                        </button>
                        <button class="fr-btn fr-btn--tertiary fr-btn--sm" id="btn_restore_backup" onclick="window.controlPointsBackup.showRestoreInterface()" title="Restaurer des points de contr√¥le sauvegard√©s">
                            üìÅ Restaurer
                        </button>
                    </div>

                    <!-- Indicateur de sauvegarde automatique -->
                    <div class="fr-notice fr-notice--new" id="backup-status-container" style="margin: 8px 0; display: none;">
                        <div class="fr-container">
                            <div class="fr-notice__body">
                                <p class="fr-notice__title" id="backup-status">
                                    üíæ Sauvegarde automatique active
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <section class="fr-accordion" id="table-control-points">
                    <h3 class="fr-accordion__title">
                        <button class="fr-accordion__btn" aria-expanded="true" aria-controls="div-table-control-points">Points de contr√¥le</button>
                    </h3>
                    <div class="fr-collapse" id="div-table-control-points" style="padding-right: 4px;">
                        
                        <div class="fr-table fr-table--layout-fixed">
                            <table>
                                <!-- <caption>R√©sum√© du tableau (accessibilit√©)</caption> -->
                                <thead>
                                    <tr>
                                        <th scope="col">Point source</th>
                                        <th scope="col">Point cible</th>
                                    </tr>
                                </thead>
                                <tbody id='table_body'>
                                    <!-- Le contenu sera g√©n√©r√© dynamiquement par JavaScript -->
                                </tbody>
                            </table>
                        </div>

                    </div>
                </section>

            </div>
            
            <div class="fr-col-5" id="map-container-left-at-startup" style="display: flex; visibility: visible">

                    <div class="image_box">
                    <iframe
                        class="image_box-video"
                        src="https://www.youtube.com/embed/AqM1T_e4LYc?autoplay=1&mute=1&loop=1&playlist=AqM1T_e4LYc"
                        title="Tutoriel Gallig√©o"
                        frameborder="0"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                        allowfullscreen
                        referrerpolicy="strict-origin-when-cross-origin"
                        >
                    </iframe>
                    </div>

            </div>
            
            <div class="fr-col-5" id="map-container-left">

                <div id="map-left"></div>
            </div>

            <script>
                document.getElementById('map-container-left').style.display = "none"
                document.getElementById('map-container-left').style.visibility = 'hidden';
            </script>

            <div class="fr-col-5" id="map-container-right">

                <div id="map-right"></div>
            </div>

        </div>
        </div>
    
    <!--  -->
    <!-- END MAP -->
    <!--  -->

    </div>
    <!-- END Container principal -->

    <!--  -->
    <!-- FOOTER  style="--icon-size:0;width:0;height:0;vertical-size:0" -->
    <!--  -->
    <footer class="footer">
        <p>Made with
            <svg class="heart-icon" aria-hidden="true" focusable="false" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                <path fill="currentColor" d="M462.3 62.6C407.5 15.9 326 24.3 275.7 76.2L256 96.5l-19.7-20.3C186.1 24.3 104.5 15.9 49.7 62.6c-62.8 53.6-66.1 149.8-9.9 207.9l193.5 199.8c12.5 12.9 32.8 12.9 45.3 0l193.5-199.8c56.3-58.1 53-154.3-9.8-207.9z">
                </path>
            </svg>
            &nbsp by <img class="fr-responsive-img footer-logo" style="width:auto; height:28px; cursor: pointer;" src="img/logo_ptm_small.png" alt="PTM" onclick="openExternalLink('https://ptm.huma-num.fr/')" title="Projets Time Machine">
            
           <img class="fr-responsive-img footer-logo" style="width:auto; height:16px; cursor: pointer;" src="img/logo_hn.png" alt="Huma-Num" onclick="openExternalLink('https://www.huma-num.fr/')" title="Huma-Num">
           &nbsp;+&nbsp;
           <img class="fr-responsive-img footer-logo" style="width:auto; height:16px; cursor: pointer;" src="img/logo_bnf_datalab.png" alt="BnF / Datalab" onclick="openExternalLink('https://www.bnf.fr/fr/bnf-datalab')" title="BnF / Datalab">
           &nbsp;‚Äî&nbsp;
           <span style="cursor: pointer; text-decoration: underline;" onclick="openExternalLink('https://github.com/paristimemachine/galligeo-front')" title="Code & Documentation">Code &amp; Documentation</span>
           &nbsp;‚Äî

<script>
function openExternalLink(url) {
    window.open(url, '_blank', 'noopener,noreferrer');
}
</script>
           <span id="app-version-info" class="version-info" style="opacity: 0.7; font-size: 0.85em; color: #666;">
               <span id="version-display">Chargement...</span>
               <span id="version-details" style="display: none;">
                   <span id="version-build"></span>
                   <span id="version-commit"></span>
                   <span id="version-date"></span>
               </span>
           </span>
        </p>
      </footer>
    <!--  -->
    <!-- END FOOTER -->
    <!--  -->


    <!--  -->
    <!-- Modal Login-->
    <!--  -->
    <!-- Change the link to the login page
    <dialog aria-labelledby="fr-modal-login" id="fr-modal-login" class="fr-modal" role="dialog" >
        <div class="fr-container fr-container--fluid fr-container-md">
            <div class="fr-grid-row fr-grid-row--center">
                <div class="fr-col-12 fr-col-md-8 fr-col-lg-6">
                    <div class="fr-modal__body">
                        <div class="fr-modal__header">
                            <button class="fr-link--close fr-link" aria-controls="fr-modal-login">Fermer</button>
                        </div>
                        <div class="fr-modal__content">
                            <h1 id="fr-modal-2-title" class="fr-modal__title">
                                <span class="fr-fi-arrow-right-line fr-fi--lg"></span>
                                Connexion √† Galligeo
                            </h1>
                            
                            <form id="login-1760">
                                <fieldset class="fr-fieldset" id="login-1760-fieldset" aria-labelledby="login-1760-fieldset-legend login-1760-fieldset-messages">
                                    <legend class="fr-fieldset__legend" id="login-1760-fieldset-legend">
                                        <h2>Se connecter avec son compte</h2>
                                    </legend>
                                    <div class="fr-fieldset__element">
                                        <p class="fr-text--sm">Fonctionnalit√© non disponible √† l'heure actuelle</p>
                                    </div>
                                    <div class="fr-fieldset__element">
                                        <fieldset class="fr-fieldset" id="credentials" aria-labelledby="credentials-messages">
                                            <div class="fr-fieldset__element">
                                                <span class="fr-hint-text">Sauf mention contraire, tous les champs sont obligatoires.</span>
                                            </div>
                                            <div class="fr-fieldset__element">
                                                <div class="fr-input-group">
                                                    <label class="fr-label" for="username-1757">
                                                        Identifiant
                                                        <span class="fr-hint-text">Format attendu : nom@domaine.fr</span>
                                                    </label>
                                                    <input class="fr-input" autocomplete="username" aria-required="true" aria-describedby="username-1757-messages" name="username" id="username-1757" type="text" value="user_test">
                                                    <div class="fr-messages-group" id="username-1757-messages" aria-live="assertive">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="fr-fieldset__element">
                                                <div class="fr-password" id="password-1758">
                                                    <label class="fr-label" for="password-1758-input">
                                                        Mot de passe
                                                    </label>
                                                    <div class="fr-input-wrap">
                                                        <input class="fr-password__input fr-input" aria-describedby="password-1758-input-messages" aria-required="true" name="password" autocomplete="current-password" id="password-1758-input" type="password" value="password">
                                                    </div>
                                                    <div class="fr-messages-group" id="password-1758-input-messages" aria-live="assertive">
                                                    </div>
                                                    <div class="fr-password__checkbox fr-checkbox-group fr-checkbox-group--sm">
                                                        <input aria-label="Afficher le mot de passe" id="password-1758-show" type="checkbox" aria-describedby="password-1758-show-messages">
                                                        <label class="fr-password__checkbox fr-label" for="password-1758-show">
                                                            Afficher
                                                        </label>
                                                        <div class="fr-messages-group" id="password-1758-show-messages" aria-live="assertive">
                                                        </div>
                                                    </div>
                                                    <p>
                                                      <a href="#" class="fr-link" target="_blank" rel="noopener">Mot de passe oubli√© ?</a> 
                                                      
                                                    </p>
                                                </div>
                                            </div>
                                            <div class="fr-messages-group" id="credentials-messages" aria-live="assertive">
                                            </div>
                                        </fieldset>
                                    </div>
                                    <div class="fr-fieldset__element">
                                        <div class="fr-checkbox-group fr-checkbox-group--sm">
                                            <input name="remember" id="remember-1759" type="checkbox" aria-describedby="remember-1759-messages">
                                            <label class="fr-label" for="remember-1759">
                                                Se souvenir de moi
                                            </label>
                                            <div class="fr-messages-group" id="remember-1759-messages" aria-live="assertive">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="fr-fieldset__element">
                                        <ul class="fr-btns-group">
                                            <li>
                                                reactiver se connecter dsfr -->
                                                <!--  <button class="fr-mt-2v fr-btn" href="login.html">
                                                <button class="fr-btn" id="login-button-redirect">
                                                    Se connecter
                                                </button>
                                            </li>
                                        </ul>
                                    </div>
                                    <div class="fr-messages-group" id="login-1760-fieldset-messages" aria-live="assertive">
                                    </div>
                                </fieldset>
                            </form>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </dialog>
    -->
    <!-- END Modal login  -->
    <!--  -->

        <!--  -->
    <!-- Modal Backup Restore DSFR -->
    <!--  -->
    <dialog class="fr-modal" id="fr-modal-backup-restore" aria-labelledby="fr-modal-backup-restore-title">
        <div class="fr-container fr-container--fluid fr-container-md">
            <div class="fr-grid-row fr-grid-row--center">
                <div class="fr-col-12 fr-col-md-8 fr-col-lg-6">
                    <div class="fr-modal__body">
                        <div class="fr-modal__header">
                            <button class="fr-link--close fr-link" aria-controls="fr-modal-backup-restore">Fermer</button>
                        </div>
                        <div class="fr-modal__content">
                            <h1 id="fr-modal-backup-restore-title" class="fr-modal__title">
                                <span class="fr-fi-save-line fr-fi--lg"></span>
                                Restaurer une sauvegarde
                            </h1>
                            <p>Choisissez une sauvegarde √† restaurer :</p>
                            <div id="backup-list-container">
                                <!-- contenu g√©n√©r√© dynamiquement par JavaScript -->
                            </div>
                        </div>
                        <div class="fr-modal__footer">
                            <ul class="fr-btns-group fr-btns-group--right fr-btns-group--inline-reverse fr-btns-group--inline-lg">
                                <li>
                                    <button class="fr-btn fr-btn--secondary" aria-controls="fr-modal-backup-restore">Annuler</button>
                                </li>
                                <li>
                                    <button class="fr-btn fr-btn--secondary fr-btn--icon-left fr-icon-delete-line" onclick="window.controlPointsBackup?.clearAllBackupsSafely()">Vider toutes les sauvegardes</button>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </dialog>
    <!--  -->
    <!-- END Modal Backup Restore  -->
    <!--  -->

    <!-- Script en version es6 module et nomodule pour les navigateurs le ne supportant pas -->
    <script type="module" src="node_modules/@gouvfr/dsfr/dist/dsfr.module.min.js"></script>
    <script type="text/javascript" nomodule src="node_modules/@gouvfr/dsfr/dist/dsfr.nomodule.min.js"></script>
    <script type="module" src="node_modules/@gouvfr/dsfr/dist/core/core.module.min.js"></script>
    <!-- internal -->
    <script src="js/version.js"></script>
    <script src="js/clonelayers.js"></script>
    <script src="js/init.js"></script>
    <!-- <script src="js/simple-layout.js"></script> -->
    <script src="js/advanced-input-system.js"></script>
    <script src="js/map_interactions.js"></script>
    <script src="js/front_interactions.js"></script>
    <script src="js/api_interactions.js"></script>
    <script src="js/gallica_interactions.js"></script>
    <script src="js/getParamAtStartup.js"></script>
    <!-- Syst√®me d'authentification PTM (avec support JWT anonyme) -->
    <script src="js/ptm-auth.js"></script>
    <script src="js/form-generator.js"></script>
    <script src="js/settings-manager.js"></script>
    <script src="js/settings-utils.js"></script>
    <script src="js/cartoquete-manager.js"></script>
    <script src="js/worked-maps-manager.js"></script>
    <script src="js/anonymous-user-manager.js"></script>
    <script src="js/georef-capability-checker.js"></script>
    <script src="js/banner-cleanup.js"></script>
    <script src="js/control-points-backup.js"></script>
    <script src="js/api_health.js"></script>
    <script src="js/auto-status-correction.js"></script>
    <script src="js/status-monitor.js"></script>
    <script src="js/fix-empty-status.js"></script>
    <script src="js/diagnose-georeferenced-status.js"></script>
    <script src="js/nakala_test_deposit.js?v=20251002"></script>
    <!-- Scripts de debug disponibles si n√©cessaires: debug-status-update.js, status-fixer.js, fix-empty-status-guide.js -->

    <script>
    // =======================================================
    // INITIALISATION GLOBALE DES MODULES
    // =======================================================
    
    // Variable globale pour suivre l'√©tat d'initialisation
    let settingsFormInitialized = false;

    // Fonction pour g√©rer l'importation de param√®tres
    function handleSettingsImport(input) {
        const file = input.files[0];
        if (file) {
            window.settingsManager.importSettings(file);
            input.value = ''; // Reset l'input
        }
    }

    // Fonction pour initialiser le formulaire de param√®tres
    async function initSettingsForm() {
        if (settingsFormInitialized) {
            return; // D√©j√† initialis√©
        }

        try {
            await window.settingsManager.init('settings-form-container');
            settingsFormInitialized = true;
        } catch (error) {
            console.error('Erreur initialisation formulaire param√®tres:', error);
            
            // Afficher un message d'erreur √† l'utilisateur
            const container = document.getElementById('settings-form-container');
            if (container) {
                container.innerHTML = `
                    <div class="fr-alert fr-alert--error">
                        <p><strong>Erreur de chargement</strong></p>
                        <p>Impossible de charger la configuration des param√®tres. Veuillez rafra√Æchir la page.</p>
                        <button class="fr-btn fr-btn--sm fr-mt-2w" onclick="location.reload()">
                            Rafra√Æchir la page
                        </button>
                    </div>
                `;
            }
        }
    }

    // Observer pour d√©tecter l'ouverture de la modale des param√®tres
    function setupModalObserver() {
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                const modal = document.getElementById('fr-modal-settings');
                if (modal && modal.open && !settingsFormInitialized) {
                    // La modale est ouverte et le formulaire n'est pas encore initialis√©
                    initSettingsForm();
                }
            });
        });

        // Observer les changements sur la modale
        const modal = document.getElementById('fr-modal-settings');
        if (modal) {
            observer.observe(modal, { 
                attributes: true, 
                attributeFilter: ['open'] 
            });
        }

        // Observer aussi les clics sur l'onglet param√®tres
        const parametresTab = document.getElementById('tabpanel-parametres');
        if (parametresTab) {
            parametresTab.addEventListener('click', function() {
                // Petite temporisation pour laisser l'onglet s'afficher
                setTimeout(initSettingsForm, 100);
            });
        }

        // Observer les clics sur l'onglet "Mes cartes" pour charger les favoris
        const cartesTab = document.getElementById('tabpanel-cartes');
        if (cartesTab) {
            cartesTab.addEventListener('click', function() {
                // Charger les favoris Cartoquete si l'utilisateur est connect√©
                if (window.ptmAuth && window.ptmAuth.isAuthenticated()) {
                    setTimeout(loadCartoqueteFavorites, 100);
                }
            });
        }
    }

    // √âcouter les changements de param√®tres pour mettre √† jour l'application
    function setupSettingsListener() {
        document.addEventListener('settingsUpdated', function(event) {
            const settings = event.detail.settings;
            
            // Appliquer les nouveaux param√®tres
            // (La logique m√©tier n'a pas besoin de logs verbeux)
            
            // Afficher une notification de succ√®s
            showNotification('Param√®tres mis √† jour avec succ√®s', 'success');
        });

        // √âcouter les √©v√©nements de chargement de param√®tres
        document.addEventListener('settingsLoaded', function(event) {
            const { settings, source } = event.detail;
            
            let message = '';
            switch(source) {
                case 'cloud':
                    message = 'Param√®tres charg√©s depuis le serveur';
                    break;
                case 'cloud-reconnect':
                    message = 'Param√®tres synchronis√©s apr√®s connexion';
                    break;
                case 'local':
                    message = 'Param√®tres locaux charg√©s';
                    break;
                case 'default':
                    message = 'Param√®tres par d√©faut appliqu√©s';
                    break;
                default:
                    message = 'Param√®tres charg√©s';
            }
            
            if (source === 'cloud' || source === 'cloud-reconnect') {
                showNotification(message, 'success');
            }
        });
    }

    // Fonction utilitaire pour afficher des notifications
    function showNotification(message, type = 'info') {
        // Cr√©er une notification DSFR temporaire
        const notification = document.createElement('div');
        notification.className = `fr-notice fr-notice--${type === 'success' ? 'info' : type}`;
        notification.innerHTML = `
            <div class="fr-container">
                <div class="fr-notice__body">
                    <p class="fr-notice__title">${message}</p>
                </div>
            </div>
        `;
        
        // Ajouter la notification en haut de la page
        document.body.insertBefore(notification, document.body.firstChild);
        
        // Supprimer apr√®s 3 secondes
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 3000);
    }

    // Fonction pour r√©cup√©rer un param√®tre (utilitaire pour le reste de l'application)
    function getAppSetting(key, defaultValue = null) {
        if (window.settingsManager) {
            return window.settingsManager.getSetting(key, defaultValue);
        }
        return defaultValue;
    }

    // Fonction pour configurer les listeners de sauvegarde
    function setupBackupListeners() {
        // √âcouter les √©v√©nements de sauvegarde
        document.addEventListener('controlPointsBackupSaved', function(event) {
            const backup = event.detail.backup;
            updateBackupStatus(`üíæ Sauvegard√© ${new Date(backup.timestamp).toLocaleTimeString('fr-FR')}`);
            
            // Afficher bri√®vement l'indicateur
            showBackupIndicator();
        });

        // √âcouter les √©v√©nements de restauration
        document.addEventListener('controlPointsBackupRestored', function(event) {
            const backup = event.detail.backup;
            updateBackupStatus(`üìÅ Restaur√© ${new Date(backup.timestamp).toLocaleTimeString('fr-FR')}`);
            
            // Afficher bri√®vement l'indicateur
            showBackupIndicator();
        });

        // √âcouter les changements de points de contr√¥le pour mettre √† jour l'√©tat
        document.addEventListener('controlPointsChanged', function(event) {
            const details = event.detail;
            
            if (details.action === 'reset') {
                updateBackupStatus('üíæ Sauvegarde automatique active');
            } else if (details.completePairs > 0) {
                updateBackupStatus(`üíæ Auto-sauvegarde (${details.completePairs} paires)`);
            } else {
                updateBackupStatus('üíæ Sauvegarde automatique active');
            }
        });

        // V√©rifier p√©riodiquement l'√©tat de sauvegarde
        setInterval(updateBackupButtonsState, 5000);
        
        // Initialiser l'√©tat
        updateBackupButtonsState();
    }

    // Fonction pour mettre √† jour l'√©tat des boutons de sauvegarde
    function updateBackupButtonsState() {
        const saveBtn = document.getElementById('btn_save_backup');
        const restoreBtn = document.getElementById('btn_restore_backup');
        
        if (saveBtn) {
            // Le bouton est activ√© s'il y a des points OU une emprise
            const hasPoints = window.pointPairs && window.pointPairs.length > 0;
            const hasEmprise = (window.currentPolygon && window.currentPolygon.points && window.currentPolygon.points.length > 0) || 
                              (window.list_points_polygon_crop && window.list_points_polygon_crop.length > 0);
            const hasData = hasPoints || hasEmprise;
            
            saveBtn.disabled = !hasData;
            saveBtn.style.opacity = hasData ? '1' : '0.5';
            
            // Mettre √† jour le titre du bouton
            if (hasPoints && hasEmprise) {
                saveBtn.title = 'Sauvegarder les points de contr√¥le et l\'emprise';
            } else if (hasPoints) {
                saveBtn.title = 'Sauvegarder les points de contr√¥le';
            } else if (hasEmprise) {
                saveBtn.title = 'Sauvegarder l\'emprise';
            } else {
                saveBtn.title = 'Aucune donn√©e √† sauvegarder';
            }
        }
        
        if (restoreBtn && window.controlPointsBackup) {
            // Le bouton est activ√© si une carte est charg√©e (ARK d√©fini)
            const isEnabled = window.controlPointsBackup.isRestoreButtonEnabled();
            const hasBackups = window.controlPointsBackup.hasBackupsAvailable();
            
            restoreBtn.disabled = !isEnabled;
            restoreBtn.style.opacity = isEnabled ? '1' : '0.5';
            
            if (!isEnabled) {
                restoreBtn.title = 'Chargez d\'abord une carte Gallica';
            } else if (hasBackups) {
                restoreBtn.title = 'Restaurer des points de contr√¥le sauvegard√©s';
            } else {
                restoreBtn.title = 'Voir les sauvegardes (aucune disponible pour cette carte)';
            }
        }
    }

    // Rendre la fonction accessible globalement
    window.updateBackupButtonsState = updateBackupButtonsState;

    // Fonction pour mettre √† jour le statut de sauvegarde
    function updateBackupStatus(message) {
        const statusElement = document.getElementById('backup-status');
        if (statusElement) {
            statusElement.textContent = message;
        }
    }

    // Fonction pour afficher temporairement l'indicateur de sauvegarde
    function showBackupIndicator() {
        const container = document.getElementById('backup-status-container');
        if (container) {
            container.style.display = 'block';
            
            // Masquer apr√®s 3 secondes
            setTimeout(() => {
                container.style.display = 'none';
            }, 3000);
        }
    }

    document.addEventListener('DOMContentLoaded', async () => {
        // V√©rifier si l'utilisateur revient d'une authentification (token dans l'URL)
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token') || urlParams.get('access_token');
        
        if (token) {
            console.log('Token d√©tect√© dans l\'URL, configuration de l\'authentification...');
            window.ptmAuth.setToken(token);
            
            // Nettoyer l'URL
            window.history.replaceState({}, document.title, window.location.pathname);
            
            // Charger les param√®tres utilisateur automatiquement
            if (window.settingsManager) {
                await window.settingsManager.reloadSettingsAfterLogin();
            }
        }
        
        // V√©rifier l'√©tat d'authentification au chargement de la page
        try {
            const isAuthenticated = window.ptmAuth.isAuthenticated();
            
            if (isAuthenticated) {
                console.log('‚úÖ Utilisateur authentifi√© avec ORCID');
                // Mettre √† jour l'interface utilisateur pour afficher les informations de connexion
                await updateUIForAuthenticatedUser();
                
                // Charger automatiquement les param√®tres depuis le serveur (si pas d√©j√† fait)
                if (window.settingsManager && !token) {
                    await window.settingsManager.reloadSettingsAfterLogin();
                }
                
                // Mettre √† jour l'√©tat des boutons pour un utilisateur connect√©
                if (typeof updateButtonsForAuth === 'function') {
                    updateButtonsForAuth();
                }
            } else {
                console.log('‚ÑπÔ∏è Mode anonyme (non authentifi√©)');
                
                // Mettre √† jour l'√©tat des boutons pour un utilisateur non connect√©
                if (typeof updateButtonsForAuth === 'function') {
                    updateButtonsForAuth();
                }
            }
        } catch (error) {
            console.error('‚ùå Erreur lors de la v√©rification de l\'authentification:', error);
            console.log('Utilisateur consid√©r√© comme non authentifi√©');
            
            // Mettre √† jour l'√©tat des boutons pour un utilisateur non connect√©
            if (typeof updateButtonsForAuth === 'function') {
                updateButtonsForAuth();
            }
        }
        
        // V√©rifier l'√©tat d'authentification avec l'ancienne fonction si elle existe
        if (typeof checkAuthStatus === 'function') {
            checkAuthStatus();
        }
        
        // Configurer l'observateur de modale et les listeners
        setupModalObserver();
        setupSettingsListener();
        setupBackupListeners();
        
        const loginButton = document.getElementById('login-button-redirect');
        if (loginButton) {
            loginButton.addEventListener('click', (e) => {
                e.preventDefault(); // emp√™che un submit par d√©faut
                // Optionnel : fermer la modale proprement avant de rediriger
                const modal = document.getElementById('fr-modal-login');
                if (modal && typeof modal.close === 'function') {
                    modal.close();
                }
                // Redirection
                window.location.href = 'login.html';
            });
        }
    });

    // Fonction pour mettre √† jour l'UI quand l'utilisateur est connect√©
    async function updateUIForAuthenticatedUser() {
        try {
            // R√©cup√©rer le profil complet depuis l'API
            let userProfile = null;
            
            try {
                userProfile = await window.ptmAuth.getUserProfile();
                console.log('üë§ Profil utilisateur complet depuis API:', userProfile);
            } catch (error) {
                console.warn('‚ö†Ô∏è Impossible de r√©cup√©rer le profil API, fallback sur token JWT:', error.message);
                
                // Fallback : d√©coder le token JWT
                const token = window.ptmAuth.getToken();
                if (token) {
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    userProfile = {
                        first_name: payload.name || '',
                        last_name: '',
                        orcid: payload.sub,
                        email: ''
                    };
                }
            }
            
            if (!userProfile) {
                console.warn('‚ö†Ô∏è Aucun profil utilisateur disponible');
                return;
            }
            
            // Normaliser le profil pour s'assurer que tous les champs n√©cessaires existent
            // Le backend peut retourner 'orcid' ou 'orcid_id', et on peut avoir besoin du 'sub' du JWT
            if (!userProfile.orcid && !userProfile.orcid_id) {
                // Essayer de r√©cup√©rer l'ORCID depuis le token JWT
                try {
                    const token = window.ptmAuth.getToken();
                    if (token) {
                        const payload = JSON.parse(atob(token.split('.')[1]));
                        userProfile.orcid = userProfile.orcid || payload.sub;
                    }
                } catch (e) {
                    console.warn('‚ö†Ô∏è Impossible de r√©cup√©rer l\'ORCID depuis le token JWT');
                }
            }
            
            // S'assurer que userProfile.orcid existe (mapper orcid_id vers orcid si n√©cessaire)
            userProfile.orcid = userProfile.orcid || userProfile.orcid_id;
            
            console.log('üë§ Profil normalis√©:', userProfile);
            
            // Mettre √† jour le menu utilisateur si il existe
            if (typeof updateUserMenu === 'function') {
                updateUserMenu(userProfile);
            }
            
            // Mettre √† jour les informations de profil dans la modale
            if (typeof updateProfileInfo === 'function') {
                updateProfileInfo(userProfile);
            }
            
            // Charger les favoris Cartoquete
            if (typeof loadCartoqueteFavorites === 'function') {
                await loadCartoqueteFavorites();
            }
            
        } catch (error) {
            console.error('‚ùå Erreur lors de la mise √† jour de l\'interface utilisateur:', error);
        }
    }
    // Fonction pour charger les favoris Cartoquete et les cartes travaill√©es
    async function loadCartoqueteFavorites() {
        try {
            console.log('Chargement des favoris Cartoquete et des cartes travaill√©es...');
            
            // Afficher la section des favoris
            const favoritesSection = document.getElementById('cartoquete-favorites-section');
            const statusMessage = document.getElementById('cartoquete-status-message');
            
            if (favoritesSection) {
                favoritesSection.style.display = 'block';
            }
            
            if (statusMessage) {
                statusMessage.textContent = 'Chargement des favoris Cartoquete et cartes travaill√©es...';
            }
            
            // Charger et afficher les favoris Cartoquete
            await window.cartoqueteManager.displayFavorites();
            
            // Charger et afficher les cartes travaill√©es
            if (window.workedMapsManager) {
                await window.workedMapsManager.displayWorkedMaps();
            }
            
            // Mettre √† jour le message de statut
            const favorites = window.cartoqueteManager.favorites;
            const workedMaps = window.workedMapsManager ? window.workedMapsManager.workedMaps : [];
            
            if (statusMessage) {
                let message = '';
                
                if (favorites && favorites.length > 0) {
                    message += `Vous avez <strong>${favorites.length} favori(s) Cartoquete</strong>`;
                }
                
                if (workedMaps && workedMaps.length > 0) {
                    if (message) message += ' et ';
                    message += `<strong>${workedMaps.length} carte(s) travaill√©e(s)</strong>`;
                }
                
                if (message) {
                    message += '. Les exemples de cartes ci-dessous sont fournis √† titre illustratif.';
                } else {
                    message = 'Aucun favori Cartoquete ou carte travaill√©e trouv√©. Ajoutez des cartes √† vos favoris sur <strong>Cartoquete</strong> ou commencez √† g√©or√©f√©rencer une carte pour les voir appara√Ætre ici.';
                }
                
                statusMessage.innerHTML = message;
            }
            
        } catch (error) {
            console.error('Erreur lors du chargement des favoris Cartoquete:', error);
            
            const statusMessage = document.getElementById('cartoquete-status-message');
            if (statusMessage) {
                statusMessage.innerHTML = 'Erreur lors du chargement des favoris Cartoquete.';
            }
        }
    }

    // Fonction pour mettre √† jour le menu utilisateur
    function updateUserMenu(userProfile) {
        // Remplacer le bouton de connexion par un menu utilisateur
        const loginButton = document.querySelector('button[onclick*="auth/login"]');
        if (loginButton) {
            const userMenuHtml = `
                <button class="fr-btn fr-icon-account-circle-line user-menu-toggle" 
                        data-fr-opened="false" 
                        aria-controls="fr-modal-settings"
                        onclick="document.getElementById('fr-modal-settings').showModal()">
                    ${userProfile.first_name} ${userProfile.last_name}
                </button>
            `;
            loginButton.parentElement.innerHTML = userMenuHtml;
        }
        
        // S'assurer que le bouton "Cartes g√©or√©f√©renc√©es" est toujours pr√©sent
        if (typeof ensureCartesGeoreferenceesBoutonPresent === 'function') {
            ensureCartesGeoreferenceesBoutonPresent();
        }
    }

    // Fonction pour mettre √† jour les informations de profil
    function updateProfileInfo(userProfile) {
        console.log('üîç updateProfileInfo appel√©e avec:', userProfile);
        console.log('üîç userProfile.orcid:', userProfile.orcid);
        console.log('üîç userProfile.orcid_id:', userProfile.orcid_id);
        console.log('üîç Toutes les cl√©s du profil:', Object.keys(userProfile));
        
        const fields = {
            'user-first-name': userProfile.first_name,
            'user-last-name': userProfile.last_name,
            'user-email': userProfile.email,
            'user-orcid': userProfile.orcid || userProfile.orcid_id || userProfile.sub,
            'user-institution': userProfile.institution || 'Non renseign√©'
        };

        Object.entries(fields).forEach(([id, value]) => {
            const element = document.getElementById(id);
            if (element) {
                console.log(`üìù Mise √† jour de ${id} avec:`, value);
                element.textContent = value || 'Non renseign√©';
            } else {
                console.warn(`‚ö†Ô∏è √âl√©ment ${id} non trouv√© dans le DOM`);
            }
        });
    }

    // Fonction pour g√©rer l'√©tat des boutons segment√©s selon le toggle
    function toggleSegmentedButtons() {
        const toggleInput = document.getElementById('toggle');
        const segmentedElements = document.querySelectorAll('.fr-segmented__element input, .fr-segmented__element label');
        const fieldset = document.querySelector('.fr-segmented');
        
        if (toggleInput.checked) {
            // Toggle activ√© (Verrouill√©) - d√©sactiver les boutons segment√©s
            segmentedElements.forEach(element => {
                if (element.tagName === 'INPUT') {
                    element.disabled = true;
                } else if (element.tagName === 'LABEL') {
                    element.style.opacity = '0.5';
                    element.style.cursor = 'not-allowed';
                }
            });
            fieldset.style.opacity = '0.5';
        } else {
            // Toggle d√©sactiv√© (Saisie) - activer les boutons segment√©s
            segmentedElements.forEach(element => {
                if (element.tagName === 'INPUT') {
                    element.disabled = false;
                } else if (element.tagName === 'LABEL') {
                    element.style.opacity = '1';
                    element.style.cursor = 'pointer';
                }
            });
            fieldset.style.opacity = '1';
        }
    }

    // Initialiser l'√©tat des boutons segment√©s au chargement de la page
    function initializeSegmentedButtonsState() {
        const toggleInput = document.getElementById('toggle');
        
        // √âcouter les changements du toggle
        toggleInput.addEventListener('change', toggleSegmentedButtons);
        
        // D√©finir l'√©tat initial (toggle d√©sactiv√© par d√©faut = boutons activ√©s)
        toggleSegmentedButtons();
        
        // Attendre que le syst√®me de saisie soit pr√™t
        if (typeof setupAdvancedInputSystem === 'function') {
            // Le syst√®me est d√©j√† initialis√© dans map_interactions.js
            console.log('Syst√®me de saisie avanc√© disponible');
        }
    }
    </script>

    <script>
        // Initialiser l'√©tat des boutons segment√©s d√®s que le DOM est charg√©
        document.addEventListener('DOMContentLoaded', function() {
            initializeSegmentedButtonsState();
            
            // Initialiser l'affichage de version
            initializeVersionDisplay();
            
            // Ajouter des messages d'aide contextuelle
            addInputHelpMessages();
        });
        
        // Fonction pour ajouter des messages d'aide
        function addInputHelpMessages() {
            const statusContainer = document.getElementById('input-status-container');
            if (statusContainer) {
                const helpDiv = document.createElement('div');
                helpDiv.className = 'input-help-message';
                helpDiv.id = 'input-help';
                helpDiv.textContent = 'Activez la saisie et s√©lectionnez le mode pour commencer';
                statusContainer.appendChild(helpDiv);
            }
        }
        
        // Fonction pour initialiser l'affichage de version dans le footer
        function initializeVersionDisplay() {
            const versionDisplay = document.getElementById('version-display');
            const versionDetails = document.getElementById('version-details');
            const versionBuild = document.getElementById('version-build');
            const versionCommit = document.getElementById('version-commit');
            const versionDate = document.getElementById('version-date');
            
            if (!versionDisplay) return;
            
            // Attendre que les informations de version soient disponibles
            function updateVersionInfo() {
                if (window.APP_VERSION) {
                    const version = window.APP_VERSION;
                    
                    // Version simple pour l'affichage normal
                    versionDisplay.textContent = version.shortDisplayVersion;
                    versionDisplay.style.cursor = 'pointer';
                    versionDisplay.title = 'Cliquer pour plus d\'informations';
                    
                    // D√©tails pour l'affichage √©tendu
                    if (versionBuild) {
                        versionBuild.textContent = ` ‚Ä¢ Build ${version.buildNumber}`;
                    }
                    if (versionCommit) {
                        versionCommit.textContent = ` ‚Ä¢ ${version.git.hash}`;
                    }
                    if (versionDate) {
                        const buildDate = new Date(version.build.timestamp);
                        versionDate.textContent = ` ‚Ä¢ ${buildDate.toLocaleDateString('fr-FR')}`;
                    }
                    
                    // Ajouter l'interaction pour afficher/masquer les d√©tails
                    let detailsVisible = false;
                    versionDisplay.addEventListener('click', function() {
                        detailsVisible = !detailsVisible;
                        
                        if (detailsVisible) {
                            versionDisplay.textContent = version.displayVersion;
                            if (versionDetails) versionDetails.style.display = 'inline';
                            versionDisplay.title = 'Cliquer pour r√©duire';
                        } else {
                            versionDisplay.textContent = version.shortDisplayVersion;
                            if (versionDetails) versionDetails.style.display = 'none';
                            versionDisplay.title = 'Cliquer pour plus d\'informations';
                        }
                    });
                    
                    // Double-clic pour afficher toutes les informations dans la console
                    versionDisplay.addEventListener('dblclick', function() {
                        if (window.showVersionInfo) {
                            window.showVersionInfo();
                        }
                    });
                    
                } else {
                    // R√©essayer dans 100ms si les informations ne sont pas encore disponibles
                    setTimeout(updateVersionInfo, 100);
                }
            }
            
            updateVersionInfo();
        }
    </script>

    <script>
    // === GESTION DES ATLAS ===
    
    // Fonction pour r√©cup√©rer les atlas de l'utilisateur depuis l'API
    async function loadUserAtlas() {
        console.log('üì¶ Chargement des atlas de l\'utilisateur...');
        
        const container = document.getElementById('atlas-list-container');
        const statusMessage = document.getElementById('atlas-status-message');
        const loadingDiv = document.getElementById('atlas-loading');
        
        try {
            // V√©rifier l'authentification
            const token = window.ptmAuth.getToken();
            if (!token) {
                console.warn('‚ö†Ô∏è Utilisateur non authentifi√©');
                if (loadingDiv) loadingDiv.style.display = 'none';
                container.innerHTML = `
                    <div class="fr-alert fr-alert--warning">
                        <p class="fr-text--sm">
                            <span class="fr-icon-warning-line fr-mr-1w" aria-hidden="true"></span>
                            Vous devez √™tre connect√© pour voir vos atlas.
                        </p>
                    </div>
                `;
                if (statusMessage) statusMessage.textContent = 'Connectez-vous pour voir vos atlas.';
                return;
            }
            
            // R√©cup√©rer le profil pour obtenir l'ORCID
            const profile = await window.ptmAuth.getUserProfile();
            const orcidId = profile?.orcid || profile?.orcid_id || profile?.sub;
            
            if (!orcidId) {
                throw new Error('Impossible de r√©cup√©rer l\'identifiant ORCID');
            }
            
            console.log('üîë ORCID ID:', orcidId);
            
            // Appeler l'API pour r√©cup√©rer les atlas de l'utilisateur
            const response = await fetch(`https://api.ptm.huma-num.fr/auth/app/galligeo/atlas?owner=${encodeURIComponent(orcidId)}&include_private=true`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            console.log('üì° R√©ponse API atlas:', response.status, response.statusText);
            
            if (!response.ok) {
                if (response.status === 401) {
                    throw new Error('Session expir√©e. Veuillez vous reconnecter.');
                }
                throw new Error(`Erreur ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            console.log('‚úÖ Atlas re√ßus:', data);
            
            // Afficher les atlas
            displayAtlasList(data.atlas || data || []);
            
            if (statusMessage) {
                const count = (data.atlas || data || []).length;
                statusMessage.textContent = count > 0 
                    ? `${count} atlas trouv√©${count > 1 ? 's' : ''}.` 
                    : 'Aucun atlas pour le moment.';
            }
            
        } catch (error) {
            console.error('‚ùå Erreur lors du chargement des atlas:', error);
            
            if (loadingDiv) loadingDiv.style.display = 'none';
            container.innerHTML = `
                <div class="fr-alert fr-alert--error">
                    <p class="fr-text--sm">
                        <span class="fr-icon-error-line fr-mr-1w" aria-hidden="true"></span>
                        ${error.message || 'Erreur lors du chargement des atlas.'}
                    </p>
                </div>
            `;
            
            if (statusMessage) statusMessage.textContent = 'Erreur de chargement.';
        }
    }
    
    // Fonction pour afficher la liste des atlas
    function displayAtlasList(atlasList) {
        console.log('üñºÔ∏è Affichage de', atlasList.length, 'atlas');
        
        const container = document.getElementById('atlas-list-container');
        const loadingDiv = document.getElementById('atlas-loading');
        
        // Masquer le message de chargement
        if (loadingDiv) loadingDiv.style.display = 'none';
        
        // Si aucun atlas
        if (!atlasList || atlasList.length === 0) {
            container.innerHTML = `
                <div class="fr-alert fr-alert--info">
                    <p class="fr-text--sm">
                        <span class="fr-icon-information-line fr-mr-1w" aria-hidden="true"></span>
                        Vous n'avez pas encore cr√©√© d'atlas. Rendez-vous dans la <a href="galerie/index.html">galerie</a> pour s√©lectionner des cartes et cr√©er votre premier atlas !
                    </p>
                </div>
            `;
            return;
        }
        
        // G√©n√©rer la liste HTML des atlas
        const atlasListHTML = atlasList.map(atlas => {
            const displayMode = atlas.display_mode || 'diachronique';
            const isPublic = atlas.is_public !== false;
            const createdDate = atlas.created_at ? new Date(atlas.created_at).toLocaleDateString('fr-FR') : 'N/A';
            const mapCount = atlas.ark_ids ? atlas.ark_ids.length : 0;
            
            // Nettoyer l'URL : extraire juste le slug si c'est une URL compl√®te
            let atlasSlug = atlas.url || '';
            if (atlasSlug.includes('://')) {
                atlasSlug = atlasSlug.split('/').filter(Boolean).pop();
            }
            
            // Ic√¥ne selon le mode
            const modeIcon = displayMode === 'voisinage' 
                ? '<span class="fr-icon-layout-grid-line" aria-hidden="true"></span>' 
                : '<span class="fr-icon-time-line" aria-hidden="true"></span>';
            
            // Badge de statut
            const statusBadge = isPublic 
                ? '<span class="fr-badge fr-badge--success fr-badge--sm">Public</span>'
                : '<span class="fr-badge fr-badge--warning fr-badge--sm">Priv√©</span>';
            
            return `
                <div class="fr-card fr-card--horizontal fr-card--sm fr-mb-2w" data-atlas-id="${atlas.id}">
                    <div class="fr-card__body">
                        <div class="fr-card__content">
                            <h4 class="fr-card__title">
                                ${modeIcon}
                                <a href="atlas/?slug=${encodeURIComponent(atlasSlug)}" class="fr-card__link" target="_blank">
                                    ${atlas.name || 'Sans titre'}
                                </a>
                            </h4>
                            <p class="fr-card__desc fr-text--sm">
                                <strong>Type :</strong> ${displayMode === 'voisinage' ? 'Voisinage' : 'Diachronique'}
                                <br>
                                <strong>Cartes :</strong> ${mapCount} carte${mapCount > 1 ? 's' : ''}
                                <br>
                                <strong>Cr√©√© le :</strong> ${createdDate}
                            </p>
                            <div class="fr-card__footer" style="display: flex; justify-content: space-between; align-items: center; gap: 0.5rem;">
                                <div>${statusBadge}</div>
                                <div style="display: flex; gap: 0.5rem;">
                                    <a href="atlas/?slug=${encodeURIComponent(atlasSlug)}" 
                                       class="fr-btn fr-btn--sm fr-btn--secondary fr-icon-eye-line"
                                       title="Voir l'atlas"
                                       target="_blank">
                                        Voir
                                    </a>
                                    <button class="fr-btn fr-btn--sm fr-btn--tertiary-no-outline fr-icon-delete-line" 
                                            onclick="confirmDeleteAtlas('${atlas.id}', \`${atlas.name}\`)"
                                            title="Supprimer cet atlas"
                                            aria-label="Supprimer l'atlas ${atlas.name}">
                                        Supprimer
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="fr-card__header">
                        <div class="fr-card__img" style="background-color: #f5f5f5; display: flex; align-items: center; justify-content: center; min-height: 100px;">
                            <span class="fr-icon-map-2-fill" style="font-size: 3rem; color: #ccc;" aria-hidden="true"></span>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
        container.innerHTML = atlasListHTML;
    }
    
    // Fonction pour confirmer la suppression d'un atlas
    function confirmDeleteAtlas(atlasId, atlasName) {
        console.log('üóëÔ∏è Demande de suppression atlas:', atlasId, atlasName);
        
        const confirmed = confirm(
            `√ätes-vous s√ªr de vouloir supprimer l'atlas "${atlasName}" ?\n\n` +
            `Cette action est irr√©versible.`
        );
        
        if (confirmed) {
            deleteAtlas(atlasId, atlasName);
        } else {
            console.log('‚ùå Suppression annul√©e par l\'utilisateur');
        }
    }
    
    // Fonction pour supprimer un atlas
    async function deleteAtlas(atlasId, atlasName) {
        console.log('üóëÔ∏è Suppression de l\'atlas:', atlasId);
        
        try {
            const token = window.ptmAuth.getToken();
            if (!token) {
                alert('Vous devez √™tre connect√© pour supprimer un atlas.');
                return;
            }
            
            // Afficher un indicateur de chargement
            const atlasCard = document.querySelector(`[data-atlas-id="${atlasId}"]`);
            if (atlasCard) {
                atlasCard.style.opacity = '0.5';
                atlasCard.style.pointerEvents = 'none';
                
                const deleteButton = atlasCard.querySelector('.fr-btn--tertiary-no-outline');
                if (deleteButton) {
                    deleteButton.innerHTML = '<span class="fr-icon-refresh-line fr-mr-1w" aria-hidden="true"></span>Suppression...';
                    deleteButton.disabled = true;
                }
            }
            
            // Appeler l'API DELETE
            const response = await fetch(`https://api.ptm.huma-num.fr/auth/app/galligeo/atlas/${atlasId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            console.log('üì° R√©ponse API suppression:', response.status, response.statusText);
            
            if (!response.ok) {
                if (response.status === 401) {
                    throw new Error('Session expir√©e. Veuillez vous reconnecter.');
                } else if (response.status === 403) {
                    throw new Error('Vous n\'avez pas les droits pour supprimer cet atlas.');
                } else if (response.status === 404) {
                    throw new Error('Atlas introuvable.');
                }
                
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.message || `Erreur ${response.status}: ${response.statusText}`);
            }
            
            console.log('‚úÖ Atlas supprim√© avec succ√®s');
            
            // Animer la suppression
            if (atlasCard) {
                atlasCard.style.transition = 'all 0.3s ease-out';
                atlasCard.style.transform = 'translateX(-100%)';
                atlasCard.style.opacity = '0';
                
                setTimeout(() => {
                    atlasCard.remove();
                    
                    // V√©rifier s'il reste des atlas
                    const container = document.getElementById('atlas-list-container');
                    const remainingCards = container.querySelectorAll('[data-atlas-id]');
                    
                    if (remainingCards.length === 0) {
                        container.innerHTML = `
                            <div class="fr-alert fr-alert--info">
                                <p class="fr-text--sm">
                                    <span class="fr-icon-information-line fr-mr-1w" aria-hidden="true"></span>
                                    Vous n'avez pas encore cr√©√© d'atlas. Rendez-vous dans la <a href="galerie/index.html">galerie</a> pour s√©lectionner des cartes et cr√©er votre premier atlas !
                                </p>
                            </div>
                        `;
                    }
                    
                    const statusMessage = document.getElementById('atlas-status-message');
                    if (statusMessage) {
                        const count = remainingCards.length;
                        statusMessage.textContent = count > 0 
                            ? `${count} atlas trouv√©${count > 1 ? 's' : ''}.` 
                            : 'Aucun atlas pour le moment.';
                    }
                    
                    showAtlasNotification('success', `L'atlas "${atlasName}" a √©t√© supprim√© avec succ√®s.`);
                }, 300);
            }
            
        } catch (error) {
            console.error('‚ùå Erreur lors de la suppression:', error);
            
            // Restaurer la carte en cas d'erreur
            const atlasCard = document.querySelector(`[data-atlas-id="${atlasId}"]`);
            if (atlasCard) {
                atlasCard.style.opacity = '1';
                atlasCard.style.pointerEvents = 'auto';
                
                const deleteButton = atlasCard.querySelector('.fr-btn--tertiary-no-outline');
                if (deleteButton) {
                    deleteButton.innerHTML = '<span class="fr-icon-delete-line" aria-hidden="true"></span>Supprimer';
                    deleteButton.disabled = false;
                }
            }
            
            showAtlasNotification('error', error.message || 'Erreur lors de la suppression de l\'atlas.');
        }
    }
    
    // Fonction pour afficher une notification temporaire
    function showAtlasNotification(type, message) {
        const container = document.getElementById('atlas-list-container');
        
        const alertType = type === 'success' ? 'fr-alert--success' : 'fr-alert--error';
        const iconType = type === 'success' ? 'fr-icon-checkbox-circle-line' : 'fr-icon-error-line';
        
        const notification = document.createElement('div');
        notification.className = `fr-alert ${alertType} fr-mb-2w`;
        notification.innerHTML = `
            <p class="fr-text--sm">
                <span class="${iconType} fr-mr-1w" aria-hidden="true"></span>
                ${message}
            </p>
        `;
        
        container.insertBefore(notification, container.firstChild);
        
        setTimeout(() => {
            notification.style.transition = 'opacity 0.3s ease-out';
            notification.style.opacity = '0';
            setTimeout(() => notification.remove(), 300);
        }, 5000);
    }
    
    // Exposer les fonctions globalement
    window.loadUserAtlas = loadUserAtlas;
    window.confirmDeleteAtlas = confirmDeleteAtlas;
    window.deleteAtlas = deleteAtlas;
    
    // Observer l'ouverture de l'onglet atlas dans la modale
    document.addEventListener('DOMContentLoaded', function() {
        const atlasTab = document.getElementById('tabpanel-atlas');
        if (atlasTab) {
            atlasTab.addEventListener('click', function() {
                console.log('üìã Onglet Atlas activ√© - chargement des atlas');
                setTimeout(() => loadUserAtlas(), 100);
            });
        }
    });
    
    // === FIN GESTION DES ATLAS ===
    </script>

    <!-- Matomo -->
    <script>
    var _paq = window._paq = window._paq || [];
    /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
    _paq.push(['trackPageView']);
    _paq.push(['enableLinkTracking']);
    (function() {
        var u="//ptm.huma-num.fr/matomo/";
        _paq.push(['setTrackerUrl', u+'matomo.php']);
        _paq.push(['setSiteId', '23']);
        var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
        g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
    })();
    </script>
    <!-- End Matomo Code -->

  </body>
</html>