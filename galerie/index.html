<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="../node_modules/@gouvfr/dsfr/dist/dsfr.min.css">
    <link rel="stylesheet" href="../node_modules/@gouvfr/dsfr/dist/component/form/form.min.css">
    <link rel="stylesheet" href="../node_modules/@gouvfr/dsfr/dist/component/table/table.min.css">
    <link rel="stylesheet" href="../node_modules/@gouvfr/dsfr/dist/component/segmented/segmented.min.css">
    <link href="../node_modules/@gouvfr/dsfr/dist/core/core.min.css" rel="stylesheet">
    <link href="../node_modules/@gouvfr/dsfr/dist/component/link/link.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../node_modules/@gouvfr/dsfr/dist/utility/icons/icons.min.css">

    <meta name="theme-color" content="#000091">

    <!-- Favicon -->
    <link rel="apple-touch-icon" href="../img/favicon.png">
    <link rel="icon" href="../img/favicon.png" type="image/png">
    <title>Cartes géoréférencées - Galligeo</title>

    <!-- CSS interne -->
    <link rel="stylesheet" href="../css/main.css"/>

    <style>
        /* Layout avec header et footer fixes */
        html {
            height: 100%;
        }
        
        body {
            margin: 0;
            height: 100vh;
            overflow: hidden; /* Pas de scroll sur le body */
            display: flex;
            flex-direction: column;
        }
        
        /* Header fixe */
        .fr-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* Barre de sélection sticky sous le header */
        .selection-toolbar {
            position: fixed;
            top: 80px; /* Hauteur approximative du header */
            left: 0;
            right: 0;
            background: #000091;
            color: white;
            padding: 1rem 0;
            z-index: 999;
            border-bottom: 2px solid #e5e5e5;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* Zone de contenu scrollable */
        .main-content-wrapper {
            flex: 1;
            overflow-y: auto;
            padding-top: 80px; /* Espace pour le header fixe */
            padding-bottom: 120px; /* Espace pour le footer fixe */
        }
        
        /* Ajustement quand la barre de sélection est visible */
        .main-content-wrapper.with-selection-toolbar {
            padding-top: 140px; /* Header + barre de sélection */
        }
        
        /* Scrollbar personnalisée */
        .main-content-wrapper::-webkit-scrollbar {
            width: 8px;
        }
        
        .main-content-wrapper::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        .main-content-wrapper::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        
        .main-content-wrapper::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Système de sélection */
        .selection-bar {
            background: #f6f6f6;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 2rem;
            display: none; /* Masqué par défaut */
        }

        .selection-bar.active {
            display: block;
        }

        .selection-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .selection-count {
            font-weight: bold;
            color: #000091;
        }

        .selection-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .atlas-button {
            background: #000091;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.3s ease;
        }

        .atlas-button:hover:not(:disabled) {
            background: #1212ff;
        }

        .atlas-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* Cartes sélectionnables */
        .map-card {
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .map-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .map-card.selected {
            border: 2px solid #000091;
            box-shadow: 0 0 0 2px rgba(0, 0, 145, 0.2);
        }

        .map-card .selection-checkbox {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 2;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 4px;
            padding: 4px;
        }

        /* Lignes de tableau sélectionnables */
        .table-row {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .table-row:hover {
            background-color: rgba(0, 0, 145, 0.1);
        }

        .table-row.selected {
            background-color: rgba(0, 0, 145, 0.2);
        }
        
        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            padding: 2rem 0;
            background: #f6f6f6;
            text-align: center;
            z-index: 998;
            box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
        }
        
        .search-container {
            margin-bottom: 2rem;
        }
        
        .view-toggle-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        
        .cards-container {
            padding-right: 10px; /* Espace pour éviter le débordement */
            padding: 1rem;
        }
        
        .cards-container.hidden {
            display: none !important;
        }
        
        .table-container {
            padding: 1rem;
        }
        
        .table-container.hidden {
            display: none !important;
        }
        
        /* Style de la scrollbar principale */
        body::-webkit-scrollbar {
            width: 10px;
        }
        
        body::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        body::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 5px;
        }
        
        body::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }
        
        .card-image {
            height: 200px;
            object-fit: cover;
        }
        
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 300px;
        }
        
        .error-message {
            text-align: center;
            padding: 2rem;
        }
        
        .pagination-container {
            margin-top: 2rem;
            text-align: center;
        }
        
        .stats-container {
            margin-bottom: 1rem;
            padding: 1rem;
            background: #f6f6f6;
            border-radius: 4px;
        }
        
        .filter-container {
            margin-bottom: 2rem;
        }
        
        .footer-logo {
            margin: 0 0.5rem;
        }
        
        .heart-icon {
            width: 16px;
            height: 16px;
            color: #e74c3c;
        }
        
        .version-info {
            font-size: 0.85em;
            color: #666;
        }
        
        /* Système de sélection */
        .selection-toolbar {
            position: sticky;
            top: 0;
            background: #000091;
            color: white;
            padding: 1rem 0;
            z-index: 1000;
            border-bottom: 2px solid #e5e5e5;
        }
        
        .toolbar-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .selection-count {
            font-weight: bold;
        }
        
        .toolbar-actions {
            display: flex;
            gap: 1rem;
        }
        
        .selectable-card {
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }
        
        .selectable-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .selectable-card.selected {
            border: 3px solid #000091;
            background: #f5f5fe;
        }
        
        .selectable-card.selected::after {
            content: "✓";
            position: absolute;
            top: 10px;
            right: 10px;
            background: #000091;
            color: white;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .selectable-item.selected {
            background: #f5f5fe;
        }
        
        /* Classe pour forcer le repaint */
        .force-repaint {
            transform: translateZ(0);
        }
    </style>
  </head>
  <body>

    <!--  -->
    <!-- HEADER -->
    <!--  -->
    <header role="banner" class="fr-header">
        <div class="fr-header__body">
            <div class="fr-container--fluid">
                <div class="fr-header__body-row">
                    <div class="fr-header__brand fr-enlarge-link" style="margin-left: 24px;">
                        <div class="fr-header__brand-top">
                            <div class="fr-header__logo">
                            </div>
                            <div class="fr-header__operator">
                                <a href="../index.html" title="Retour à l'accueil - Galligeo">
                                    <img class="fr-responsive-img" style="width:auto; height:70px; margin-left: -32px;" src="../img/logo_galligeo.png" alt="Galligeo" >
                                </a>
                            </div>
                            <div class="fr-header__navbar">
                                <button class="fr-btn--search fr-btn" data-fr-opened="false" aria-controls="modal-575" id="button-576" title="Rechercher">
                                    Rechercher
                                </button>
                                <button class="fr-btn--menu fr-btn" data-fr-opened="false" aria-controls="modal-577" aria-haspopup="menu" id="button-578" title="Menu">
                                    Menu
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="fr-header__tools">
                        <div class="fr-header__tools-links">
                            <ul class="fr-btns-group">
                                <li>
                                    <a class="fr-btn fr-icon-home-4-line" href="../index.html" style="color:#000091;">
                                        Accueil
                                    </a>
                                </li>
                                <li id="auth-button-container">
                                    <button class="fr-btn fr-icon-lock-line" href="#" style="color:#ff5555;" onclick="window.location.href='https://api.ptm.huma-num.fr/auth/login?redirect_url=https://app.ptm.huma-num.fr/galligeo/galerie/'">
                                        Se connecter avec ORCID
                                    </button>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="fr-header__menu fr-modal" id="modal-560" aria-labelledby="button-561" style="display:none;visibility: hidden;">
            <div class="fr-container">
                <button class="fr-btn--close fr-btn" aria-controls="modal-560" title="Fermer">
                    Fermer
                </button>
                <div class="fr-header__menu-links">
                </div>
                <nav class="fr-nav" id="navigation-564" role="navigation" aria-label="Menu principal">
                    <ul class="fr-nav__list">
                        <li class="fr-nav__item">
                            <a class="fr-nav__link" href="../index.html" target="_self">Galligeo</a>
                        </li>
                        <li class="fr-nav__item">
                            <a class="fr-nav__link" href="../cartes-georeferencees.html" target="_self">Cartes géoréférencées</a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <!-- Barre de sélection sticky -->
    <div id="selection-toolbar" class="selection-toolbar" style="display: none;">
        <div class="fr-container">
            <div class="toolbar-content">
                <span class="selection-count">
                    <span id="selected-count">0</span> carte(s) sélectionnée(s)
                </span>
                <div class="toolbar-actions">
                    <button class="fr-btn fr-btn--sm fr-btn--secondary" onclick="clearSelection()">
                        Tout désélectionner
                    </button>
                    <button class="fr-btn fr-btn--sm" onclick="createAtlas()">
                        <span class="fr-icon-map-2-line fr-mr-1w" aria-hidden="true"></span>
                        Créer un atlas
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Zone de contenu scrollable englobante -->
    <div class="main-content-wrapper" id="mainContentWrapper">
        <!-- Container principal pour le contenu -->
        <div class="fr-container fr-py-4w main-content">

            <!-- Titre de la page -->
            <div class="fr-grid-row fr-grid-row--center">
                <div class="fr-col-12">
                    <h1 class="fr-h1 fr-mb-4w">
                        <span class="fr-icon-map-2-fill fr-mr-2w" aria-hidden="true"></span>
                        Cartes géoréférencées par la communauté
                    </h1>
                    
                    <p class="fr-text--lg fr-mb-4w">
                        Découvrez les cartes historiques géoréférencées par les utilisateurs de Galligeo. 
                        Ces cartes proviennent des collections de <a href="https://gallica.bnf.fr" target="_blank" rel="noopener">Gallica (BnF)</a> 
                        et ont été géolocalisées avec précision par notre communauté.
                    </p>
                </div>
            </div>

        <!-- Statistiques -->
        <div class="fr-grid-row fr-grid-row--center fr-mb-4w">
            <div class="fr-col-12">
                <div class="stats-container">
                    <div class="fr-grid-row fr-grid-row--gutters">
                        <div class="fr-col-md-4 fr-col-12">
                            <div class="fr-card fr-card--no-border">
                                <div class="fr-card__body">
                                    <div class="fr-card__content">
                                        <h3 class="fr-card__title" id="total-count">
                                            <span class="fr-icon-loader-line" aria-hidden="true"></span>
                                            Chargement...
                                        </h3>
                                        <p class="fr-card__desc">Cartes géoréférencées</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="fr-col-md-4 fr-col-12">
                            <div class="fr-card fr-card--no-border">
                                <div class="fr-card__body">
                                    <div class="fr-card__content">
                                        <h3 class="fr-card__title" id="contributors-count">
                                            <span class="fr-icon-loader-line" aria-hidden="true"></span>
                                            Chargement...
                                        </h3>
                                        <p class="fr-card__desc">Contributeurs</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="fr-col-md-4 fr-col-12">
                            <div class="fr-card fr-card--no-border">
                                <div class="fr-card__body">
                                    <div class="fr-card__content">
                                        <h3 class="fr-card__title" id="recent-count">
                                            <span class="fr-icon-loader-line" aria-hidden="true"></span>
                                            Chargement...
                                        </h3>
                                        <p class="fr-card__desc">Ce mois-ci</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Barre de recherche -->
        <div class="fr-grid-row fr-grid-row--center">
            <div class="fr-col-12 fr-col-lg-8">
                <div class="search-container">
                    <div class="fr-search-bar" id="search-bar">
                        <label class="fr-label" for="search-input">
                            Rechercher dans les cartes géoréférencées
                        </label>
                        <input class="fr-input" 
                               placeholder="Entrez un titre, lieu, créateur, date..." 
                               type="search" 
                               id="search-input" 
                               name="search-input">
                        <button class="fr-btn" title="Rechercher" id="search-button">
                            Rechercher
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Zone de sélection et création d'atlas -->
        <div class="fr-grid-row fr-grid-row--center">
            <div class="fr-col-12">
                <div class="selection-bar" id="selection-bar">
                    <div class="selection-info">
                        <div>
                            <span class="selection-count" id="selection-count">0 carte(s) sélectionnée(s)</span>
                            <span class="fr-text--sm fr-ml-2w">Sélectionnez au moins 2 cartes pour créer un atlas</span>
                        </div>
                        <div class="selection-actions">
                            <button type="button" class="fr-btn fr-btn--secondary fr-btn--sm" onclick="clearAllSelections()">
                                <span class="fr-icon-close-line fr-mr-1w" aria-hidden="true"></span>
                                Tout désélectionner
                            </button>
                            <button type="button" class="atlas-button" id="atlas-button" onclick="createAtlas()" disabled>
                                <span class="fr-icon-map-2-line fr-mr-1w" aria-hidden="true"></span>
                                Créer un atlas
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtres et options d'affichage -->
        <div class="fr-grid-row fr-grid-row--center">
            <div class="fr-col-12">
                <div class="view-toggle-container">
                    <div class="filter-container">
                        <fieldset class="fr-fieldset fr-fieldset--inline">
                            <legend class="fr-fieldset__legend">
                                Filtrer par période :
                            </legend>
                            <div class="fr-fieldset__content">
                                <div class="fr-select-group">
                                    <label class="fr-label" for="period-filter">Période</label>
                                    <select class="fr-select" id="period-filter" name="period-filter">
                                        <option value="">Toutes les périodes</option>
                                        <option value="moyen-age">Moyen Âge</option>
                                        <option value="renaissance">Renaissance (XVe-XVIe s.)</option>
                                        <option value="moderne">Époque moderne (XVIIe-XVIIIe s.)</option>
                                        <option value="19e">XIXe siècle</option>
                                        <option value="20e">XXe siècle</option>
                                    </select>
                                </div>
                            </div>
                        </fieldset>
                    </div>
                    
                    <div class="view-toggle">
                        <fieldset class="fr-segmented fr-segmented--no-legend">
                            <legend class="fr-segmented__legend fr-segmented__legend--inline">
                                Affichage
                            </legend>
                            <div class="fr-segmented__elements">
                                <div class="fr-segmented__element">
                                    <input value="cards" checked type="radio" id="view-cards" name="view-mode">
                                    <label class="fr-label" for="view-cards">
                                        <span class="fr-icon-grid-fill" aria-hidden="true"></span>
                                        Cartes
                                    </label>
                                </div>
                                <div class="fr-segmented__element">
                                    <input value="table" type="radio" id="view-table" name="view-mode">
                                    <label class="fr-label" for="view-table">
                                        <span class="fr-icon-table-line" aria-hidden="true"></span>
                                        Tableau
                                    </label>
                                </div>
                            </div>
                        </fieldset>
                    </div>
                </div>
            </div>
        </div>

        <!-- Résultats -->
        <div class="fr-grid-row fr-grid-row--center">
            <div class="fr-col-12">
                
                <!-- Affichage en cartes -->
                <div id="cards-container" class="cards-container">
                    <div class="fr-grid-row fr-grid-row--gutters" id="cards-grid">
                        <!-- Loading initial -->
                        <div class="fr-col-12">
                            <div class="loading-spinner">
                                <div class="fr-card fr-card--no-border">
                                    <div class="fr-card__body">
                                        <div class="fr-card__content">
                                            <p class="fr-text--lg">
                                                <span class="fr-icon-loader-line fr-mr-2w" aria-hidden="true"></span>
                                                Chargement des cartes géoréférencées...
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Affichage en tableau -->
                <div id="table-container" class="table-container hidden">
                    <div class="fr-table fr-table--lg">
                        <table id="maps-table">
                            <caption>Liste des cartes géoréférencées</caption>
                            <thead>
                                <tr>
                                    <th scope="col">
                                        <input type="checkbox" id="select-all" class="fr-checkbox-input" onchange="toggleSelectAll(this)">
                                        <label for="select-all" class="fr-checkbox-label">Titre</label>
                                    </th>
                                    <th scope="col">Attribution</th>
                                    <th scope="col">Identifiant</th>
                                    <th scope="col">Géoréférencé par</th>
                                    <th scope="col">Géoréférencé le</th>
                                    <th scope="col">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="table-body">
                                <!-- Le contenu sera généré dynamiquement -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Pagination -->
                <div class="pagination-container">
                    <nav role="navigation" class="fr-pagination" aria-label="Pagination navigation" id="pagination-nav" style="display: none;">
                        <ul class="fr-pagination__list">
                            <!-- La pagination sera générée dynamiquement -->
                        </ul>
                    </nav>
                </div>

            </div>
        </div>

    </div>
    <!-- END Container principal -->
    
    </div>
    <!-- END Zone de contenu scrollable -->

    <!--  -->
    <!-- FOOTER -->
    <!--  -->
    <footer class="footer">
        <p>Made with
            <svg class="heart-icon" aria-hidden="true" focusable="false" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                <path fill="currentColor" d="M462.3 62.6C407.5 15.9 326 24.3 275.7 76.2L256 96.5l-19.7-20.3C186.1 24.3 104.5 15.9 49.7 62.6c-62.8 53.6-66.1 149.8-9.9 207.9l193.5 199.8c12.5 12.9 32.8 12.9 45.3 0l193.5-199.8c56.3-58.1 53-154.3-9.8-207.9z">
                </path>
            </svg>
            &nbsp by <img class="fr-responsive-img footer-logo" style="width:auto; height:28px; cursor: pointer;" src="../img/logo_ptm_small.png" alt="PTM" onclick="openExternalLink('https://ptm.huma-num.fr/')" title="Projets Time Machine">
            
           <img class="fr-responsive-img footer-logo" style="width:auto; height:16px; cursor: pointer;" src="../img/logo_hn.png" alt="Huma-Num" onclick="openExternalLink('https://www.huma-num.fr/')" title="Huma-Num">
           &nbsp;+&nbsp;
           <img class="fr-responsive-img footer-logo" style="width:auto; height:16px; cursor: pointer;" src="../img/logo_bnf_datalab.png" alt="BnF / Datalab" onclick="openExternalLink('https://www.bnf.fr/fr/bnf-datalab')" title="BnF / Datalab">
           &nbsp;—&nbsp;
           <span style="cursor: pointer; text-decoration: underline;" onclick="openExternalLink('https://github.com/paristimemachine/galligeo-front')" title="Code & Documentation">Code &amp; Documentation</span>
           &nbsp;—
           <span id="app-version-info" class="version-info" style="opacity: 0.7; font-size: 0.85em; color: #666;">
               <span id="version-display">Chargement...</span>
           </span>
        </p>
    </footer>
    <!--  -->
    <!-- END FOOTER -->
    <!--  -->

    <!-- Scripts DSFR -->
    <script type="module" src="../node_modules/@gouvfr/dsfr/dist/dsfr.module.min.js"></script>
    <script type="text/javascript" nomodule src="../node_modules/@gouvfr/dsfr/dist/dsfr.nomodule.min.js"></script>
    <script type="module" src="../node_modules/@gouvfr/dsfr/dist/core/core.module.min.js"></script>

    <!-- Scripts de l'application -->
    <script src="../js/version.js"></script>
    <script src="../js/ptm-auth.js"></script>
    <script src="../js/cartes-georeferencees.js"></script>

    <script>
        function openExternalLink(url) {
            window.open(url, '_blank', 'noopener,noreferrer');
        }

        // Variables globales pour la sélection
        let selectedMaps = new Set();

        // Fonctions de sélection
        function toggleMapSelection(arkId, element) {
            if (selectedMaps.has(arkId)) {
                selectedMaps.delete(arkId);
                element.classList.remove('selected');
            } else {
                selectedMaps.add(arkId);
                element.classList.add('selected');
            }
            updateSelectionUI();
        }

        function toggleSelectAll(checkbox) {
            const allCheckboxes = document.querySelectorAll('.selectable-item input[type="checkbox"]');
            const allCards = document.querySelectorAll('.selectable-card');
            
            if (checkbox.checked) {
                // Sélectionner tout
                allCheckboxes.forEach(cb => {
                    cb.checked = true;
                    const arkId = cb.dataset.arkId;
                    if (arkId) selectedMaps.add(arkId);
                });
                allCards.forEach(card => {
                    const arkId = card.dataset.arkId;
                    if (arkId) {
                        selectedMaps.add(arkId);
                        card.classList.add('selected');
                    }
                });
            } else {
                // Désélectionner tout
                clearSelection();
            }
            updateSelectionUI();
        }

        function clearSelection() {
            selectedMaps.clear();
            document.querySelectorAll('.selectable-item input[type="checkbox"]').forEach(cb => cb.checked = false);
            document.querySelectorAll('.selectable-card.selected').forEach(card => card.classList.remove('selected'));
            document.getElementById('select-all').checked = false;
            updateSelectionUI();
        }

        function updateSelectionUI() {
            const count = selectedMaps.size;
            const toolbar = document.getElementById('selection-toolbar');
            const countElement = document.getElementById('selected-count');
            const mainWrapper = document.getElementById('mainContentWrapper');
            
            if (count > 0) {
                toolbar.style.display = 'block';
                countElement.textContent = count;
                mainWrapper.classList.add('with-selection-toolbar');
            } else {
                toolbar.style.display = 'none';
                mainWrapper.classList.remove('with-selection-toolbar');
            }
        }

        function createAtlas() {
            if (selectedMaps.size === 0) {
                alert('Veuillez sélectionner au moins une carte.');
                return;
            }
            
            const selectedArray = Array.from(selectedMaps);
            console.log('Création d\'un atlas avec les cartes:', selectedArray);
            
            // TODO: Implémenter la création d'atlas
            alert(`Atlas créé avec ${selectedArray.length} carte(s). Cette fonctionnalité sera bientôt disponible !`);
        }

        // Initialisation de la page
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('Initialisation de la page des cartes géoréférencées');
            
            // Vérifier l'authentification au chargement
            await checkAuthenticationStatus();
            
            // Charger le contenu réel depuis l'API
            await loadRealContent();
            
            // Attendre que le contenu soit bien inséré, puis initialiser les vues
            setTimeout(() => {
                // Initialiser le basculement de vue
                initializeViewToggle();
                
                // Initialiser la recherche et le filtrage
                initializeSearchAndFilter();
                
                // S'assurer que la vue cartes est visible par défaut
                const cardsContainer = document.getElementById('cards-container');
                const tableContainer = document.getElementById('table-container');
                if (cardsContainer && tableContainer) {
                    cardsContainer.classList.remove('hidden');
                    tableContainer.classList.add('hidden');
                    
                    // Vérifier que le contenu est bien présent
                    const cardsContent = cardsContainer.innerHTML;
                    const tableContent = tableContainer.querySelector('tbody')?.innerHTML;
                }
            }, 1000);
            
            // Initialiser l'affichage de version
            initializeVersionDisplay();
        });

        // === SYSTÈME DE SÉLECTION ===
        
        // Fonction pour synchroniser les sélections entre les vues
        function syncSelectionBetweenViews(arkId, isSelected) {
            // Synchroniser la checkbox du tableau
            const tableCheckbox = document.querySelector(`#table-body input[data-ark-id="${arkId}"]`);
            if (tableCheckbox) {
                tableCheckbox.checked = isSelected;
            }
            
            // Synchroniser la checkbox des cartes
            const cardCheckbox = document.querySelector(`#cards-grid input[data-ark-id="${arkId}"]`);
            if (cardCheckbox) {
                cardCheckbox.checked = isSelected;
            }
            
            // Synchroniser la classe selected sur la carte
            const mapCard = document.querySelector(`.map-card[data-ark-id="${arkId}"]`);
            if (mapCard) {
                if (isSelected) {
                    mapCard.classList.add('selected');
                } else {
                    mapCard.classList.remove('selected');
                }
            }
            
            // Synchroniser la classe selected sur la ligne
            const tableRow = document.querySelector(`#table-body .table-row[data-ark-id="${arkId}"]`);
            if (tableRow) {
                if (isSelected) {
                    tableRow.classList.add('selected');
                } else {
                    tableRow.classList.remove('selected');
                }
            }
        }

        // Fonction améliorée pour basculer la sélection d'une carte
        function toggleMapSelection(arkId, element) {
            const isCurrentlySelected = selectedMaps.has(arkId);
            const newSelectionState = !isCurrentlySelected;
            
            if (newSelectionState) {
                selectedMaps.add(arkId);
            } else {
                selectedMaps.delete(arkId);
            }
            
            // Synchroniser dans toutes les vues
            syncSelectionBetweenViews(arkId, newSelectionState);
            
            updateSelectionUI();
        }

        // Fonction pour tout sélectionner/désélectionner (checkbox "select-all")
        function toggleSelectAll(selectAllCheckbox) {
            const allCheckboxes = document.querySelectorAll('input[data-ark-id]');
            const allCards = document.querySelectorAll('[data-ark-id].map-card');
            const allRows = document.querySelectorAll('[data-ark-id].table-row');
            
            if (selectAllCheckbox.checked) {
                // Sélectionner tout
                allCheckboxes.forEach(cb => {
                    cb.checked = true;
                    const arkId = cb.dataset.arkId;
                    if (arkId) selectedMaps.add(arkId);
                });
                allCards.forEach(card => {
                    const arkId = card.dataset.arkId;
                    if (arkId) {
                        selectedMaps.add(arkId);
                        card.classList.add('selected');
                    }
                });
                allRows.forEach(row => {
                    const arkId = row.dataset.arkId;
                    if (arkId) {
                        selectedMaps.add(arkId);
                        row.classList.add('selected');
                    }
                });
            } else {
                // Désélectionner tout
                clearAllSelections();
            }
            updateSelectionUI();
        }

        function clearAllSelections() {
            // Vider le Set de sélections
            const previouslySelected = Array.from(selectedMaps);
            selectedMaps.clear();
            
            // Synchroniser chaque élément précédemment sélectionné
            previouslySelected.forEach(arkId => {
                syncSelectionBetweenViews(arkId, false);
            });
            
            // Décocher le select-all
            const selectAllCheckbox = document.getElementById('select-all');
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = false;
            }
            
            updateSelectionUI();
        }

        function updateSelectionUI() {
            const count = selectedMaps.size;
            const selectionBar = document.getElementById('selection-bar');
            const selectionCount = document.getElementById('selection-count');
            const atlasButton = document.getElementById('atlas-button');
            
            // Mettre à jour le texte de comptage
            selectionCount.textContent = `${count} carte(s) sélectionnée(s)`;
            
            // Afficher/masquer la barre de sélection
            if (count > 0) {
                selectionBar.classList.add('active');
            } else {
                selectionBar.classList.remove('active');
            }
            
            // Activer/désactiver le bouton atlas (minimum 2 cartes)
            if (count >= 2) {
                atlasButton.disabled = false;
                atlasButton.textContent = 'Créer un atlas';
            } else {
                atlasButton.disabled = true;
                atlasButton.textContent = count === 0 ? 'Créer un atlas' : 'Sélectionnez au moins 2 cartes';
            }
        }

        function createAtlas() {
            if (selectedMaps.size < 2) {
                alert('Veuillez sélectionner au moins 2 cartes pour créer un atlas.');
                return;
            }
            
            const selectedArray = Array.from(selectedMaps);
            console.log('Création d\'un atlas avec les cartes:', selectedArray);
            
            // Récupérer les données des cartes sélectionnées
            const selectedMapsData = realMapsData.filter(map => selectedArray.includes(map.ark));
            
            console.log('Données des cartes sélectionnées:', selectedMapsData);
            
            // TODO: Implémenter la logique de création d'atlas
            const mapsList = selectedMapsData.map(map => 
                `• ${map.ark} (géoréférencé par ${map.georeferenced_by})`
            ).join('\n');
            
            alert(`Atlas à créer avec ${selectedArray.length} cartes :\n\n${mapsList}\n\nFonctionnalité en cours de développement...`);
        }

        // Gestionnaire pour les clics sur les cartes
        function handleCardClick(event, arkId) {
            // Éviter le comportement par défaut si c'est une checkbox
            if (event.target.type === 'checkbox') {
                const card = event.target.closest('.map-card');
                if (card) {
                    toggleMapSelection(arkId, card);
                }
                return;
            }
            
            // Clic sur la carte elle-même
            const card = event.currentTarget;
            toggleMapSelection(arkId, card);
        }

        // Gestionnaire pour les clics sur les lignes du tableau
        function handleRowClick(event, arkId) {
            // Éviter le comportement par défaut si c'est une checkbox
            if (event.target.type === 'checkbox') {
                const row = event.target.closest('.table-row');
                if (row) {
                    toggleMapSelection(arkId, row);
                }
                return;
            }
            
            // Clic sur la ligne elle-même
            const row = event.currentTarget;
            toggleMapSelection(arkId, row);
        }

        // === FIN SYSTÈME DE SÉLECTION ===

        // === GÉNÉRATION DE CONTENU RÉEL ===
        
        // Variable pour stocker les données de l'API
        let realMapsData = [];
        
        // Fonction pour récupérer les cartes géoréférencées depuis l'API PTM
        async function fetchGeoreferencedMaps() {
            try {
                console.log('Récupération des cartes géoréférencées...');
                const response = await fetch('https://api.ptm.huma-num.fr/auth/admin/galligeo/georeferenced-maps-by-users');
                
                if (!response.ok) {
                    throw new Error(`Erreur HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Données reçues de l\'API:', data);
                
                if (data.status === 'ok' && data.users) {
                    // Transformer les données pour notre format
                    realMapsData = [];
                    
                    data.users.forEach(user => {
                        user.georeferenced_maps.forEach(map => {
                            realMapsData.push({
                                ark: map.ark,
                                status: map.status,
                                firstWorked: map.firstWorked,
                                lastUpdated: map.lastUpdated,
                                georeferenced_by: user.full_name || `${user.first_name || ''} ${user.last_name || ''}`.trim() || 'Utilisateur anonyme',
                                georeferenced_date: map.lastUpdated,
                                orcid_id: user.orcid_id
                            });
                        });
                    });
                    
                    console.log('Cartes transformées:', realMapsData.length);
                    return { success: true, data: realMapsData, stats: data };
                } else {
                    throw new Error('Format de données invalide');
                }
                
            } catch (error) {
                console.error('Erreur lors de la récupération des cartes géoréférencées:', error);
                return { success: false, error: error.message };
            }
        }
        
        // Fonction pour générer l'URL de la vignette Gallica IIIF
        function generateGallicaThumbnail(arkId) {
            return `https://gallica.bnf.fr/iiif/ark:/12148/${arkId}/f1/full/300,/0/native.jpg`;
        }
        
        // Fonction pour générer l'URL Gallica (fallback si pas dans manifest)
        function generateGallicaUrl(arkId) {
            return `https://gallica.bnf.fr/ark:/12148/${arkId}`;
        }
        
        // Fonction pour générer l'URL de géoréférencement
        function generateGeoreferenceUrl(arkId) {
            return `https://app.ptm.huma-num.fr/galligeo/georef/?ark=${arkId}`;
        }
        
        // Fonction pour récupérer les métadonnées Gallica via l'API IIIF Manifest
        async function fetchGallicaMetadata(arkId) {
            try {
                const manifestUrl = `https://gallica.bnf.fr/iiif/ark:/12148/${arkId}/manifest.json`;
                console.log(`Récupération des métadonnées pour ${arkId}...`);
                
                const response = await fetch(manifestUrl);
                
                if (!response.ok) {
                    throw new Error(`Erreur Gallica Manifest: ${response.status}`);
                }
                
                const manifest = await response.json();
                console.log(`Manifest récupéré pour ${arkId}:`, manifest);
                
                // Extraction des métadonnées du manifest IIIF
                const title = manifest.description || manifest.label || 'Titre non disponible';
                const gallicaUrl = manifest.related || `https://gallica.bnf.fr/ark:/12148/${arkId}`;
                const attribution = manifest.attribution || '';
                
                // Rechercher la date dans les métadonnées avec logs détaillés
                let date = '';
                console.log(`Métadonnées disponibles pour ${arkId}:`, manifest.metadata);
                
                if (manifest.metadata && Array.isArray(manifest.metadata)) {
                    console.log(`Recherche de date dans ${manifest.metadata.length} éléments de métadonnées`);
                    
                    manifest.metadata.forEach((item, index) => {
                        console.log(`Métadonnée ${index}:`, item);
                        if (item.label && item.label.toLowerCase().includes('date')) {
                            console.log(`Date trouvée dans métadonnée ${index}:`, item.value);
                            date = item.value;
                        }
                    });
                    
                    if (!date) {
                        console.log(`Aucune date trouvée dans les métadonnées pour ${arkId}`);
                        // Essayer d'autres champs
                        const altDateFields = ['created', 'issued', 'published', 'navDate'];
                        for (const field of altDateFields) {
                            if (manifest[field]) {
                                console.log(`Date alternative trouvée dans ${field}:`, manifest[field]);
                                date = manifest[field];
                                break;
                            }
                        }
                    }
                } else {
                    console.log(`Pas de métadonnées ou métadonnées invalides pour ${arkId}`);
                }
                
                // Si toujours pas de date, essayer la navDate
                if (!date && manifest.navDate) {
                    date = manifest.navDate;
                    console.log(`Date récupérée depuis navDate:`, date);
                }
                
                console.log(`Métadonnées finales pour ${arkId}:`, { title, gallicaUrl, date, attribution });
                
                return {
                    title: title,
                    attribution: attribution,
                    gallicaUrl: gallicaUrl,
                    date: date,
                    manifestUrl: manifestUrl
                };
                
            } catch (error) {
                console.warn(`Impossible de récupérer les métadonnées pour ${arkId}:`, error);
                return {
                    title: `Carte ${arkId}`,
                    attribution: 'Bibliothèque nationale de France',
                    gallicaUrl: `https://gallica.bnf.fr/ark:/12148/${arkId}`,
                    date: '',
                    manifestUrl: null
                };
            }
        }
        
        // Fonction pour générer une carte avec les vraies données
        async function generateRealMapCard(mapData) {
            const metadata = await fetchGallicaMetadata(mapData.ark);
            const thumbnailUrl = generateGallicaThumbnail(mapData.ark);
            const gallicaUrl = metadata.gallicaUrl || generateGallicaUrl(mapData.ark);
            const georefUrl = generateGeoreferenceUrl(mapData.ark);
            
            return `
                <div class="fr-col-md-4 fr-col">
                    <div class="fr-card map-card" data-ark-id="${mapData.ark}" data-date="${metadata.date}" onclick="handleCardClick(event, '${mapData.ark}')">
                        <div class="selection-checkbox">
                            <input type="checkbox" 
                                   id="card-${mapData.ark}" 
                                   class="fr-checkbox-input" 
                                   data-ark-id="${mapData.ark}"
                                   onchange="toggleMapSelection('${mapData.ark}', this.closest('.map-card'))">
                            <label for="card-${mapData.ark}" class="fr-checkbox-label"></label>
                        </div>
                        <div class="fr-card__body">
                            <div class="fr-card__content">
                                <h4 class="fr-card__title">
                                    <a href="${gallicaUrl}" target="_blank" rel="noopener">${metadata.title}</a>
                                </h4>
                                <p class="fr-card__desc">${metadata.attribution}${metadata.date ? ` - ${metadata.date}` : ''}</p>
                                <p class="fr-card__desc">
                                    <a href="${gallicaUrl}" target="_blank" rel="noopener">Voir la notice Gallica</a>
                                </p>
                                <p class="fr-card__desc">
                                    <a href="${georefUrl}" target="_blank" rel="noopener">Voir le géoréférencement</a>
                                </p>
                                <div class="fr-card__start">
                                    <ul class="fr-tags-group">
                                        <li><p class="fr-tag fr-tag--green-emeraude">Géoréférencée</p></li>
                                        <li><p class="fr-tag fr-tag--blue-france">Galligeo</p></li>
                                        ${metadata.date ? `<li><p class="fr-tag fr-tag--yellow-tournesol">${metadata.date}</p></li>` : ''}
                                    </ul>
                                    <p class="fr-card__detail fr-icon-map-pin-2-fill">Géoréférencé par ${mapData.georeferenced_by}</p>
                                    <p class="fr-card__detail fr-icon-calendar-line">${new Date(mapData.georeferenced_date).toLocaleDateString('fr-FR')}</p>
                                </div>
                            </div>
                        </div>
                        <div class="fr-card__header">
                            <div class="fr-card__img">
                                <img class="fr-responsive-img" 
                                     src="${thumbnailUrl}" 
                                     alt="${metadata.title}"
                                     onerror="this.parentElement.style.display='none';" />
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Fonction pour générer une ligne de tableau avec les vraies données
        async function generateRealTableRow(mapData) {
            const metadata = await fetchGallicaMetadata(mapData.ark);
            const gallicaUrl = metadata.gallicaUrl || generateGallicaUrl(mapData.ark);
            const georefUrl = generateGeoreferenceUrl(mapData.ark);
            
            return `
                <tr class="table-row" data-ark-id="${mapData.ark}" data-date="${metadata.date}" onclick="handleRowClick(event, '${mapData.ark}')">
                    <td>
                        <input type="checkbox" 
                               id="table-${mapData.ark}" 
                               class="fr-checkbox-input" 
                               data-ark-id="${mapData.ark}"
                               onchange="toggleMapSelection('${mapData.ark}', this.closest('.table-row'))">
                        <label for="table-${mapData.ark}" class="fr-checkbox-label">${metadata.title}</label>
                    </td>
                    <td>${metadata.attribution}</td>
                    <td>${metadata.date || 'Non renseignée'}</td>
                    <td>${mapData.georeferenced_by}</td>
                    <td>${new Date(mapData.georeferenced_date).toLocaleDateString('fr-FR')}</td>
                    <td>
                        <a href="${gallicaUrl}" target="_blank" rel="noopener" class="fr-btn fr-btn--sm fr-btn--secondary fr-mr-1w">
                            Gallica
                        </a>
                        <a href="${georefUrl}" target="_blank" rel="noopener" class="fr-btn fr-btn--sm fr-btn--primary">
                            Géoréf
                        </a>
                    </td>
                </tr>
            `;
        }
        
        // Fonction pour charger le contenu réel depuis l'API
        async function loadRealContent() {
            console.log('Chargement du contenu réel...');
            
            try {
                // Afficher un indicateur de chargement
                const cardsGrid = document.getElementById('cards-grid');
                const tableBody = document.getElementById('table-body');
                
                if (cardsGrid) {
                    cardsGrid.innerHTML = `
                        <div class="fr-col-12">
                            <div class="fr-card fr-card--no-border">
                                <div class="fr-card__body">
                                    <div class="fr-card__content">
                                        <p class="fr-text--lg">
                                            <span class="fr-icon-loader-line fr-mr-2w" aria-hidden="true"></span>
                                            Chargement des cartes géoréférencées...
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // Récupérer les données de l'API
                const apiResult = await fetchGeoreferencedMaps();
                
                if (!apiResult.success) {
                    throw new Error(apiResult.error);
                }
                
                // Générer les cartes et lignes de tableau
                console.log('Génération du contenu pour', realMapsData.length, 'cartes...');
                
                const cardsPromises = realMapsData.map(mapData => generateRealMapCard(mapData));
                const rowsPromises = realMapsData.map(mapData => generateRealTableRow(mapData));
                
                console.log('Attente de la génération des cartes et lignes...');
                const [cardsHTML, rowsHTML] = await Promise.all([
                    Promise.all(cardsPromises),
                    Promise.all(rowsPromises)
                ]);
                
                console.log('HTML généré - Cartes:', cardsHTML.length, 'Lignes:', rowsHTML.length);
                
                // Mettre à jour l'affichage
                if (cardsGrid) {
                    cardsGrid.innerHTML = cardsHTML.join('');
                    console.log('Cartes insérées dans le DOM. Contenu:', cardsGrid.innerHTML.length > 100 ? 'OK' : 'VIDE');
                    
                    // Sauvegarder immédiatement le contenu des cartes
                    cardsHTMLContent = cardsGrid.innerHTML;
                    console.log('Contenu cartes sauvegardé automatiquement');
                } else {
                    console.error('cards-grid non trouvé');
                }
                
                if (tableBody) {
                    tableBody.innerHTML = rowsHTML.join('');
                    console.log('Lignes insérées dans le DOM. Contenu:', tableBody.innerHTML.length > 100 ? 'OK' : 'VIDE');
                    
                    // Sauvegarder immédiatement le contenu du tableau
                    tableHTMLContent = tableBody.innerHTML;
                    console.log('Contenu tableau sauvegardé automatiquement');
                } else {
                    console.error('table-body non trouvé');
                }
                
                // Mettre à jour les statistiques avec les vraies données
                const stats = apiResult.stats;
                const totalCount = document.getElementById('total-count');
                if (totalCount) {
                    totalCount.innerHTML = `
                        <span class="fr-icon-map-2-fill" aria-hidden="true"></span>
                        ${stats.total_georeferenced_maps}
                    `;
                }
                
                const contributorsCount = document.getElementById('contributors-count');
                if (contributorsCount) {
                    contributorsCount.innerHTML = `
                        <span class="fr-icon-account-circle-fill" aria-hidden="true"></span>
                        ${stats.total_users_with_georeferenced_maps}
                    `;
                }
                
                const recentCount = document.getElementById('recent-count');
                if (recentCount) {
                    const oneMonthAgo = new Date(Date.now() - 30*24*60*60*1000);
                    const recentMaps = realMapsData.filter(m => new Date(m.georeferenced_date) > oneMonthAgo);
                    recentCount.innerHTML = `
                        <span class="fr-icon-calendar-fill" aria-hidden="true"></span>
                        ${recentMaps.length}
                    `;
                }
                
                console.log('Contenu réel chargé avec succès');
                
                // Vérifier le contenu généré
                console.log('=== VÉRIFICATION DU CONTENU ===');
                console.log('Cartes dans le DOM:', document.querySelectorAll('.map-card').length);
                console.log('Lignes dans le DOM:', document.querySelectorAll('#table-body tr').length);
                
                // Réinitialiser la recherche et le filtrage après chargement du contenu
                setTimeout(() => {
                    resetElementsCache();  // Réinitialiser les caches
                    updateFilterableElements();
                    console.log('Éléments filtrables mis à jour après chargement');
                }, 100);
                
                // Ne plus appeler initializeViewToggle ici pour éviter la double initialisation
                // L'initialisation est déjà faite dans DOMContentLoaded
                
            } catch (error) {
                console.error('Erreur lors du chargement du contenu réel:', error);
                
                // Afficher un message d'erreur
                const cardsGrid = document.getElementById('cards-grid');
                if (cardsGrid) {
                    cardsGrid.innerHTML = `
                        <div class="fr-col-12">
                            <div class="fr-alert fr-alert--error">
                                <p><strong>Erreur de chargement</strong></p>
                                <p>Impossible de charger les cartes géoréférencées. Veuillez réessayer plus tard.</p>
                                <p class="fr-text--xs">Détail : ${error.message}</p>
                            </div>
                        </div>
                    `;
                }
            }
        }

        // === FIN GÉNÉRATION DE CONTENU RÉEL ===

        // === GESTION DES VUES - VERSION SIMPLIFIÉE ===
        
        // Variables globales pour stocker le contenu
        let cardsHTMLContent = '';
        let tableHTMLContent = '';
        let currentView = 'cards';
        
        // Fonction pour forcer la sauvegarde (debug uniquement)
        function forceSaveContent() {
            const cardsGrid = document.getElementById('cards-grid');
            const tableBody = document.getElementById('table-body');
            
            if (cardsGrid && cardsGrid.innerHTML.length > 1000) {
                cardsHTMLContent = cardsGrid.innerHTML;
                console.log('Contenu cartes forcé sauvegardé:', cardsHTMLContent.length, 'caractères');
            }
            
            if (tableBody && tableBody.innerHTML.length > 100) {
                tableHTMLContent = tableBody.innerHTML;
                console.log('Contenu tableau forcé sauvegardé:', tableHTMLContent.length, 'caractères');
            }
        }
        
        // Fonction simplifiée pour basculer entre vue cartes et tableau
        function switchView(viewMode) {
            console.log('=== SWITCH VIEW ===', viewMode);
            
            const cardsContainer = document.getElementById('cards-container');
            const tableContainer = document.getElementById('table-container');
            const cardsRadio = document.getElementById('view-cards');
            const tableRadio = document.getElementById('view-table');
            
            if (!cardsContainer || !tableContainer) {
                console.error('Conteneurs non trouvés');
                return;
            }
            
            // Ne PAS sauvegarder ici - utiliser uniquement le contenu sauvegardé au chargement
            console.log('Utilisation du contenu sauvegardé - Cartes:', cardsHTMLContent.length, 'caractères');
            console.log('Utilisation du contenu sauvegardé - Tableau:', tableHTMLContent.length, 'caractères');
            
            // Basculer l'affichage
            if (viewMode === 'cards') {
                cardsContainer.classList.remove('hidden');
                tableContainer.classList.add('hidden');
                if (cardsRadio) cardsRadio.checked = true;
                currentView = 'cards';
                console.log('Vue cartes activée');
                
                // Restaurer le contenu des cartes
                const cardsGrid = document.getElementById('cards-grid');
                if (cardsGrid && cardsHTMLContent) {
                    cardsGrid.innerHTML = cardsHTMLContent;
                    console.log('Contenu cartes restauré depuis la sauvegarde');
                }
                
            } else if (viewMode === 'table') {
                cardsContainer.classList.add('hidden');
                tableContainer.classList.remove('hidden');
                if (tableRadio) tableRadio.checked = true;
                currentView = 'table';
                console.log('Vue tableau activée');
                
                // Restaurer le contenu du tableau
                const tableBody = document.getElementById('table-body');
                if (tableBody && tableHTMLContent) {
                    tableBody.innerHTML = tableHTMLContent;
                    console.log('Contenu tableau restauré depuis la sauvegarde');
                }
            }
            
            // Réappliquer immédiatement les filtres de recherche sauvegardés
            setTimeout(() => {
                // Restaurer les valeurs de recherche dans les champs
                const searchInput = document.getElementById('search-input');
                const periodFilter = document.getElementById('period-filter');
                
                if (searchInput && lastSearchTerm) {
                    searchInput.value = lastSearchTerm;
                }
                if (periodFilter && lastPeriodFilter) {
                    periodFilter.value = lastPeriodFilter;
                }
                
                // Réappliquer les filtres
                applySearchAndFilter();
            }, 100);
            
            // Vérifier le contenu final
            setTimeout(() => {
                const cardsGrid = document.getElementById('cards-grid');
                const tableBody = document.getElementById('table-body');
                console.log('Final - Cartes:', cardsGrid?.innerHTML.length > 1000 ? 'OK' : 'PROBLÈME');
                console.log('Final - Tableau:', tableBody?.innerHTML.length > 200 ? 'OK' : 'PROBLÈME');
            }, 200);
        }

        // Variable pour éviter la double initialisation
        let viewToggleInitialized = false;

        // Écouteurs pour les boutons radio de vue
        function initializeViewToggle() {
            if (viewToggleInitialized) {
                console.log('Basculement de vue déjà initialisé, ignoré');
                return;
            }
            
            console.log('Initialisation du basculement de vue...');
            
            const cardsRadio = document.getElementById('view-cards');
            const tableRadio = document.getElementById('view-table');
            
            if (!cardsRadio || !tableRadio) {
                console.error('Boutons radio de vue non trouvés:', { cardsRadio, tableRadio });
                return;
            }
            
            // Supprimer les anciens événements s'ils existent
            cardsRadio.removeEventListener('change', handleCardsChange);
            tableRadio.removeEventListener('change', handleTableChange);
            
            // Ajouter les nouveaux événements
            cardsRadio.addEventListener('change', handleCardsChange);
            tableRadio.addEventListener('change', handleTableChange);
            
            // Marquer comme initialisé
            viewToggleInitialized = true;
            
            console.log('Basculement de vue initialisé');
        }

        // Gestionnaires d'événements séparés pour éviter les fuites
        function handleCardsChange(event) {
            if (event.target.checked) {
                console.log('Clic sur vue cartes');
                switchView('cards');
            }
        }

        function handleTableChange(event) {
            if (event.target.checked) {
                console.log('Clic sur vue tableau');
                switchView('table');
            }
        }

        // Fonction globale pour basculer manuellement (debug)
        window.switchToCards = () => switchView('cards');
        window.switchToTable = () => switchView('table');
        
        // Fonctions de debug améliorées
        window.forceSaveContent = forceSaveContent;
        window.forceRestoreCards = function() {
            const cardsGrid = document.getElementById('cards-grid');
            if (cardsGrid && cardsHTMLContent) {
                cardsGrid.innerHTML = cardsHTMLContent;
                console.log('Contenu cartes forcé:', cardsHTMLContent.length, 'caractères');
            } else {
                console.log('Pas de contenu cartes sauvegardé ou cardsGrid manquant');
            }
        };
        window.forceRestoreTable = function() {
            const tableBody = document.getElementById('table-body');
            if (tableBody && tableHTMLContent) {
                tableBody.innerHTML = tableHTMLContent;
                console.log('Contenu tableau forcé:', tableHTMLContent.length, 'caractères');
            } else {
                console.log('Pas de contenu tableau sauvegardé ou tableBody manquant');
            }
        };
        
        // Fonction de diagnostic
        window.debugViews = function() {
            console.log('=== DIAGNOSTIC DES VUES ===');
            const cardsContainer = document.getElementById('cards-container');
            const tableContainer = document.getElementById('table-container');
            const cardsGrid = document.getElementById('cards-grid');
            const tableBody = document.getElementById('table-body');
            
            console.log('Cards container:', cardsContainer ? 'OK' : 'MANQUANT');
            console.log('Table container:', tableContainer ? 'OK' : 'MANQUANT');
            console.log('Cards grid:', cardsGrid ? 'OK' : 'MANQUANT');
            console.log('Table body:', tableBody ? 'OK' : 'MANQUANT');
            
            if (cardsContainer) {
                console.log('Cards visible:', !cardsContainer.classList.contains('hidden'));
                console.log('Cards contenu DOM:', cardsContainer.innerHTML.length > 100 ? 'OK' : 'VIDE');
            }
            
            if (tableContainer) {
                console.log('Table visible:', !tableContainer.classList.contains('hidden'));
                console.log('Table contenu DOM:', tableContainer.innerHTML.length > 100 ? 'OK' : 'VIDE');
            }
            
            console.log('Cartes dans DOM:', document.querySelectorAll('.map-card').length);
            console.log('Lignes dans DOM:', document.querySelectorAll('#table-body tr').length);
            console.log('Données réelles:', window.realMapsData ? window.realMapsData.length : 'NON CHARGÉES');
            console.log('Contenu sauvegardé - Cartes:', cardsHTMLContent.length, 'caractères');
            console.log('Contenu sauvegardé - Tableau:', tableHTMLContent.length, 'caractères');
            console.log('Vue actuelle:', currentView);
        };
        
        // Exposer les données pour debug
        window.realMapsData = realMapsData;
        window.cardsHTMLContent = () => cardsHTMLContent;
        window.tableHTMLContent = () => tableHTMLContent;

        // === FIN GESTION DES VUES ===

        // === FONCTIONS DE RECHERCHE ET FILTRAGE ===

        // Variable pour stocker tous les éléments filtrables
        let allFilterableElements = [];
        let allCardsElements = [];  // Cache permanent pour les cartes
        let allTableRowsElements = [];  // Cache permanent pour les lignes

        // Fonction pour réinitialiser les caches d'éléments
        function resetElementsCache() {
            console.log('🔄 Réinitialisation des caches d\'éléments');
            allCardsElements = [];
            allTableRowsElements = [];
            allFilterableElements = [];
        }
        function initializeSearchAndFilter() {
            // Initialiser les événements avec nouvelle stratégie
            const searchInput = document.getElementById('search-input');
            const periodFilter = document.getElementById('period-filter');
            
            if (searchInput) {
                // Supprimer tous les anciens événements
                searchInput.removeEventListener('input', handleSearchInput);
                searchInput.removeEventListener('keypress', handleSearchKeypress);
                
                // Ajouter les nouveaux événements avec forçage immédiat
                searchInput.addEventListener('input', handleSearchInput);
                searchInput.addEventListener('keypress', handleSearchKeypress);
                
            } else {
                console.error('❌ search-input non trouvé dans le DOM');
            }
            
            if (periodFilter) {
                // Supprimer les anciens événements
                periodFilter.removeEventListener('change', handlePeriodChange);
                
                // Ajouter le nouvel événement avec forçage immédiat
                periodFilter.addEventListener('change', handlePeriodChange);
                
            } else {
                console.error('❌ period-filter non trouvé dans le DOM');
            }

            // Mettre à jour la liste des éléments filtrables
            updateFilterableElements();
        }

        // Version alternative ultra-agressive : recréation DOM complète
        function forceCompleteRecreation() {
            const cardsGrid = document.getElementById('cards-grid');
            const tableBody = document.getElementById('table-body');
            const cardsContainer = document.getElementById('cards-container');
            const tableContainer = document.getElementById('table-container');
            
            if (!cardsGrid || !tableBody) {
                return;
            }
            
            // Sauvegarder la vue actuelle
            const currentlyCardsVisible = !cardsContainer.classList.contains('hidden');
            
            // ÉTAPE 1: Supprimer complètement le contenu existant
            cardsGrid.innerHTML = '';
            tableBody.innerHTML = '';
            
            // ÉTAPE 2: Forcer un repaint vide
            requestAnimationFrame(() => {
                // ÉTAPE 3: Restaurer le contenu depuis les sauvegardes
                if (cardsHTMLContent && cardsHTMLContent.length > 100) {
                    cardsGrid.innerHTML = cardsHTMLContent;
                }
                
                if (tableHTMLContent && tableHTMLContent.length > 100) {
                    tableBody.innerHTML = tableHTMLContent;
                }
                
                // ÉTAPE 4: Forcer un autre repaint après restauration
                requestAnimationFrame(() => {
                    // ÉTAPE 5: Appliquer immédiatement les filtres
                    applySearchAndFilter();
                    
                    // ÉTAPE 6: Forcer le redessin
                    setTimeout(() => {
                        forceUIRedraw();
                    }, 50);
                });
            });
        }

        // Modifier les gestionnaires pour utiliser la recréation complète
        function handleSearchInput(e) {
            clearTimeout(window.searchTimeout);
            window.searchTimeout = setTimeout(() => {
                // Utiliser la recréation complète pour être sûr
                forceCompleteRecreation();
            }, 500); // Délai plus long pour éviter trop de recréations
        }

        function handleSearchKeypress(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                clearTimeout(window.searchTimeout);
                
                // Utiliser la recréation complète
                forceCompleteRecreation();
            }
        }

        function handlePeriodChange(e) {
            
            // Utiliser la recréation complète
            forceCompleteRecreation();
        }

        // Exposer les nouvelles fonctions pour debug
        window.forceUIRedraw = forceUIRedraw;
        window.forceCompleteRecreation = forceCompleteRecreation;

        // Nouvelle fonction pour forcer la mise à jour de la vue active
        function forceViewRefresh() {
            console.log('💪 === FORÇAGE MISE À JOUR VUE ACTIVE ===');
            
            const cardsContainer = document.getElementById('cards-container');
            const tableContainer = document.getElementById('table-container');
            
            if (!cardsContainer || !tableContainer) {
                console.error('Conteneurs non trouvés');
                return;
            }
            
            const currentlyCardsVisible = !cardsContainer.classList.contains('hidden');
            
            if (currentlyCardsVisible) {
                console.log('Forçage rafraîchissement vue cartes');
                // Forcer la re-génération de la vue cartes
                cardsContainer.style.display = 'none';
                setTimeout(() => {
                    cardsContainer.style.display = 'block';
                    
                    // Réappliquer les filtres après le rafraîchissement
                    setTimeout(() => {
                        applySearchAndFilter();
                    }, 10);
                }, 10);
            } else {
                console.log('Forçage rafraîchissement vue tableau');
                // Forcer la re-génération de la vue tableau
                tableContainer.style.display = 'none';
                setTimeout(() => {
                    tableContainer.style.display = 'block';
                    
                    // Réappliquer les filtres après le rafraîchissement
                    setTimeout(() => {
                        applySearchAndFilter();
                    }, 10);
                }, 10);
            }
        }

        // Fonction pour mettre à jour la liste des éléments filtrables
        function updateFilterableElements() {
            // Toujours récupérer les éléments depuis le DOM (pas de cache)
            if (currentView === 'cards') {
                allFilterableElements = Array.from(document.querySelectorAll('.map-card'));
            } else {
                allFilterableElements = Array.from(document.querySelectorAll('#table-body tr.table-row'));
            }
        }

        // Fonction de recherche
        function performSearch() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase().trim();

            updateFilterableElements();

            allFilterableElements.forEach(element => {
                let searchableText = '';
                
                if (currentView === 'cards') {
                    // Pour les cartes, chercher dans le titre et la description
                    const title = element.querySelector('.fr-card__title')?.textContent || '';
                    const desc = element.querySelector('.fr-card__desc')?.textContent || '';
                    searchableText = (title + ' ' + desc).toLowerCase();
                } else {
                    // Pour le tableau, chercher dans toutes les cellules
                    const cells = element.querySelectorAll('td');
                    searchableText = Array.from(cells).map(cell => cell.textContent || '').join(' ').toLowerCase();
                }

                if (searchTerm === '' || searchableText.includes(searchTerm)) {
                    element.style.display = '';
                } else {
                    element.style.display = 'none';
                }
            });

            updateVisibleCount();
        }

        // Fonction de filtrage par période
        function performFilter() {
            const selectedPeriod = document.getElementById('period-filter').value;
            console.log('Filtrage par période:', selectedPeriod);

            updateFilterableElements();

            allFilterableElements.forEach(element => {
                const dateStr = element.getAttribute('data-date');
                let showElement = true;

                if (selectedPeriod !== 'all' && dateStr && dateStr !== '' && dateStr !== 'undefined') {
                    const year = parseInt(dateStr);
                    
                    switch(selectedPeriod) {
                        case 'before-1800':
                            showElement = year < 1800;
                            break;
                        case '1800-1850':
                            showElement = year >= 1800 && year <= 1850;
                            break;
                        case '1850-1900':
                            showElement = year >= 1850 && year <= 1900;
                            break;
                        case '1900-1950':
                            showElement = year >= 1900 && year <= 1950;
                            break;
                        case 'after-1950':
                            showElement = year > 1950;
                            break;
                        default:
                            showElement = true;
                    }
                }

                if (showElement) {
                    element.style.display = '';
                } else {
                    element.style.display = 'none';
                }
            });

            updateVisibleCount();
        }

        // Variables pour sauvegarder l'état de la recherche
        let lastSearchTerm = '';
        let lastPeriodFilter = 'all';
        let isRefreshing = false; // Flag pour éviter les boucles infinies

        // Fonction pour forcer le rafraîchissement de l'affichage en simulant un changement de vue
        function forceRefreshDisplay() {
            // Éviter les boucles infinies
            if (isRefreshing) {
                console.log('⚠️ Rafraîchissement déjà en cours, ignoré');
                return;
            }
            
            console.log('🔄 === FORÇAGE RAFRAÎCHISSEMENT VIA SIMULATION CLICS ===');
            isRefreshing = true;
            
            const cardsRadio = document.getElementById('view-cards');
            const tableRadio = document.getElementById('view-table');
            
            if (!cardsRadio || !tableRadio) {
                console.warn('Boutons radio de vue non trouvés');
                isRefreshing = false;
                return;
            }
            
            const currentlyCards = cardsRadio.checked;
            
            // Simuler un SEUL changement de vue pour forcer le rafraîchissement
            if (currentlyCards) {
                console.log('Simulation: cartes -> tableau');
                tableRadio.click();
                
                setTimeout(() => {
                    console.log('Simulation: tableau -> cartes');
                    cardsRadio.click();
                    
                    setTimeout(() => {
                        isRefreshing = false;
                        console.log('Rafraîchissement terminé');
                    }, 100);
                }, 100);
                
            } else {
                console.log('Simulation: tableau -> cartes');
                cardsRadio.click();
                
                setTimeout(() => {
                    console.log('Simulation: cartes -> tableau');
                    tableRadio.click();
                    
                    setTimeout(() => {
                        isRefreshing = false;
                        console.log('Rafraîchissement terminé');
                    }, 100);
                }, 100);
            }
        }

        // Fonction pour réinitialiser la recherche
        function resetSearch() {
            const searchInput = document.getElementById('search-input');
            const periodFilter = document.getElementById('period-filter');
            
            if (searchInput) searchInput.value = '';
            if (periodFilter) periodFilter.value = 'all';
            
            lastSearchTerm = '';
            lastPeriodFilter = 'all';
            
            applySearchAndFilter();
        }

        // Fonction pour diagnostiquer les différences entre les vues
        function diagnoseViewDifferences() {
            console.log('🔍 === DIAGNOSTIC DES DIFFÉRENCES ENTRE VUES ===');
            
            const allCards = document.querySelectorAll('.map-card[data-ark-id]');
            const allRows = document.querySelectorAll('#table-body tr.table-row[data-ark-id]');
            
            console.log(`Cartes trouvées: ${allCards.length}`);
            console.log(`Lignes trouvées: ${allRows.length}`);
            
            // Récupérer les ARK IDs de chaque vue
            const cardsArkIds = Array.from(allCards).map(card => card.getAttribute('data-ark-id')).sort();
            const rowsArkIds = Array.from(allRows).map(row => row.getAttribute('data-ark-id')).sort();
            
            console.log('ARK IDs des cartes:', cardsArkIds);
            console.log('ARK IDs des lignes:', rowsArkIds);
            
            // Trouver les différences
            const cardsOnly = cardsArkIds.filter(id => !rowsArkIds.includes(id));
            const rowsOnly = rowsArkIds.filter(id => !cardsArkIds.includes(id));
            
            if (cardsOnly.length > 0) {
                console.warn('❌ ARK IDs présents uniquement dans les cartes:', cardsOnly);
            }
            if (rowsOnly.length > 0) {
                console.warn('❌ ARK IDs présents uniquement dans les lignes:', rowsOnly);
            }
            
            if (cardsOnly.length === 0 && rowsOnly.length === 0) {
                console.log('✅ Les ARK IDs sont identiques dans les deux vues');
            }
            
            return {
                cardsCount: allCards.length,
                rowsCount: allRows.length,
                cardsArkIds,
                rowsArkIds,
                cardsOnly,
                rowsOnly
            };
        }

        // Fonction pour combiner recherche et filtrage
        // Fonction unifiée pour déterminer si un élément correspond à la recherche
        function elementMatchesSearch(element, arkId, searchTerm, selectedPeriod) {
            let searchMatch = true;
            let periodMatch = true;
            
            // Test de recherche textuelle unifié
            if (searchTerm !== '') {
                let searchableText = '';
                
                // Pour les cartes : TOUT LE CONTENU TEXTUEL
                if (element.classList.contains('map-card')) {
                    const titleEl = element.querySelector('.fr-card__title');
                    const descEls = element.querySelectorAll('.fr-card__desc');
                    const detailEls = element.querySelectorAll('.fr-card__detail');
                    
                    const title = titleEl ? titleEl.textContent || '' : '';
                    const descs = Array.from(descEls).map(el => el.textContent || '').join(' ');
                    const details = Array.from(detailEls).map(el => el.textContent || '').join(' ');
                    
                    searchableText = (title + ' ' + descs + ' ' + details).toLowerCase();
                }
                // Pour les lignes : TOUTES LES CELLULES
                else if (element.classList.contains('table-row')) {
                    const cells = element.querySelectorAll('td');
                    searchableText = Array.from(cells).map(cell => cell.textContent || '').join(' ').toLowerCase();
                }
                
                // Ajouter l'ARK ID au texte recherchable pour les deux types
                searchableText += ' ' + arkId.toLowerCase();
                
                searchMatch = searchableText.includes(searchTerm);
            }
            
            // Test de filtrage par période unifié
            if (selectedPeriod !== 'all' && selectedPeriod !== '') {
                const dateStr = element.getAttribute('data-date');
                if (dateStr && dateStr !== '' && dateStr !== 'undefined') {
                    const year = parseInt(dateStr);
                    if (!isNaN(year)) {
                        switch(selectedPeriod) {
                            case 'before-1800':
                                periodMatch = year < 1800;
                                break;
                            case '1800-1850':
                                periodMatch = year >= 1800 && year <= 1850;
                                break;
                            case '1850-1900':
                                periodMatch = year >= 1850 && year <= 1900;
                                break;
                            case '1900-1950':
                                periodMatch = year >= 1900 && year <= 1950;
                                break;
                            case 'after-1950':
                                periodMatch = year > 1950;
                                break;
                            default:
                                periodMatch = true;
                        }
                    }
                }
            }
            
            return searchMatch && periodMatch;
        }

        function applySearchAndFilter() {
            const searchInput = document.getElementById('search-input');
            const periodFilter = document.getElementById('period-filter');
            
            const searchTerm = searchInput ? searchInput.value.toLowerCase().trim() : '';
            const selectedPeriod = periodFilter ? periodFilter.value : 'all';
            
            // Sauvegarder l'état de la recherche
            lastSearchTerm = searchTerm;
            lastPeriodFilter = selectedPeriod;

            // RÉCUPÉRER TOUS LES ÉLÉMENTS DES DEUX VUES AVEC SÉLECTEURS PRÉCIS
            const allCards = document.querySelectorAll('.map-card[data-ark-id]');
            const allRows = document.querySelectorAll('#table-body tr.table-row[data-ark-id]');

            // TRAITER LES CARTES avec la fonction unifiée
            let visibleCardsCount = 0;
            allCards.forEach((card, index) => {
                const arkId = card.getAttribute('data-ark-id');
                const shouldShow = elementMatchesSearch(card, arkId, searchTerm, selectedPeriod);
                
                if (shouldShow) {
                    card.style.display = '';
                    visibleCardsCount++;
                } else {
                    card.style.display = 'none';
                }
            });

            // TRAITER LES LIGNES DU TABLEAU avec la même fonction unifiée
            let visibleRowsCount = 0;
            allRows.forEach((row, index) => {
                const arkId = row.getAttribute('data-ark-id');
                const shouldShow = elementMatchesSearch(row, arkId, searchTerm, selectedPeriod);
                
                if (shouldShow) {
                    row.style.display = '';
                    visibleRowsCount++;
                } else {
                    row.style.display = 'none';
                }
            });
            
            // Vérifier la cohérence et corriger si nécessaire
            if (visibleCardsCount !== visibleRowsCount) {
                // Forcer l'harmonisation en cas d'incohérence
                allCards.forEach((card, i) => {
                    const arkId = card.getAttribute('data-ark-id');
                    const correspondingRow = document.querySelector(`#table-body tr.table-row[data-ark-id="${arkId}"]`);
                    
                    if (correspondingRow) {
                        const shouldShow = elementMatchesSearch(card, arkId, searchTerm, selectedPeriod);
                        card.style.display = shouldShow ? '' : 'none';
                        correspondingRow.style.display = shouldShow ? '' : 'none';
                    }
                });
            }
            
            // FORCER LE REDESSIN DE L'INTERFACE UTILISATEUR
            setTimeout(() => {
                forceUIRedraw();
            }, 10);
            
            updateVisibleCount();
        }

        // Nouvelle fonction pour forcer le redessin de l'interface utilisateur
        function forceUIRedraw() {
            const cardsContainer = document.getElementById('cards-container');
            const tableContainer = document.getElementById('table-container');
            const cardsGrid = document.getElementById('cards-grid');
            const tableBody = document.getElementById('table-body');
            
            if (!cardsContainer || !tableContainer) {
                return;
            }
            
            // Détecter la vue active
            const cardsActive = !cardsContainer.classList.contains('hidden');
            
            if (cardsActive) {
                // Technique 1: Forcer le reflow avec modification du style
                cardsGrid.style.transform = 'translateZ(0)';
                cardsContainer.style.display = 'none';
                
                // Forcer le reflow en lisant une propriété calculée
                const height = cardsContainer.offsetHeight;
                
                // Restaurer l'affichage
                cardsContainer.style.display = 'block';
                cardsGrid.style.transform = '';
                
                // Technique 2: Forcer un scroll pour déclencher le repaint
                setTimeout(() => {
                    const currentScroll = window.pageYOffset;
                    window.scrollTo(0, currentScroll + 1);
                    window.scrollTo(0, currentScroll);
                }, 5);
                
            } else {
                // Même technique pour le tableau
                tableBody.style.transform = 'translateZ(0)';
                tableContainer.style.display = 'none';
                
                const height = tableContainer.offsetHeight;
                
                tableContainer.style.display = 'block';
                tableBody.style.transform = '';
                
                setTimeout(() => {
                    const currentScroll = window.pageYOffset;
                    window.scrollTo(0, currentScroll + 1);
                    window.scrollTo(0, currentScroll);
                }, 5);
            }
            
            // Technique 3: Forcer le repaint avec requestAnimationFrame
            requestAnimationFrame(() => {
                // Technique 4: Modification temporaire des classes CSS
                const bodyElement = document.body;
                bodyElement.classList.add('force-repaint');
                
                setTimeout(() => {
                    bodyElement.classList.remove('force-repaint');
                }, 10);
            });
        }

        // Fonction pour mettre à jour le compteur d'éléments visibles
        function updateVisibleCount() {
            updateFilterableElements();
            const visibleElements = allFilterableElements.filter(el => el.style.display !== 'none');
        }

        // === FIN FONCTIONS DE RECHERCHE ET FILTRAGE ===

        // === FONCTIONS DE DEBUG ===
        
        // Fonction de test pour vérifier la recherche et le filtrage
        window.testSearchAndFilter = function() {
            console.log('🧪 === TEST RECHERCHE ET FILTRAGE ===');
            
            // Vérifier les éléments DOM
            const searchInput = document.getElementById('search-input');
            const periodFilter = document.getElementById('period-filter');
            
            console.log('Éléments DOM:');
            console.log('- search-input:', searchInput);
            console.log('- period-filter:', periodFilter);
            
            if (searchInput) {
                console.log('- search-input value:', searchInput.value);
                console.log('- search-input listeners:', getEventListeners ? getEventListeners(searchInput) : 'N/A');
            }
            
            if (periodFilter) {
                console.log('- period-filter value:', periodFilter.value);
                console.log('- period-filter options:', Array.from(periodFilter.options).map(o => o.value));
            }
            
            // Vérifier les éléments filtrables
            updateFilterableElements();
            
            // Test de recherche manuel
            console.log('Test de recherche avec "paris":');
            if (searchInput) {
                searchInput.value = 'paris';
                applySearchAndFilter();
            }
        };
        
        // Fonction pour forcer la réinitialisation
        window.forceReinitializeSearch = function() {
            console.log('🔧 === RÉINITIALISATION FORCÉE ===');
            resetElementsCache();
            initializeSearchAndFilter();
        };
        
        // Fonction pour réinitialiser l'affichage (montrer tous les éléments)
        window.resetDisplay = function() {
            console.log('🔄 === RÉINITIALISATION AFFICHAGE ===');
            
            // Remettre à vide les champs
            const searchInput = document.getElementById('search-input');
            const periodFilter = document.getElementById('period-filter');
            
            if (searchInput) searchInput.value = '';
            if (periodFilter) periodFilter.value = 'all';
            
            // Afficher tous les éléments
            const allCards = document.querySelectorAll('.map-card');
            const allRows = document.querySelectorAll('#table-body tr.table-row');
            
            allCards.forEach(card => card.style.display = '');
            allRows.forEach(row => row.style.display = '');
            
            console.log('Affichage réinitialisé - Cartes:', allCards.length, 'Lignes:', allRows.length);
        };
        
        // Fonction pour débugger l'état de l'affichage
        window.debugDisplay = function() {
            console.log('🔍 === DEBUG AFFICHAGE ===');
            
            const allCards = document.querySelectorAll('.map-card');
            const allRows = document.querySelectorAll('#table-body tr.table-row');
            
            console.log('Vue actuelle:', currentView);
            console.log('Total cartes dans DOM:', allCards.length);
            console.log('Total lignes dans DOM:', allRows.length);
            
            let visibleCards = 0, hiddenCards = 0;
            let visibleRows = 0, hiddenRows = 0;
            
            allCards.forEach(card => {
                if (card.style.display === 'none') hiddenCards++;
                else visibleCards++;
            });
            
            allRows.forEach(row => {
                if (row.style.display === 'none') hiddenRows++;
                else visibleRows++;
            });
            
            console.log('Cartes - Visibles:', visibleCards, 'Masquées:', hiddenCards);
            console.log('Lignes - Visibles:', visibleRows, 'Masquées:', hiddenRows);
            
            // État des champs
            const searchInput = document.getElementById('search-input');
            const periodFilter = document.getElementById('period-filter');
            console.log('Recherche:', searchInput ? searchInput.value : 'N/A');
            console.log('Période:', periodFilter ? periodFilter.value : 'N/A');
        };
        
        // Fonction pour forcer l'affichage de tous les éléments
        window.forceShowAll = function() {
            console.log('💪 === FORÇAGE AFFICHAGE TOUS LES ÉLÉMENTS ===');
            
            const allCards = document.querySelectorAll('.map-card');
            const allRows = document.querySelectorAll('#table-body tr.table-row');
            
            allCards.forEach((card, i) => {
                card.style.display = '';
                card.style.visibility = 'visible';
                card.style.opacity = '1';
                console.log(`Carte ${i} forcée visible`);
            });
            
            allRows.forEach((row, i) => {
                row.style.display = '';
                row.style.visibility = 'visible';
                row.style.opacity = '1';
                console.log(`Ligne ${i} forcée visible`);
            });
            
            console.log(`Tous les éléments forcés visibles: ${allCards.length} cartes, ${allRows.length} lignes`);
        };

        // Exposer la fonction de réinitialisation pour debug
        window.resetSearch = resetSearch;
        
        // Version alternative : regénération complète forcée
        function forceCompleteRefresh() {
            console.log('🚀 === REGÉNÉRATION COMPLÈTE FORCÉE ===');
            
            const cardsGrid = document.getElementById('cards-grid');
            const tableBody = document.getElementById('table-body');
            const cardsContainer = document.getElementById('cards-container');
            const tableContainer = document.getElementById('table-container');
            
            if (!cardsGrid || !tableBody) {
                console.error('Éléments de contenu non trouvés');
                return;
            }
            
            // Sauvegarder l'état de la vue actuelle
            const currentlyCardsVisible = !cardsContainer.classList.contains('hidden');
            
            console.log('Vue actuelle:', currentlyCardsVisible ? 'cartes' : 'tableau');
            
            // ÉTAPE 1: Restaurer le contenu complet depuis les sauvegardes
            if (cardsHTMLContent && cardsHTMLContent.length > 100) {
                console.log('Restauration contenu cartes depuis sauvegarde');
                cardsGrid.innerHTML = cardsHTMLContent;
            }
            
            if (tableHTMLContent && tableHTMLContent.length > 100) {
                console.log('Restauration contenu tableau depuis sauvegarde');
                tableBody.innerHTML = tableHTMLContent;
            }
            
            // ÉTAPE 2: Forcer l'affichage de tous les éléments
            const allCards = document.querySelectorAll('.map-card[data-ark-id]');
            const allRows = document.querySelectorAll('#table-body tr.table-row[data-ark-id]');
            
            allCards.forEach(card => {
                card.style.display = '';
                card.style.visibility = 'visible';
            });
            
            allRows.forEach(row => {
                row.style.display = '';
                row.style.visibility = 'visible';
            });
            
            console.log(`Contenu restauré: ${allCards.length} cartes, ${allRows.length} lignes`);
            
            // ÉTAPE 3: Réappliquer immédiatement les filtres
            setTimeout(() => {
                console.log('Réapplication des filtres après restauration');
                applySearchAndFilter();
                
                // ÉTAPE 4: Forcer le rafraîchissement de la vue active
                setTimeout(() => {
                    if (currentlyCardsVisible) {
                        cardsContainer.style.display = 'none';
                        setTimeout(() => {
                            cardsContainer.style.display = 'block';
                            cardsContainer.classList.remove('hidden');
                        }, 5);
                    } else {
                        tableContainer.style.display = 'none';
                        setTimeout(() => {
                            tableContainer.style.display = 'block';
                            tableContainer.classList.remove('hidden');
                        }, 5);
                    }
                }, 50);
            }, 10);
        }

        // Exposer la fonction de regénération complète
        window.forceCompleteRefresh = forceCompleteRefresh;
        
        // Exposer la fonction de diagnostic pour debug
        window.diagnoseViewDifferences = diagnoseViewDifferences;
        
        // Fonction pour débugger l'état de la recherche
        window.debugSearchState = function() {
            console.log('=== ÉTAT DE LA RECHERCHE ===');
            console.log('Vue actuelle:', currentView);
            console.log('Dernier terme recherché:', lastSearchTerm);
            console.log('Dernier filtre période:', lastPeriodFilter);
            
            const searchInput = document.getElementById('search-input');
            const periodFilter = document.getElementById('period-filter');
            console.log('Valeur actuelle recherche:', searchInput?.value);
            console.log('Valeur actuelle période:', periodFilter?.value);
            
            const allCards = document.querySelectorAll('.map-card');
            const allRows = document.querySelectorAll('#table-body tr.table-row');
            
            const visibleCards = Array.from(allCards).filter(card => card.style.display !== 'none').length;
            const visibleRows = Array.from(allRows).filter(row => row.style.display !== 'none').length;
            
            console.log(`Cartes: ${visibleCards}/${allCards.length} visibles`);
            console.log(`Lignes: ${visibleRows}/${allRows.length} visibles`);
        };
        
        // Fonction pour tester manuellement la recherche avec regénération complète
        window.testSearchWithCompleteRefresh = function(searchTerm = 'paris') {
            console.log('🧪 === TEST RECHERCHE AVEC REGÉNÉRATION COMPLÈTE ===');
            
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.value = searchTerm;
                console.log('Terme de recherche défini:', searchTerm);
                
                // Utiliser la regénération complète
                forceCompleteRefresh();
            } else {
                console.error('Champ de recherche non trouvé');
            }
        };

        // Fonction pour tester différentes stratégies de forçage
        window.testAllForcingStrategies = function(searchTerm = 'toul') {
            console.log('🧪 === TEST DE TOUTES LES STRATÉGIES DE FORÇAGE ===');
            
            const searchInput = document.getElementById('search-input');
            if (!searchInput) {
                console.error('Champ de recherche non trouvé');
                return;
            }
            
            searchInput.value = searchTerm;
            
            console.log('1. Test avec applySearchAndFilter + forceUIRedraw');
            applySearchAndFilter();
            setTimeout(() => forceUIRedraw(), 100);
            
            setTimeout(() => {
                console.log('2. Test avec forceCompleteRefresh');
                forceCompleteRefresh();
                
                setTimeout(() => {
                    console.log('3. Test avec forceCompleteRecreation');
                    forceCompleteRecreation();
                }, 2000);
            }, 2000);
        };

        // Fonction de diagnostic visuel
        window.checkVisualState = function() {
            console.log('👁️ === DIAGNOSTIC ÉTAT VISUEL ===');
            
            const allCards = document.querySelectorAll('.map-card[data-ark-id]');
            const cardsContainer = document.getElementById('cards-container');
            
            console.log('Vue active:', cardsContainer.classList.contains('hidden') ? 'tableau' : 'cartes');
            
            let hiddenByStyle = 0;
            let visibleByStyle = 0;
            
            allCards.forEach((card, i) => {
                const computedStyle = window.getComputedStyle(card);
                const isHidden = card.style.display === 'none' || computedStyle.display === 'none';
                
                if (isHidden) {
                    hiddenByStyle++;
                } else {
                    visibleByStyle++;
                }
                
                if (i < 3) {
                    console.log(`Carte ${i}:`, {
                        'data-ark-id': card.getAttribute('data-ark-id'),
                        'style.display': card.style.display,
                        'computed.display': computedStyle.display,
                        'visible': !isHidden
                    });
                }
            });
            
            console.log(`Résumé: ${visibleByStyle} visibles, ${hiddenByStyle} cachées`);
            
            return {
                totalCards: allCards.length,
                visibleByStyle,
                hiddenByStyle
            };
        };

        // Fonction pour vérifier la cohérence des sélections
        window.checkSelectionConsistency = function() {
            console.log('☑️ === DIAGNOSTIC COHÉRENCE SÉLECTIONS ===');
            
            const allCards = document.querySelectorAll('.map-card[data-ark-id]');
            const allRows = document.querySelectorAll('#table-body .table-row[data-ark-id]');
            
            let inconsistencies = 0;
            
            allCards.forEach(card => {
                const arkId = card.getAttribute('data-ark-id');
                const cardSelected = card.classList.contains('selected');
                const cardCheckbox = document.querySelector(`#cards-grid input[data-ark-id="${arkId}"]`);
                const cardCheckboxChecked = cardCheckbox ? cardCheckbox.checked : false;
                
                const correspondingRow = document.querySelector(`#table-body .table-row[data-ark-id="${arkId}"]`);
                const rowSelected = correspondingRow ? correspondingRow.classList.contains('selected') : false;
                const rowCheckbox = document.querySelector(`#table-body input[data-ark-id="${arkId}"]`);
                const rowCheckboxChecked = rowCheckbox ? rowCheckbox.checked : false;
                
                const inSelectedMaps = selectedMaps.has(arkId);
                
                const states = {
                    arkId,
                    cardSelected,
                    cardCheckboxChecked,
                    rowSelected,
                    rowCheckboxChecked,
                    inSelectedMaps
                };
                
                // Vérifier la cohérence
                const allStatesMatch = cardSelected === rowSelected && 
                                     cardSelected === cardCheckboxChecked && 
                                     cardSelected === rowCheckboxChecked && 
                                     cardSelected === inSelectedMaps;
                
                if (!allStatesMatch) {
                    console.warn(`❌ Incohérence ${arkId}:`, states);
                    inconsistencies++;
                    
                    // Auto-correction
                    const correctState = inSelectedMaps;
                    syncSelectionBetweenViews(arkId, correctState);
                } else if (inSelectedMaps) {
                    console.log(`✅ Cohérent ${arkId}: sélectionné partout`);
                }
            });
            
            console.log(`Total incohérences détectées et corrigées: ${inconsistencies}`);
            return inconsistencies;
        };

        // Fonction d'arrêt d'urgence pour stopper le clignottement
        window.stopRefreshing = function() {
            console.log('🛑 === ARRÊT D\'URGENCE DU RAFRAÎCHISSEMENT ===');
            isRefreshing = false;
            
            // Stopper tous les timeouts de recherche
            clearTimeout(window.searchTimeout);
            
            // Forcer l'affichage de tous les éléments
            const allCards = document.querySelectorAll('.map-card');
            const allRows = document.querySelectorAll('#table-body tr.table-row');
            
            allCards.forEach(card => card.style.display = '');
            allRows.forEach(row => row.style.display = '');
            
            console.log('Rafraîchissement arrêté, tous les éléments affichés');
        };
        
        // === FIN FONCTIONS DE DEBUG ===

        // Fonction pour vérifier l'état d'authentification
        async function checkAuthenticationStatus() {
            try {
                // Vérifier si l'utilisateur revient d'une authentification (token dans l'URL)
                const urlParams = new URLSearchParams(window.location.search);
                const token = urlParams.get('token') || urlParams.get('access_token');
                
                if (token) {
                    console.log('Token détecté dans l\'URL, configuration de l\'authentification...');
                    window.ptmAuth.setToken(token);
                    
                    // Nettoyer l'URL
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
                
                const isAuthenticated = await window.ptmAuth.checkAuthStatus();
                updateAuthenticationUI(isAuthenticated);
                
            } catch (error) {
                console.error('Erreur lors de la vérification de l\'authentification:', error);
                updateAuthenticationUI(false);
            }
        }

        // Fonction pour mettre à jour l'interface utilisateur selon l'état d'authentification
        function updateAuthenticationUI(isAuthenticated) {
            const authContainer = document.getElementById('auth-button-container');
            
            if (isAuthenticated && authContainer) {
                // Remplacer le bouton de connexion par les informations utilisateur
                window.ptmAuth.getUserProfile().then(userProfile => {
                    authContainer.innerHTML = `
                        <div class="user-menu-container">
                            <span class="fr-text--sm">
                                <span class="fr-icon-account-circle-line fr-mr-1w" aria-hidden="true"></span>
                                ${userProfile.first_name} ${userProfile.last_name}
                            </span>
                            <button class="fr-btn fr-btn--sm fr-btn--secondary fr-ml-2w" onclick="window.ptmAuth.logout()">
                                Déconnexion
                            </button>
                        </div>
                    `;
                });
            }
        }

        // Fonction pour initialiser l'affichage de version
        function initializeVersionDisplay() {
            const versionDisplay = document.getElementById('version-display');
            
            if (!versionDisplay) return;
            
            // Attendre que les informations de version soient disponibles
            function updateVersionInfo() {
                if (window.APP_VERSION) {
                    const version = window.APP_VERSION;
                    versionDisplay.textContent = version.shortDisplayVersion;
                } else {
                    // Réessayer dans 100ms si les informations ne sont pas encore disponibles
                    setTimeout(updateVersionInfo, 100);
                }
            }
            
            updateVersionInfo();
        }
    </script>

    <!-- Matomo -->
    <script>
    var _paq = window._paq = window._paq || [];
    /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
    _paq.push(['trackPageView']);
    _paq.push(['enableLinkTracking']);
    (function() {
        var u="//ptm.huma-num.fr/matomo/";
        _paq.push(['setTrackerUrl', u+'matomo.php']);
        _paq.push(['setSiteId', '23']);
        var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
        g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
    })();
    </script>
    <!-- End Matomo Code -->

  </body>
</html>