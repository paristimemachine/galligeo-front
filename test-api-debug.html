<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test - API PTM Auth Debug</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 2rem; }
        .test-section { margin: 2rem 0; padding: 1rem; border: 1px solid #ddd; }
        .log { background: #f5f5f5; padding: 1rem; font-family: monospace; }
        button { margin: 0.5rem; padding: 0.5rem 1rem; }
    </style>
</head>
<body>
    <h1>Test API PTM Auth - Debug</h1>
    
    <div class="test-section">
        <h2>Configuration actuelle</h2>
        <p><strong>Base URL:</strong> <span id="base-url"></span></p>
        <p><strong>Token présent:</strong> <span id="token-status"></span></p>
    </div>

    <div class="test-section">
        <h2>Tests API</h2>
        <button onclick="testAuth()">Test Authentification</button>
        <button onclick="testCartoqueteAPI()">Test API Cartoquete</button>
        <button onclick="testProfileAPI()">Test API Profil</button>
        <button onclick="clearLog()">Effacer logs</button>
    </div>

    <div class="test-section">
        <h2>URLs de test direct</h2>
        <button onclick="testDirectURL()">Test URL directe</button>
        <input type="text" id="test-url" value="https://api.ptm.huma-num.fr/auth/app/cartoquete/data" style="width: 400px;">
    </div>

    <div class="test-section">
        <h2>Logs</h2>
        <div id="log-output" class="log"></div>
    </div>

    <script src="js/ptm-auth.js"></script>
    <script>
        function log(message) {
            const logOutput = document.getElementById('log-output');
            const timestamp = new Date().toLocaleTimeString();
            logOutput.innerHTML += `[${timestamp}] ${message}\n`;
            logOutput.scrollTop = logOutput.scrollHeight;
            console.log(`[TEST] ${message}`);
        }

        function clearLog() {
            document.getElementById('log-output').innerHTML = '';
        }

        function updateStatus() {
            document.getElementById('base-url').textContent = window.ptmAuth.baseUrl;
            document.getElementById('token-status').textContent = window.ptmAuth.isAuthenticated() ? 'Oui' : 'Non';
        }

        async function testAuth() {
            log('=== TEST AUTHENTIFICATION ===');
            try {
                const isAuth = await window.ptmAuth.checkAuthStatus();
                log(`Authentifié: ${isAuth}`);
                
                if (isAuth) {
                    const profile = await window.ptmAuth.getUserProfile();
                    log(`Profil: ${JSON.stringify(profile, null, 2)}`);
                }
            } catch (error) {
                log(`ERREUR Auth: ${error.message}`);
            }
        }

        async function testCartoqueteAPI() {
            log('=== TEST API CARTOQUETE ===');
            try {
                // URL complète qui sera appelée
                const fullUrl = `${window.ptmAuth.baseUrl}/auth/app/cartoquete/data`;
                log(`URL complète: ${fullUrl}`);
                
                const data = await window.ptmAuth.getCartoqueteData();
                log(`Données Cartoquete: ${JSON.stringify(data, null, 2)}`);
            } catch (error) {
                log(`ERREUR Cartoquete: ${error.message}`);
            }
        }

        async function testProfileAPI() {
            log('=== TEST API PROFIL ===');
            try {
                const fullUrl = `${window.ptmAuth.baseUrl}/auth/profile`;
                log(`URL complète: ${fullUrl}`);
                
                const profile = await window.ptmAuth.getUserProfile();
                log(`Profil: ${JSON.stringify(profile, null, 2)}`);
            } catch (error) {
                log(`ERREUR Profil: ${error.message}`);
            }
        }

        async function testDirectURL() {
            log('=== TEST URL DIRECTE ===');
            const url = document.getElementById('test-url').value;
            const token = window.ptmAuth.getToken();
            
            if (!token) {
                log('ERREUR: Pas de token disponible');
                return;
            }

            try {
                log(`URL: ${url}`);
                log(`Token: ${token.substring(0, 20)}...`);
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                log(`Status: ${response.status} ${response.statusText}`);
                
                if (response.ok) {
                    const data = await response.json();
                    log(`Données: ${JSON.stringify(data, null, 2)}`);
                } else {
                    const errorText = await response.text();
                    log(`Erreur: ${errorText}`);
                }
            } catch (error) {
                log(`ERREUR Fetch: ${error.message}`);
            }
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', () => {
            // Vérifier le token dans l'URL
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token') || urlParams.get('access_token');
            
            if (token) {
                log(`Token détecté dans l'URL: ${token.substring(0, 20)}...`);
                window.ptmAuth.setToken(token);
                window.history.replaceState({}, document.title, window.location.pathname);
            }
            
            updateStatus();
            log('Page de test chargée');
        });
    </script>
</body>
</html>
